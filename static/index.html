<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CricSmart - Cricket Scoring Application</title>
    <link rel="stylesheet" href="cricsmart-logo.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #01147C 0%, #2a4d8f 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }
        .header {
            margin-bottom: 40px;
        }
        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .header h2 {
            font-size: 1.5em;
            color: #a8c7ff;
            margin-bottom: 30px;
        }
        .status-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .status-card h3 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 1.8em;
        }
        .button {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .button:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.2);
        }
        .result {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
            border: 1px solid rgba(255,255,255,0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        .result pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #a8c7ff;
            font-size: 14px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .feature-card {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .feature-card h4 {
            color: #4CAF50;
            margin-bottom: 10px;
        }
    </style>
      position: absolute;
      font-size: 0.5em;
      animation: starPulse 1.5s ease-in-out infinite alternate;
      text-shadow: 0 0 6px rgba(255, 215, 0, 0.8);
    }
    
    .trophy-star:nth-child(1) {
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      animation-delay: 0s;
    }
    
    .trophy-star:nth-child(2) {
      top: 50%;
      right: -12px;
      transform: translateY(-50%);
      animation-delay: 0.5s;
    }
    
    .trophy-star:nth-child(3) {
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      animation-delay: 1s;
    }
    
    .trophy-star:nth-child(4) {
      top: 50%;
      left: -12px;
      transform: translateY(-50%);
      animation-delay: 1.5s;
    }
    
    @keyframes starsOrbitHorizontal {
      0% { transform: translate(-50%, -50%) rotateX(0deg); }
      100% { transform: translate(-50%, -50%) rotateX(360deg); }
    }
    
    @keyframes starPulse {
      0% { transform: scale(1); opacity: 0.7; }
      100% { transform: scale(1.3); opacity: 1; }
    }
    
    .trophy-gold {
      background: linear-gradient(45deg, #FFD700, #FFA500, #FFD700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 2px 4px rgba(255, 215, 0, 0.5));
    }
    
    /* 3D Medal Animations for Man of the Match */
    .medal-3d {
      display: inline-block;
      font-size: 1.2em;
      animation: medal3D 2.5s ease-in-out infinite;
      text-shadow: 0 2px 4px rgba(255, 215, 0, 0.4);
      transform-style: preserve-3d;
      background: linear-gradient(135deg, #2c5aa0, #1e3c72, #2c5aa0);
      border-radius: 50%;
      padding: 4px 8px;
      margin-right: 8px;
      box-shadow: 0 4px 8px rgba(30, 60, 114, 0.3), inset 0 2px 4px rgba(255, 255, 255, 0.1);
    }
    
    @keyframes medal3D {
      0% { transform: rotateY(0deg) rotateX(0deg) scale(1); text-shadow: 0 2px 4px rgba(255, 215, 0, 0.4); }
      20% { transform: rotateY(72deg) rotateX(10deg) scale(1.05); text-shadow: 0 3px 6px rgba(255, 215, 0, 0.6); }
      40% { transform: rotateY(144deg) rotateX(-10deg) scale(1.1); text-shadow: 0 4px 8px rgba(255, 215, 0, 0.8); }
      60% { transform: rotateY(216deg) rotateX(10deg) scale(1.05); text-shadow: 0 3px 6px rgba(255, 215, 0, 0.6); }
      80% { transform: rotateY(288deg) rotateX(-10deg) scale(1.02); text-shadow: 0 2px 4px rgba(255, 215, 0, 0.5); }
      100% { transform: rotateY(360deg) rotateX(0deg) scale(1); text-shadow: 0 2px 4px rgba(255, 215, 0, 0.4); }
    }
    
    .medal-gold {
      background: linear-gradient(135deg, #FFD700, #FFA500, #FF8C00, #FFD700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 3px 6px rgba(255, 215, 0, 0.6));
    }
    
    @keyframes fire {
      0%, 100% { 
        transform: scale(1); 
        opacity: 0.6;
      }
      50% { 
        transform: scale(1.1); 
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <!-- Initial Landing Section -->
  <div id="initialSection" style="text-align: center; padding: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
    <!-- Logo Section -->
    <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px;">
      <div style="width: 60px; height: 60px; background: #01147C; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(1, 20, 124, 0.3), 0 0 20px rgba(255, 100, 0, 0.6); overflow: hidden; font-size: 30px; position: relative;">
        <div style="position: absolute; width: 100%; height: 100%; background: radial-gradient(circle, rgba(255,100,0,0.3) 0%, rgba(255,50,0,0.1) 50%, transparent 70%); animation: fire 2s ease-in-out infinite;"></div>
        <span style="position: relative; z-index: 2;">üèè</span>
      </div>
      <h1 style="font-size: 3em; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">CricSmart</h1>
    </div>
    <p style="font-size: 1.2em; margin-bottom: 40px; opacity: 0.9;">Intelligent Cricket Scoring Platform</p>
    
    <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
      <h2 style="margin-bottom: 20px;">Welcome to CricSmart!</h2>
      <p style="margin-bottom: 30px;">Create a new match or load an existing one to get started.</p>
      
      <button onclick="createNewMatchFromInitial()" style="background: #28a745; color: white; padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: bold; margin: 10px; transition: all 0.3s ease;">
        üÜï Create New Match
      </button>
      
      <button onclick="showMatchesList()" style="background: #17a2b8; color: white; padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: bold; margin: 10px; transition: all 0.3s ease;">
        üìã Load Existing Match
      </button>
    </div>
    
    <div style="margin-top: 40px; opacity: 0.7; font-size: 0.9em;">
      <p>Match data stays in-memory for this session</p>
    </div>
  </div>

  <!-- Main Application Section (Initially Hidden) -->
  <div id="mainAppSection" style="display: none;">
    <!-- App Header with Logo -->
    <div style="display: flex; align-items: center; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 12px;">
      <div style="display: flex; align-items: center; gap: 12px; margin-right: auto;">
        <div style="width: 40px; height: 40px; background: #01147C; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(1, 20, 124, 0.3), 0 0 15px rgba(255, 100, 0, 0.6); overflow: hidden; font-size: 20px; position: relative;">
          <div style="position: absolute; width: 100%; height: 100%; background: radial-gradient(circle, rgba(255,100,0,0.3) 0%, rgba(255,50,0,0.1) 50%, transparent 70%); animation: fire 2s ease-in-out infinite;"></div>
          <span style="position: relative; z-index: 2;">üèè</span>
        </div>
        <div style="font-size: 24px; font-weight: 700; color: white;">CricSmart</div>
      </div>
    </div>
    
    <h1 id="mainTitle" style="display: none;">CricSmart (Multi-Match)</h1>
    
    <div id="matchHeader" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
        <div>
          <strong>Match ID:</strong> <span id="currentMatchId" style="font-family: monospace; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px;"></span>
          <br>
          <strong>Match Name:</strong> <span id="currentMatchName"></span>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
          <button onclick="shareMatch()" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üîó Share Match</button>
          <button onclick="showMatchesList()" style="background: #17a2b8; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;">üìã All Matches</button>
          <button onclick="goToHome()" style="background: #ffc107; color: black; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üè† Home</button>
        </div>
      </div>
    </div>
    
    <div class="muted">CricSmart - Multi-match platform with shareable live matches. Match data stays in-memory for this session.</div>
    <hr/>

  <div id="tabs" style="display:none;margin-bottom:20px">
    <button class="tab active" onclick="showTab('matchSettings')" style="flex:1;min-width:80px;">Match Settings</button>
    <button class="tab" onclick="showTab('match')" style="flex:1;min-width:60px;">Match</button>
    <button class="tab" onclick="showTab('scoreboard')" style="flex:1;min-width:80px;">Scoreboard</button>
    <button class="tab" onclick="showTab('summary')" style="flex:1;min-width:70px;">Summary</button>
  </div>

  <div id="matchSettingsTab" class="tabContent" style="display: none;">
    <h2>Match Configuration</h2>
    <div style="margin-top:15px">
        <label>Match Name (Optional): </label>
        <input id="matchName" type="text" placeholder="e.g., Championship Final, Friendly Match" style="width:100%;max-width:300px;" />
        <div style="font-size:12px;color:#666;margin-top:3px">Leave blank to auto-generate: "Team A vs Team B - Date Time"</div>
      </div>
      <div style="margin-top:15px">
        <label>Overs: </label>
        <input id="overs" type="number" min="1" value="5" style="width:90px;max-width:150px;" />
      </div>
      <div style="margin-top:10px">
        <label>Players per Team: </label>
        <input id="playersPerTeam" type="number" min="2" max="11" value="11" style="width:90px;max-width:150px;" />
      </div>
    <div style="margin-top:20px">
      <button onclick="showPlayerSetup()" style="background:#28a745;color:white;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-weight:bold;">Next: Add Players ‚Üí</button>
    </div>
    
    <div id="playerSetupSection" style="display:none;margin-top:30px">
      <hr style="margin:20px 0;border:1px solid #ddd">
      <h3>Team Setup</h3>
      <div style="display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap;">
        <div style="flex:1;min-width:280px;">
          <h4>Team A</h4>
          <input type="text" id="teamAName" placeholder="Team A Name" value="Team A" style="width:100%;margin-bottom:10px;padding:8px">
          <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap">
            <input type="text" id="teamAPlayerName" placeholder="Player Name" style="flex:1;min-width:120px;padding:8px">
            <select id="teamAPlayerRole" style="padding:8px;min-width:100px">
              <option value="batsman">Batsman</option>
              <option value="bowler">Bowler</option>
              <option value="all-rounder">All-rounder</option>
              <option value="wicket-keeper">Wicket Keeper</option>
            </select>
          </div>
          <button onclick="addPlayer('A')" class="add-player-btn">Add Player</button>
          <div id="teamAList" style="margin-top:10px"></div>
        </div>
        <div style="flex:1;min-width:280px;">
          <h4>Team B</h4>
          <input type="text" id="teamBName" placeholder="Team B Name" value="Team B" style="width:100%;margin-bottom:10px;padding:8px">
          <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap">
            <input type="text" id="teamBPlayerName" placeholder="Player Name" style="flex:1;min-width:120px;padding:8px">
            <select id="teamBPlayerRole" style="padding:8px;min-width:100px">
              <option value="batsman">Batsman</option>
              <option value="bowler">Bowler</option>
              <option value="all-rounder">All-rounder</option>
              <option value="wicket-keeper">Wicket Keeper</option>
            </select>
          </div>
          <button onclick="addPlayer('B')" class="add-player-btn">Add Player</button>
          <div id="teamBList" style="margin-top:10px"></div>
        </div>
      </div>
      
      <div id="setupError" class="error" style="margin-top:10px"></div>
      <div style="margin-top:15px">
        <label>Batting First: </label>
        <select id="batFirst" disabled style="margin-right:10px">
          <option value="">Select Team</option>
        </select>
        <span id="battingFirstHelp" style="font-size:12px;color:#666">Add at least 2 players to each team to enable</span>
      </div>
      <div style="margin-top:15px">
        <button onclick="startMatch()" style="background:#007bff;color:white;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-weight:bold;min-height:44px;flex:1;">Start Match</button>
        <button onclick="resetAll()" style="background:#6c757d;color:white;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;min-height:44px;flex:1;">Reset</button>
        <button onclick="backToConfig()" style="background:#ffc107;color:black;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;min-height:44px;flex:1;">‚Üê Back to Config</button>
      </div>
    </div>
  </div>

  <div id="matchTab" class="tabContent" style="display:none">
    <div class="score" id="scoreLine"></div>
    <div class="muted" id="playersLine" style="margin-top:6px"></div>
    <div id="targetLine" class="muted" style="margin-top:6px;font-weight:bold"></div>
    <div id="matchWinnerLine" class="muted" style="margin-top:6px;font-weight:bold;color:#28a745;display:none;"></div>

    <div class="row" style="margin-top:14px">
      <div class="card">
        <h2>Scoring</h2>
        <div class="controls">
          <button onclick="scoreRuns(0)">0</button>
          <button onclick="scoreRuns(1)">1</button>
          <button onclick="scoreRuns(2)">2</button>
          <button onclick="scoreRuns(3)">3</button>
          <button onclick="scoreRuns(4)">4</button>
          <button onclick="scoreRuns(6)">6</button>
        </div>
        <div class="controls" style="margin-top:8px">
          <button onclick="wicket()">Wicket</button>
          <button onclick="extra('wide')">Wide</button>
          <button onclick="extra('no-ball')">No-ball</button>
          <button onclick="extra('dead-ball')">Dead Ball</button>
          <button onclick="extra('bye')">Bye</button>
          <button onclick="extra('leg-bye')">Leg-bye</button>
        </div>
      </div>

      <div class="card">
        <h2>Controls</h2>
        <div class="controls">
          <button onclick="changeStrike()">Change Strike</button>
          <button onclick="changeBowler()">Change Bowler</button>
          <button onclick="selectOpeners()">Re-Select Openers</button>
        </div>
        <div class="controls" style="margin-top:8px">
          <button onclick="addPlayerLive(\'batting\')">Add Batting Player</button>
          <button onclick="addPlayerLive(\'bowling\')">Add Bowling Player</button>
        </div>
        <div id="switchInningsDiv" class="controls" style="margin-top:8px;display:none">
          <button onclick="showSwitchInningsPopup()" style="background:#ff6b6b;color:white;padding:8px 16px;border:none;border-radius:5px;cursor:pointer;font-weight:bold;">Switch Innings</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h2>Batsmen Scores</h2>
      <div id="batsmenScores"></div>
    </div>

    <div class="card" style="margin-top:14px">
      <h2>Ball by Ball</h2>
      <div id="ballByBall" style="max-height:200px;overflow-y:auto;"></div>
    </div>

    <div id="liveError" class="error" style="margin-top:10px"></div>
  </div>

  <div id="scoreboardTab" class="tabContent" style="display:none;">
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
        <h2 style="margin: 0; flex: 1;">Team Scoreboard</h2>
        <button id="downloadPDFBtn" onclick="downloadScoreboardPDF()" disabled style="background: #ccc; color: #666; border: none; padding: 10px 20px; border-radius: 5px; cursor: not-allowed; font-size: 14px; min-height: 44px;">üìÑ Download PDF (Match Not Started)</button>
      </div>
      <div id="scoreboardWinnerLine" class="muted" style="margin-bottom:15px;font-weight:bold;color:#28a745;display:none;"></div>
      <div id="teamScoreboard" style="overflow-x: auto; -webkit-overflow-scrolling: touch;"></div>
    </div>
  </div>

  <div id="summaryTab" class="tabContent" style="display:none">
    <div class="card">
      <h2>Match Summary</h2>
      <div id="matchSummary"></div>
    </div>
    <div class="card" style="margin-top:14px">
      <h2>Ball by Ball Details</h2>
      
      <!-- Innings Sub-Tabs -->
      <div style="display:flex;border-bottom:2px solid #ddd;margin-bottom:15px">
        <button id="summaryInnings1Tab" onclick="showSummaryInningsTab(1)" style="padding:8px 16px;border:none;background:#2196f3;color:white;cursor:pointer;border-radius:5px 5px 0 0;font-weight:bold">1st Innings</button>
        <button id="summaryInnings2Tab" onclick="showSummaryInningsTab(2)" style="padding:8px 16px;border:none;background:#f0f0f0;color:black;cursor:pointer;border-radius:5px 5px 0 0;font-weight:bold;margin-left:5px">2nd Innings</button>
        <button id="summaryCombinedTab" onclick="showSummaryInningsTab(0)" style="padding:8px 16px;border:none;background:#f0f0f0;color:black;cursor:pointer;border-radius:5px 5px 0 0;font-weight:bold;margin-left:5px">Combined</button>
      </div>
      
      <!-- 1st Innings Content -->
      <div id="summaryInnings1Content" style="display:block">
        <div id="summaryBallByBall1st" style="max-height:400px;overflow-y:auto;"></div>
      </div>
      
      <!-- 2nd Innings Content -->
      <div id="summaryInnings2Content" style="display:none">
        <div id="summaryBallByBall2nd" style="max-height:400px;overflow-y:auto;"></div>
      </div>
      
      <!-- Combined Content -->
      <div id="summaryCombinedContent" style="display:none">
        <div id="summaryBallByBallCombined" style="max-height:400px;overflow-y:auto;"></div>
      </div>
    </div>
  </div>

  <!-- Donation QR Code Section -->
  <div id="donationSection" style="position: fixed; bottom: 20px; right: 20px; background: rgba(255,255,255,0.95); color: #333; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); max-width: 250px; z-index: 1000;">
    <div style="text-align: center;">
      <h4 style="margin: 0 0 10px 0; color: #01147C; font-size: 14px;">Support CricSmart ‚ù§Ô∏è</h4>
      <div style="width: 100px; height: 100px; background: #f0f0f0; margin: 0 auto 10px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #666; border: 2px dashed #01147C;">
        <div style="text-align: center;">
          <div style="font-size: 30px;">üí∞</div>
          <div>UPI</div>
        </div>
      </div>
      <p style="margin: 0; font-size: 11px; line-height: 1.3;">If you like CricSmart, kindly donate (from ‚Çπ10 onwards) for further improvements.</p>
      <div style="margin-top: 10px;">
        <button onclick="copyUPI()" style="background: #01147C; color: white; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin: 5px; font-weight: bold;">
          üì± Copy UPI ID
        </button>
        <button onclick="openUPI()" style="background: #28a745; color: white; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin: 5px; font-weight: bold;">
          üí∏ Pay Now
        </button>
      </div>
      <button onclick="toggleDonation()" style="background: #01147C; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-top: 8px;">√ó</button>
    </div>
  </div>

  <!-- Custom Alert Modal -->
  <div id="customAlert" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 350px; margin: 20px; text-align: center;">
      <div id="alertIcon" style="font-size: 40px; margin-bottom: 15px;"></div>
      <div id="alertMessage" style="font-size: 14px; line-height: 1.5; margin-bottom: 20px; color: #333;"></div>
      <button onclick="closeCustomAlert()" style="background: #01147C; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">
        OK
      </button>
    </div>
  </div>

  <script>
let teamsList = ["Team A", "Team B"];

// Toggle donation section
function toggleDonation() {
  const donationSection = document.getElementById('donationSection');
  donationSection.style.display = donationSection.style.display === 'none' ? 'block' : 'none';
}

// Custom alert functions
function showCustomAlert(message, icon) {
  const alertModal = document.getElementById('customAlert');
  const alertMessage = document.getElementById('alertMessage');
  const alertIcon = document.getElementById('alertIcon');
  
  alertMessage.innerHTML = message.replace(/\\n/g, '<br>');
  alertIcon.textContent = icon || '‚úÖ';
  alertModal.style.display = 'flex';
}

function closeCustomAlert() {
  const alertModal = document.getElementById('customAlert');
  alertModal.style.display = 'none';
}

// Copy UPI ID to clipboard
function copyUPI() {
  const upiId = 'vasudevant25@okicici';
  navigator.clipboard.writeText(upiId).then(function() {
    // Show success message with custom alert
    showCustomAlert(
      'UPI ID copied to clipboard!<br><br><strong>' + upiId + '</strong><br><br>You can now paste this in any UPI app to donate.',
      'üì±'
    );
  }).catch(function(err) {
    // Fallback for older browsers
    const textArea = document.createElement('textarea');
    textArea.value = upiId;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    showCustomAlert(
      'UPI ID copied!<br><br><strong>' + upiId + '</strong>',
      'üì±'
    );
  });
}

// Open UPI payment app
function openUPI() {
  const upiId = 'vasudevant25@okicici';
  const upiUrl = 'upi://pay?pa=' + encodeURIComponent(upiId) + '&pn=CricSmart&am=10';
  
  // Try to open UPI app
  window.open(upiUrl, '_blank');
  
  // Show instructions with custom alert
  setTimeout(function() {
    showCustomAlert(
      'Opening UPI app...<br><br>If it doesn&#39;t open automatically:<br><br>1. Copy UPI ID: <strong>' + upiId + '</strong><br>2. Open any UPI app (PayTM, PhonePe, Google Pay, etc.)<br>3. Paste and send minimum ‚Çπ10',
      'üí∏'
    );
  }, 1000);
}

// Victory popup donation functions
function copyUPIFromVictory() {
  const upiId = 'vasudevant25@okicici';
  navigator.clipboard.writeText(upiId).then(function() {
    showCustomAlert(
      'üéâ Thank you for your support!<br><br>UPI ID copied: <strong>' + upiId + '</strong><br><br>Your donation helps us improve CricSmart!',
      'üì±'
    );
  }).catch(function(err) {
    // Fallback for older browsers
    const textArea = document.createElement('textarea');
    textArea.value = upiId;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    showCustomAlert(
      'üéâ Thank you for your support!<br><br>UPI ID copied: <strong>' + upiId + '</strong>',
      'üì±'
    );
  });
}

function openUPIFromVictory() {
  const upiId = 'vasudevant25@okicici';
  const upiUrl = 'upi://pay?pa=' + encodeURIComponent(upiId) + '&pn=CricSmart&am=10';
  
  // Try to open UPI app
  window.open(upiUrl, '_blank');
  
  // Show success message
  setTimeout(function() {
    showCustomAlert(
      'üéâ Thank you for supporting CricSmart!<br><br>If payment doesn&#39;t start automatically:<br><br>1. Copy UPI ID: <strong>' + upiId + '</strong><br>2. Open any UPI app and send ‚Çπ10<br><br>Your support means a lot to us!',
      'üí∏'
    );
  }, 1000);
}

// Generate QR code when page loads
window.addEventListener('load', function() {
  // QR code is now handled by buttons
});

// Custom encoding/decoding for view-only parameter
function encodeViewParam() {
  try {
    // Simple encoding that looks like random characters
    const timestamp = Date.now().toString();
    const prefix = 'vo_'; // Shorter prefix
    const combined = prefix + timestamp;
    const encoded = btoa(combined).replace(/=/g, '_').substring(0, 16); // Longer substring
    console.log('Encoding test - prefix:', prefix);
    console.log('Encoding test - timestamp:', timestamp);
    console.log('Encoding test - combined:', combined);
    console.log('Encoding test - encoded:', encoded);
    return encoded;
  } catch (e) {
    console.error('Encoding error:', e);
    return 'fallback_view_only';
  }
}

function decodeViewParam(encoded) {
  try {
    // Decode and check if it's a valid view-only parameter
    const decoded = atob(encoded.replace(/_/g, '='));
    console.log('Decoding test - encoded:', encoded);
    console.log('Decoding test - decoded:', decoded);
    return decoded.startsWith('vo_'); // Match shorter prefix
  } catch (e) {
    console.error('Decoding error:', e);
    return false;
  }
}

// Check if this is a view-only session
const urlParams = new URLSearchParams(window.location.search);
const encodedRole = urlParams.get('Role');
const isViewOnly = encodedRole && encodedRole.length > 0 ? decodeViewParam(encodedRole) : false;
console.log('View-only detection - encodedRole:', encodedRole, 'isViewOnly:', isViewOnly);

// Add event listeners to update teamsList when team names change
document.addEventListener('DOMContentLoaded', function() {
  // Test if JavaScript is working
  console.log('JavaScript loaded successfully - PAGE LOAD TIMESTAMP:', new Date().toISOString());
  
  // Check if there's a match_id in URL
  const urlParams = new URLSearchParams(window.location.search);
  const matchId = urlParams.get('match_id');
  
  if (matchId) {
    console.log('Found match_id in URL, showing main app:', matchId);
    // Hide initial section and show main app
    document.getElementById('initialSection').style.display = 'none';
    document.getElementById('mainAppSection').style.display = 'block';
    // Load the match
    loadMatch(matchId);
  } else {
    console.log('No match_id found, showing initial section');
    // Show initial section, hide main app
    document.getElementById('initialSection').style.display = 'flex';
    document.getElementById('mainAppSection').style.display = 'none';
  }
  
  // Apply view-only restrictions after a short delay to ensure all elements are loaded
  if (isViewOnly) {
    console.log('About to apply view-only restrictions because isViewOnly is true');
    setTimeout(() => {
      console.log('Applying view-only restrictions...');
      applyViewOnlyRestrictions();
    }, 100);
    
    // Also apply stable tab layout immediately to prevent collapse
    setTimeout(() => {
      const tabsContainer = document.getElementById('tabs');
      if (tabsContainer) {
        // Force stable layout immediately
        tabsContainer.style.cssText = 
          'display: flex !important;' +
          'gap: 2px !important;' +
          'margin-bottom: 20px !important;' +
          'border-bottom: 2px solid #dee2e6 !important;' +
          'padding-bottom: 10px !important;' +
          'align-items: center !important;' +
          'min-height: 40px !important;' +
          'flex-wrap: nowrap !important;';
        console.log('Applied immediate stable tab layout');
      }
    }, 50);
  } else {
    console.log('NOT applying view-only restrictions because isViewOnly is false');
  }
  
  const teamAInput = document.getElementById('teamAName');
  const teamBInput = document.getElementById('teamBName');
  
  if (teamAInput) {
    teamAInput.addEventListener('input', function() {
      teamsList[0] = this.value.trim() || 'Team A';
      console.log('Team A updated:', teamsList[0]);
      updateBattingFirstDropdown();
    });
  }
  
  if (teamBInput) {
    teamBInput.addEventListener('input', function() {
      teamsList[1] = this.value.trim() || 'Team B';
      console.log('Team B updated:', teamsList[1]);
      updateBattingFirstDropdown();
    });
  }
});

// Global variable to track auto-refresh interval
let autoRefreshInterval = null;
let viewOnlyRestrictionsApplied = false;

// Separate function to apply view-only restrictions
function applyViewOnlyRestrictions() {
  console.log('applyViewOnlyRestrictions called - isViewOnly:', isViewOnly);
  
  // IMMEDIATE EXIT if not view-only
  if (!isViewOnly) {
    console.log('EXITING applyViewOnlyRestrictions - not view-only mode');
    return;
  }
  
  // Prevent multiple applications
  if (viewOnlyRestrictionsApplied) {
    console.log('View-only restrictions already applied, skipping');
    return;
  }
  
  console.log('Proceeding with view-only restrictions application');
  viewOnlyRestrictionsApplied = true;
  
  // Hide Match Settings tab
  const matchSettingsTabBtn = Array.from(document.querySelectorAll('.tab')).find(t => t.textContent === 'Match Settings');
  if (matchSettingsTabBtn) {
    matchSettingsTabBtn.style.display = 'none';
    console.log('Hidden Match Settings tab');
  }
  
  // Check if match is completed and show appropriate tabs
  api('/api/state').then(st => {
    const isMatchComplete = st.match_complete;
    
    if (isMatchComplete) {
      // Match completed: show Scoreboard and Summary tabs
      console.log('Match completed, showing Scoreboard and Summary tabs');
      
      // Hide Match tab
      const matchTabBtn = Array.from(document.querySelectorAll('.tab')).find(t => t.textContent === 'Match');
      if (matchTabBtn) {
        matchTabBtn.style.display = 'none';
        console.log('Hidden Match tab (completed match)');
      }
      
      // Show Scoreboard tab
      const scoreboardTabBtn = Array.from(document.querySelectorAll('.tab')).find(t => t.textContent === 'Scoreboard');
      if (scoreboardTabBtn) {
        scoreboardTabBtn.style.display = 'block';
        console.log('Showing Scoreboard tab (completed match)');
      }
      
      // Show Summary tab
      const summaryTabBtn = Array.from(document.querySelectorAll('.tab')).find(t => t.textContent === 'Summary');
      if (summaryTabBtn) {
        summaryTabBtn.style.display = 'block';
        console.log('Showing Summary tab (completed match)');
        
        // Auto-switch to Summary tab for completed matches
        summaryTabBtn.click();
        console.log('Switched to Summary tab for completed match');
      }
    } else {
      // Live match: show Match, Scoreboard and Summary tabs
      console.log('Live match, showing Match, Scoreboard and Summary tabs');
      
      // Show Match tab (without controls)
      const matchTabBtn = Array.from(document.querySelectorAll('.tab')).find(t => t.textContent === 'Match');
      if (matchTabBtn) {
        matchTabBtn.style.display = 'block';
        console.log('Showing Match tab (live match)');
      }
      
      // Show Scoreboard tab
      const scoreboardTabBtn = Array.from(document.querySelectorAll('.tab')).find(t => t.textContent === 'Scoreboard');
      if (scoreboardTabBtn) {
        scoreboardTabBtn.style.display = 'block';
        console.log('Showing Scoreboard tab (live match)');
      }
      
      // Show Summary tab
      const summaryTabBtn = Array.from(document.querySelectorAll('.tab')).find(t => t.textContent === 'Summary');
      if (summaryTabBtn) {
        summaryTabBtn.style.display = 'block';
        console.log('Showing Summary tab (live match)');
        
        // Auto-switch to Summary tab for live matches
        summaryTabBtn.click();
        console.log('Switched to Summary tab for live match');
      }
    }
    
    // Now fix tab alignment with proper order
    const tabsContainer = document.getElementById('tabs');
    if (tabsContainer) {
      // Reset container styling to maintain original order
      tabsContainer.style.cssText = 
        'display: flex !important;' +
        'gap: 2px;' +
        'margin-bottom: 20px;' +
        'border-bottom: 2px solid #dee2e6;' +
        'padding-bottom: 10px;' +
        'align-items: flex-end;';
      
      // Get all tabs in original order and style them properly
      const allTabs = tabsContainer.querySelectorAll('.tab');
      allTabs.forEach((tab, index) => {
        const tabText = tab.textContent.trim();
        
        // Check if this tab should be visible based on match completion status
        const isVisible = 
          (tabText === 'Match Settings' && false) || // Always hidden
          (tabText === 'Match' && !isMatchComplete) || // Show for live matches
          (tabText === 'Scoreboard') || // Always show
          (tabText === 'Summary'); // Always show
        
        if (isVisible) {
          tab.style.cssText = 
            'background: #007bff;' +
            'color: white;' +
            'padding: 10px 20px;' +
            'border: none;' +
            'border-radius: 8px 8px 0 0;' +
            'cursor: pointer;' +
            'font-weight: bold;' +
            'transition: all 0.3s ease;' +
            'margin-right: 2px;' +
            'display: block !important;' +
            'order: ' + index + ';';
          console.log('Styled and positioned tab:', tabText, 'at order:', index);
        } else {
          tab.style.display = 'none';
          console.log('Hidden tab:', tabText);
        }
      });
      
      console.log('Fixed tab alignment and order for view-only mode');
    }
  }).catch(e => {
    console.error('Failed to check match completion:', e);
  });
  
  // Hide Share Match buttons and divs
  const shareButtons = document.querySelectorAll('button[onclick*="shareMatch"]');
  shareButtons.forEach(button => {
    button.style.display = 'none';
    console.log('Hidden Share Match button');
  });
  
  const shareDivs = document.querySelectorAll('#shareStatus');
  shareDivs.forEach(div => {
    div.style.display = 'none';
  });
  
  // Hide All Matches button
  const allMatchesButtons = document.querySelectorAll('button[onclick*="showMatchesList"]');
  allMatchesButtons.forEach(button => {
    button.style.display = 'none';
    console.log('Hidden All Matches button');
  });
  
  // Hide New Match button
  const newMatchButtons = document.querySelectorAll('button[onclick*="createNewMatch"]');
  newMatchButtons.forEach(button => {
    button.style.display = 'none';
    console.log('Hidden New Match button');
  });
  
  // Hide match configuration details
  const matchHeader = document.getElementById('matchHeader');
  if (matchHeader) {
    // Hide: match header with ID and name
    matchHeader.style.display = 'none';
    console.log('Hidden match header');
  }
  
  // Hide Match Configuration section
  const matchConfigSection = document.getElementById('matchSettingsTab');
  if (matchConfigSection) {
    matchConfigSection.style.display = 'none';
    console.log('Hidden Match Configuration section');
  }
  
  // Hide all control buttons
  const controlButtons = document.querySelectorAll('button[onclick*="score"], button[onclick*="wicket"], button[onclick*="extra"], button[onclick*="addPlayer"], button[onclick*="change"], button[onclick*="switch"], button[onclick*="selectOpeners"]');
  controlButtons.forEach(button => {
    button.style.display = 'none';
  });
  
  // Hide Scoring and Controls divs specifically
  const scoringDivs = document.querySelectorAll('h2');
  scoringDivs.forEach(div => {
    if (div.textContent.includes('Scoring') || div.textContent.includes('Controls')) {
      const parentCard = div.closest('.card');
      if (parentCard) {
        parentCard.style.display = 'none';
        console.log('Hidden', div.textContent, 'card');
      }
    }
  });
  
  // Disable all input fields
  const inputFields = document.querySelectorAll('input, select, textarea');
  inputFields.forEach(input => {
    input.disabled = true;
    input.style.opacity = '0.5';
  });
  
  // Show view-only banner
  const banner = document.createElement('div');
  banner.style.cssText = 
    'position: fixed;' +
    'top: 0;' +
    'left: 0;' +
    'right: 0;' +
    'background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);' +
    'color: white;' +
    'padding: 8px 20px;' +
    'text-align: center;' +
    'font-weight: bold;' +
    'z-index: 10000;' +
    'box-shadow: 0 2px 10px rgba(0,0,0,0.2);' +
    'font-size: 14px;' +
    'height: 36px;' +
    'line-height: 20px;' +
    'display: flex;' +
    'align-items: center;' +
    'justify-content: center;';
  banner.innerHTML = 'üîí View-Only Mode - Spectating | Auto-refreshing every 10 seconds';
  document.body.appendChild(banner);
  
  // Adjust body padding to account for banner
  document.body.style.paddingTop = '36px';
  
  // Ensure tabs container has stable layout
  const tabsContainer = document.getElementById('tabs');
  if (tabsContainer) {
    // Add stable styling to prevent collapse - use append to avoid overriding
    const existingStyle = tabsContainer.getAttribute('style') || '';
    tabsContainer.setAttribute('style', existingStyle + 
      'min-height: 40px !important;' +
      'flex-wrap: nowrap !important;' +
      'align-items: center !important;' +
      'display: flex !important;' +
      'gap: 2px !important;' +
      'margin-bottom: 20px !important;' +
      'border-bottom: 2px solid #dee2e6 !important;' +
      'padding-bottom: 10px !important;');
    console.log('Added stable layout for tabs container');
  }
  
  // Auto-refresh every 5 seconds for view-only spectators (stop when match is complete)
  // Clear any existing interval first
  if (autoRefreshInterval) {
    console.log('Clearing existing auto-refresh interval');
    clearInterval(autoRefreshInterval);
    autoRefreshInterval = null;
  }
  
  // Double-check isViewOnly before creating interval
  if (!isViewOnly) {
    console.log('NOT creating auto-refresh interval because isViewOnly is false');
    return;
  }
  
  console.log('Creating auto-refresh interval for view-only mode');
  autoRefreshInterval = setInterval(() => {
    console.log('Auto-refreshing scoreboard for spectator...');
    refresh().then(() => {
      // Check if match is complete after refresh
      api('/api/state').then(st => {
        if (st.match_complete) {
          console.log('Match completed, stopping auto-refresh');
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          
          // Show victory popup for view-only users
          showVictoryPopup(st.match_winner);
          
          // Update banner to show match is complete
          const banner = document.querySelector('[style*="position: fixed"]');
          if (banner) {
            banner.innerHTML = ' Match Completed - Final Score | View-Only Mode';
            banner.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
            // Maintain same layout properties
            banner.style.height = '36px';
            banner.style.lineHeight = '20px';
            banner.style.padding = '8px 20px';
            
            // Re-apply stable tab layout after match completion
            setTimeout(() => {
              const tabsContainer = document.getElementById('tabs');
              if (tabsContainer) {
                // Force stable layout after match completion
                tabsContainer.style.cssText = 
                  'display: flex !important;' +
                  'gap: 2px !important;' +
                  'margin-bottom: 20px !important;' +
                  'border-bottom: 2px solid #dee2e6 !important;' +
                  'padding-bottom: 10px !important;' +
                  'align-items: center !important;' +
                  'min-height: 40px !important;' +
                  'flex-wrap: nowrap !important;';
                console.log('Re-applied stable tab layout after match completion');
              }
            }, 100);
          }
        } else {
          // Re-apply stable tab layout after refresh to prevent collapse
          if (isViewOnly) {
            setTimeout(() => {
              const tabsContainer = document.getElementById('tabs');
              if (tabsContainer) {
                // Force stable layout after refresh
                tabsContainer.style.cssText = 
                  'display: flex !important;' +
                  'gap: 2px !important;' +
                  'margin-bottom: 20px !important;' +
                  'border-bottom: 2px solid #dee2e6 !important;' +
                  'padding-bottom: 10px !important;' +
                  'align-items: center !important;' +
                  'min-height: 40px !important;' +
                  'flex-wrap: nowrap !important;';
                console.log('Re-applied stable tab layout after refresh');
              }
            }, 100);
          }
          
          // Check for recent boundary or wicket in view-only mode and show celebration
          if (isViewOnly && st.ball_by_ball && st.ball_by_ball.length > 0) {
            // Get only the most recent ball (last ball)
            const mostRecentBall = st.ball_by_ball[st.ball_by_ball.length - 1];
            
            // Check for no-ball and show "Free Hit" popup
            if (mostRecentBall.extra_type === 'no-ball') {
              showFreeHitPopup();
            }
            // Check for boundary (4 or 6 runs) in most recent ball
            else if (mostRecentBall.runs === 4 || mostRecentBall.runs === 6) {
              showBoundaryCelebration(mostRecentBall.runs);
            }
            // Check for wicket in most recent ball
            else if (mostRecentBall.wicket) {
              showWicketCelebration();
            }
          }
        }
      }).catch(e => {
        console.error('Failed to check match completion:', e);
      });
    });
  }, 10000); // 10 seconds instead of 5 seconds
}

// Celebration functions for view-only mode
function showBoundaryCelebration(runs) {
  // Use the same impressive popup as regular users
  const isFour = runs === 4;
  const emoji = isFour ? 'üèÉ‚Äç‚ôÇÔ∏è' : 'üöÄ';
  const bgColor = isFour ? 'linear-gradient(135deg,#28a745 0%,#20c997 100%)' : 'linear-gradient(135deg,#ffc107 0%,#ff6b6b 100%)';
  const message = isFour ? 'FOUR!' : 'SIX! AMAZING!';
  
  // Create 3D stars container
  const starsContainer = document.createElement('div');
  starsContainer.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1999;
  `;
  
  // Create multiple 3D stars
  for (let i = 0; i < 20; i++) {
    create3DStar(starsContainer, isFour);
  }
  
  const popup = document.createElement('div');
  popup.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:${bgColor};color:white;padding:40px;border-radius:20px;z-index:2000;box-shadow:0 20px 40px rgba(0,0,0,0.3);text-align:center;min-width:400px;animation:boundaryPop 0.5s ease-out`;
  
  popup.innerHTML = 
    '<div style="font-size:72px;margin-bottom:20px;animation:pulse 1s infinite">' + emoji + '</div>' +
    '<h2 style="margin:0 0 15px 0;font-size:48px;font-weight:bold;text-shadow:2px 2px 4px rgba(0,0,0,0.3)">' + message + '</h2>' +
    '<div style="font-size:36px;margin-bottom:10px;font-weight:bold;text-shadow:2px 2px 4px rgba(0,0,0,0.3)">' + runs + ' RUNS!</div>' +
    '<div style="font-size:18px;opacity:0.9;">Great shot! ' + (isFour ? 'Well placed!' : 'Huge hit!') + '</div>' +
    '<div style="font-size:14px;opacity:0.7;margin-top:10px;">üåü Spectator Celebration üåü</div>';
  
  // Safely append popup and stars to body
  if (document.body) {
    document.body.appendChild(starsContainer);
    document.body.appendChild(popup);
  } else {
    console.error('document.body is not available for boundary celebration');
    return;
  }
  
  // Add animations
  const boundaryStyle = document.createElement('style');
  boundaryStyle.textContent = 
    '@keyframes boundaryPop {' +
    '  0% { transform: translate(-50%,-50%) scale(0.3) rotate(-10deg); opacity: 0; }' +
    '  50% { transform: translate(-50%,-50%) scale(1.1) rotate(5deg); opacity: 1; }' +
    '  100% { transform: translate(-50%,-50%) scale(1) rotate(0deg); opacity: 1; }' +
    '}' +
    '@keyframes pulse {' +
    '  0%, 100% { transform: scale(1); }' +
    '  50% { transform: scale(1.1); }' +
    '}' +
    '@keyframes star3D {' +
    '  0% { transform: translate(-50%, -50%) rotateX(0deg) rotateY(0deg) scale(0); opacity: 0; }' +
    '  20% { transform: translate(-50%, -50%) rotateX(180deg) rotateY(360deg) scale(1.5); opacity: 1; }' +
    '  40% { transform: translate(-50%, -50%) rotateX(360deg) rotateY(720deg) scale(1); opacity: 1; }' +
    '  60% { transform: translate(-50%, -50%) rotateX(540deg) rotateY(1080deg) scale(0.8); opacity: 0.8; }' +
    '  80% { transform: translate(-50%, -50%) rotateX(720deg) rotateY(1440deg) scale(0.5); opacity: 0.5; }' +
    '  100% { transform: translate(-50%, -50%) rotateX(900deg) rotateY(1800deg) scale(0); opacity: 0; }' +
    '}';
  document.head.appendChild(boundaryStyle);
  
  // Auto-remove after 3 seconds
  setTimeout(() => {
    popup.style.animation = 'boundaryPop 0.3s ease-out reverse';
    setTimeout(() => {
      if (document.body && document.body.contains(popup)) {
        document.body.removeChild(popup);
      }
      if (document.body && document.body.contains(starsContainer)) {
        document.body.removeChild(starsContainer);
      }
    }, 300);
  }, 3000);
}

function create3DStar(container, isFour) {
  const star = document.createElement('div');
  const size = Math.random() * 30 + 20; // 20-50px
  const x = Math.random() * 100; // 0-100% of screen width
  const y = Math.random() * 100; // 0-100% of screen height
  const delay = Math.random() * 0.5; // 0-0.5s delay
  const duration = Math.random() * 2 + 2; // 2-4s duration
  
  star.innerHTML = '‚≠ê';
  star.style.cssText = `
    position: absolute;
    left: ${x}%;
    top: ${y}%;
    font-size: ${size}px;
    color: ${isFour ? '#28a745' : '#ffc107'};
    text-shadow: 0 0 10px ${isFour ? '#28a745' : '#ffc107'}, 0 0 20px ${isFour ? '#20c997' : '#ff6b6b'};
    animation: star3D ${duration}s ease-out ${delay}s;
    transform-style: preserve-3d;
    perspective: 1000px;
  `;
  
  container.appendChild(star);
}

function showWicketCelebration() {
  // Use the same impressive popup as regular users
  const popup = document.createElement('div');
  popup.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#dc3545 0%,#6f42c1 100%);color:white;padding:40px;border-radius:20px;z-index:2000;box-shadow:0 20px 40px rgba(0,0,0,0.3);text-align:center;min-width:450px;animation:wicketPop 0.5s ease-out`;
  
  popup.innerHTML = 
    '<div style="font-size:72px;margin-bottom:20px;">üèè</div>' +
    '<h2 style="margin:0 0 15px 0;font-size:42px;font-weight:bold;">WICKET FALLEN!</h2>' +
    '<div style="font-size:20px;margin-bottom:10px;">That is out!</div>' +
    '<div style="font-size:18px;opacity:0.9;">Wicket fallen!</div>' +
    '<div style="font-size:14px;opacity:0.7;margin-top:10px;">Spectator Moment</div>';
  
  document.body.appendChild(popup);
  
  // Add animation
  const wicketStyle = document.createElement('style');
  wicketStyle.textContent = 
    '@keyframes wicketPop {' +
    '  0% { transform: translate(-50%,-50%) scale(0.3); opacity: 0; }' +
    '  50% { transform: translate(-50%,-50%) scale(1.05); opacity: 1; }' +
    '  100% { transform: translate(-50%,-50%) scale(1) rotate(-2deg); opacity: 1; }' +
    '}';
  document.head.appendChild(wicketStyle);
  
  // Auto-remove after 3.5 seconds
  setTimeout(() => {
    popup.style.animation = 'wicketPop 0.3s ease-out reverse';
    setTimeout(() => {
      if (document.body.contains(popup)) {
        document.body.removeChild(popup);
      }
    }, 300);
  }, 3500);
}

function showFreeHitPopup() {
  // Show "Free Hit" popup for no-balls
  const popup = document.createElement('div');
  popup.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#17a2b8 0%,#00d2d3 100%);color:white;padding:40px;border-radius:20px;z-index:2000;box-shadow:0 20px 40px rgba(0,0,0,0.3);text-align:center;min-width:400px;animation:freeHitPop 0.5s ease-out`;
  
  popup.innerHTML = 
    '<div style="font-size:72px;margin-bottom:20px;">üéØ</div>' +
    '<h2 style="margin:0 0 15px 0;font-size:42px;font-weight:bold;">FREE HIT!</h2>' +
    '<div style="font-size:24px;margin-bottom:10px;">No-Ball!</div>' +
    '<div style="font-size:18px;opacity:0.9;">Free hit coming up! Extra run added.</div>' +
    '<div style="font-size:14px;opacity:0.7;margin-top:10px;">Spectator Moment</div>';
  
  document.body.appendChild(popup);
  
  // Add animation
  const freeHitStyle = document.createElement('style');
  freeHitStyle.textContent = 
    '@keyframes freeHitPop {' +
    '  0% { transform: translate(-50%,-50%) scale(0.3) rotate(-15deg); opacity: 0; }' +
    '  50% { transform: translate(-50%,-50%) scale(1.1) rotate(8deg); opacity: 1; }' +
    '  100% { transform: translate(-50%,-50%) scale(1) rotate(0deg); opacity: 1; }' +
    '}';
  document.head.appendChild(freeHitStyle);
  
  // Auto-remove after 2.5 seconds
  setTimeout(() => {
    popup.style.animation = 'freeHitPop 0.3s ease-out reverse';
    setTimeout(() => {
      if (document.body && document.body.contains(popup)) {
        document.body.removeChild(popup);
      }
    }, 300);
  }, 2500);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = 
  '@keyframes celebrationPopup {' +
  '  0% {' +
  '    opacity: 0;' +
  '    transform: translate(-50%, -50%) scale(0.8);' +
  '  }' +
  '  100% {' +
  '    opacity: 1;' +
  '    transform: translate(-50%, -50%) scale(1);' +
  '  }' +
  '}';
document.head.appendChild(style);
function getCurrentMatchId() {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('match_id');
}

function updateMatchHeader() {
  const matchId = getCurrentMatchId();
  const mainTitle = document.getElementById('mainTitle');
  const matchHeader = document.getElementById('matchHeader');
  
  console.log('updateMatchHeader called - matchId:', matchId);
  
  if (matchId) {
    console.log('Showing match header for matchId:', matchId);
    
    // Show match header
    if (matchHeader) matchHeader.style.display = 'block';
    
    // Update match ID and name
    const currentMatchIdEl = document.getElementById('currentMatchId');
    const currentMatchNameEl = document.getElementById('currentMatchName');
    
    if (currentMatchIdEl) currentMatchIdEl.textContent = matchId.substring(0, 8) + '...';
    if (currentMatchNameEl) currentMatchNameEl.textContent = 'Loading...';
    
    // Show main title
    if (mainTitle) mainTitle.style.display = 'block';
    
    // Get full match details
    api('/api/state').then(st => {
      console.log('Got match state:', st);
      if (st.match_id && st.match_name) {
        if (currentMatchIdEl) currentMatchIdEl.textContent = st.match_id;
        if (currentMatchNameEl) currentMatchNameEl.textContent = st.match_name;
      }
    }).catch(e => {
      console.error('Failed to load match details:', e);
      if (currentMatchNameEl) currentMatchNameEl.textContent = 'Unknown Match';
    });
  } else {
    console.log('No matchId, hiding match header');
    
    // Hide match header
    if (matchHeader) matchHeader.style.display = 'none';
    
    // Hide main title
    if (mainTitle) mainTitle.style.display = 'none';
  }
}

function shareMatch() {
  const matchId = getCurrentMatchId();
  if (matchId) {
    // Debug: Check if encodeViewParam function exists
    console.log('encodeViewParam function exists:', typeof encodeViewParam);
    
    // Create encoded view-only parameter that only our program can understand
    const encodedRole = encodeViewParam();
    console.log('Generated encoded role:', encodedRole);
    
    const shareUrl = window.location.origin + '?match_id=' + matchId + '&Role=' + encodedRole;
    console.log('Generated share URL:', shareUrl);
    
    // Create share popup
    const overlay = document.createElement('div');
    overlay.className = 'popup-overlay';
    overlay.style.cssText = 
      'position: fixed;' +
      'top: 0;' +
      'left: 0;' +
      'width: 100%;' +
      'height: 100%;' +
      'background: rgba(0, 0, 0, 0.5);' +
      'backdrop-filter: blur(5px);' +
      'z-index: 9999;' +
      'display: flex;' +
      'justify-content: center;' +
      'align-items: center;';
    
    const popup = document.createElement('div');
    popup.style.cssText = 
      'background: white;' +
      'padding: 30px;' +
      'border-radius: 15px;' +
      'box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);' +
      'max-width: 500px;' +
      'text-align: center;' +
      'animation: popupSlide 0.3s ease-out;';
    
    popup.innerHTML = 
      '<div style="font-size: 48px; margin-bottom: 15px;">üîó</div>' +
      '<h3 style="margin: 0 0 15px 0; color: #01147C;">Share Match (View Only)</h3>' +
      '<p style="margin: 0 0 20px 0; color: #333; font-size: 16px;">Share this view-only link with others to watch the match:</p>' +
      '<div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 20px; word-break: break-all; font-family: monospace; font-size: 14px; color: #495057;">' +
        shareUrl +
      '</div>' +
      '<div style="background: #e3f2fd; border-left: 4px solid #3b82f6; padding: 15px; margin-bottom: 20px; border-radius: 0 8px 8px 0;">' +
        '<div style="color: #1e40af; font-weight: bold; margin-bottom: 10px;">üîí Secure View-Only Access</div>' +
        '<div style="color: #64748b; font-size: 14px;">Viewers can watch the match but cannot edit scores or modify match details. The access parameter is encoded for security.</div>' +
      '</div>' +
      '<div style="display: flex; gap: 10px; justify-content: center;">' +
        '<button onclick="copyShareLink(\\'' + shareUrl + '\\')" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">üìã Copy Link</button>' +
        '<button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">Close</button>' +
      '</div>';
    
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    
    // Close on overlay click
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        overlay.remove();
      }
    });
  } else {
    // Show proper message to create match first
    showPopupAlert('No Active Match', 'Please create a new match first before sharing. Click the "‚ûï New Match" button to get started.');
  }
}

function copyShareLink(url) {
  navigator.clipboard.writeText(url).then(() => {
    // Successfully copied - no popup needed
    console.log('Match link copied to clipboard');
  }).catch(() => {
    // Fallback for older browsers
    const textArea = document.createElement('textarea');
    textArea.value = url;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    // Successfully copied - no popup needed
    console.log('Match link copied to clipboard (fallback method)');
  });
}

async function showMatchesList() {
  try {
    // ... (rest of the code remains the same)
    const response = await api('/api/matches');
    const matches = response.matches || [];
    
    if (matches.length === 0) {
      showPopupAlert('No Matches', 'No matches found. Create a new match to get started!');
      return;
    }
    
    // Create matches list popup
    const overlay = document.createElement('div');
    overlay.className = 'popup-overlay';
    overlay.style.cssText = 
      'position: fixed;' +
      'top: 0;' +
      'left: 0;' +
      'width: 100%;' +
      'height: 100%;' +
      'background: rgba(0, 0, 0, 0.5);' +
      'backdrop-filter: blur(5px);' +
      'z-index: 9999;' +
      'display: flex;' +
      'justify-content: center;' +
      'align-items: center;';
    
    const popup = document.createElement('div');
    popup.style.cssText = 
      'background: white;' +
      'padding: 30px;' +
      'border-radius: 15px;' +
      'box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);' +
      'max-width: 600px;' +
      'max-height: 80vh;' +
      'overflow-y: auto;' +
      'animation: popupSlide 0.3s ease-out;';
    
    const matchesList = matches.map(match => 
      '<div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">' +
        '<div style="font-weight: bold; margin-bottom: 8px; color: #01147C;">' + match.match_id.substring(0, 8) + '...</div>' +
        '<div style="font-size: 14px; margin-bottom: 8px;">' +
          (match.team_a_name || 'Team A') + ' vs ' + (match.team_b_name || 'Team B') +
          (match.started ? ' üèè Started' : ' ‚è≥ Not Started') +
        '</div>' +
        '<button onclick="loadMatch(\\'' + match.match_id + '\\')" style="background: #007bff; color: white; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Load</button>' +
      '</div>'
    ).join('');
    
    popup.innerHTML = 
      '<div style="font-size: 36px; margin-bottom: 15px;">üìã</div>' +
      '<h3 style="margin: 0 0 15px 0; color: #01147C;">All Matches</h3>' +
      '<p style="margin: 0 0 20px 0; color: #333; font-size: 16px;">Select a match to load:</p>' +
      '<div style="max-height: 400px; overflow-y: auto;">' +
        matchesList +
      '</div>' +
      '<div style="margin-top: 20px; text-align: center;">' +
        '<button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">Close</button>' +
      '</div>';
    
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    
    // Close on overlay click
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        overlay.remove();
      }
    });
  } catch (e) {
    console.error('Failed to load matches:', e);
    showPopupAlert('Error', 'Failed to load matches list.');
  }
}

function loadMatch(matchId) {
  // Use the global isViewOnly variable instead of creating a new one
  console.log('DEBUG: loadMatch() called - matchId:', matchId, 'View-only mode:', isViewOnly, 'TIMESTAMP:', new Date().toISOString());
  
  // Load match data and update UI
  refresh().then(() => {
    console.log('DEBUG: refresh() completed in loadMatch, calling updateMatchHeader');
    // Show match header
    updateMatchHeader();
  }).catch(e => {
    console.error('Failed to load match:', e);
  });
}

// Go to home page
function goToHome() {
  window.location.href = '/';
}

// MatchID Management Functions
async function api(path, body) {
  const res = await fetch(path, {
    method: body ? 'POST' : 'GET',
    headers: body ? {'Content-Type': 'application/json'} : undefined,
    body: body ? JSON.stringify(body) : undefined
  });
  const data = await res.json();
  if (!res.ok) {
    if (data.debug) {
      console.error('Debug info:', data.debug);
      let debugMessage = 'Innings not complete. Debug info:';
     debugMessage += 'Current over: ' + data.debug.current_over + '.' + data.debug.current_ball + '\\n';
     debugMessage += 'Max overs: ' + data.debug.max_overs + '\\n';
     debugMessage += 'Wickets: ' + data.debug.wickets + '\\n';
     debugMessage += 'Players: ' + data.debug.batting_team_players + '\\n';
     debugMessage += 'Batting order: ' + data.debug.batting_order_length + '\\n';
     debugMessage += 'Runs: ' + data.debug.total_runs;
  showPopupAlert('Innings Not Complete', debugMessage);


    } else {
      throw new Error(data.error || 'Request failed');
    }
  }
  return data;
}

function roleValue(r) {
  return r;
}

async function refresh() {
  console.log('DEBUG: refresh() called - TIMESTAMP:', new Date().toISOString());
  
  // Get state from backend API
  const st = await api('/api/state');
  console.log('DEBUG: Backend state received:', st);
  
  // Safely update team name fields (only if they exist)
  const teamANameEl = document.getElementById('teamAName');
  const teamBNameEl = document.getElementById('teamBName');
  if (teamANameEl) teamANameEl.value = st.team_a_name || '';
  if (teamBNameEl) teamBNameEl.value = st.team_b_name || '';
  
  // Update teamsList with current team names from server
  teamsList[0] = st.team_a_name || 'Team A';
  teamsList[1] = st.team_b_name || 'Team B';

  const batFirst = document.getElementById('batFirst');
  if (batFirst) {
    batFirst.innerHTML = '';
    // Only populate if teams have players
    if (st.team_a_players && st.team_a_players.length >= 2) {
      const opt1 = document.createElement('option');
      opt1.textContent = teamsList[0];
      batFirst.appendChild(opt1);
    }
    if (st.team_b_players && st.team_b_players.length >= 2) {
      const opt2 = document.createElement('option');
      opt2.textContent = teamsList[1];
      batFirst.appendChild(opt2);
    }
    if (st.batting_first) batFirst.value = st.batting_first;
    
    // Enable dropdown only if both teams have at least 2 players
    if (st.team_a_players.length >= 2 && st.team_b_players.length >= 2) {
      batFirst.disabled = false;
    } else {
      batFirst.disabled = true;
    }
  }

  const ulA = document.getElementById('teamAList');
  const ulB = document.getElementById('teamBList');
  if (ulA) ulA.innerHTML = ''; 
  if (ulB) ulB.innerHTML = '';
  for (const p of st.team_a_players) {
    if (ulA) {
      const li = document.createElement('li'); 
      li.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 4px 0; background: #f8f9fa; border-radius: 4px; border: 1px solid #dee2e6;';
      
      // Player info
      const playerInfo = document.createElement('span');
      playerInfo.textContent = p.name + ' (' + p.role + ')' + (st.team_a_captain === p.name ? ' üß¢' : '') + getPlayerRoleIcon(p.role);
      
      // Action buttons
      const actionsDiv = document.createElement('div');
      actionsDiv.style.cssText = 'display: flex; gap: 5px;';
      
      const editBtn = document.createElement('button');
      editBtn.textContent = '‚úèÔ∏è';
      editBtn.style.cssText = 'background: #007bff; color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer; font-size: 12px;';
      editBtn.onclick = () => {
        console.log('DEBUG: Edit button clicked for player:', p.name, 'ID:', p.id);
        editPlayer('team_a', p.id);
      };
      
      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'üóëÔ∏è';
      removeBtn.style.cssText = 'background: #dc3545; color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer; font-size: 12px;';
      removeBtn.onclick = () => {
        console.log('DEBUG: Remove button clicked for player:', p.name, 'ID:', p.id);
        removePlayer('team_a', p.id);
      };
      
      actionsDiv.appendChild(editBtn);
      actionsDiv.appendChild(removeBtn);
      
      li.appendChild(playerInfo);
      li.appendChild(actionsDiv);
      ulA.appendChild(li);
    }
  }
  for (const p of st.team_b_players) {
    if (ulB) {
      const li = document.createElement('li'); 
      li.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 4px 0; background: #f8f9fa; border-radius: 4px; border: 1px solid #dee2e6;';
      
      // Player info
      const playerInfo = document.createElement('span');
      playerInfo.textContent = p.name + ' (' + p.role + ')' + (st.team_b_captain === p.name ? ' üß¢' : '') + getPlayerRoleIcon(p.role);
      
      // Action buttons
      const actionsDiv = document.createElement('div');
      actionsDiv.style.cssText = 'display: flex; gap: 5px;';
      
      const editBtn = document.createElement('button');
      editBtn.textContent = '‚úèÔ∏è';
      editBtn.style.cssText = 'background: #007bff; color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer; font-size: 12px;';
      editBtn.onclick = () => {
        console.log('DEBUG: Edit button clicked for player:', p.name, 'ID:', p.id);
        editPlayer('team_b', p.id);
      };
      
      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'üóëÔ∏è';
      removeBtn.style.cssText = 'background: #dc3545; color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer; font-size: 12px;';
      removeBtn.onclick = () => {
        console.log('DEBUG: Remove button clicked for player:', p.name, 'ID:', p.id);
        removePlayer('team_b', p.id);
      };
      
      actionsDiv.appendChild(editBtn);
      actionsDiv.appendChild(removeBtn);
      
      li.appendChild(playerInfo);
      li.appendChild(actionsDiv);
      ulB.appendChild(li);
    }
  }

  if (st.started) {
    const tabsEl = document.getElementById('tabs');
    const matchSettingsTabEl = document.getElementById('matchSettingsTab');
    const matchTabEl = document.getElementById('matchTab');
    const scoreboardTabEl = document.getElementById('scoreboardTab');
    const summaryTabEl = document.getElementById('summaryTab');
    
    if (tabsEl) tabsEl.style.display = 'block';
    if (matchSettingsTabEl) matchSettingsTabEl.style.display = 'none';
    if (matchTabEl) matchTabEl.style.display = 'block';
    if (scoreboardTabEl) scoreboardTabEl.style.display = 'none';
    if (summaryTabEl) summaryTabEl.style.display = 'none';
    
    // Update active tab to Match
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    const matchTabBtn = Array.from(document.querySelectorAll('.tab')).find(t => t.textContent === 'Match');
    if (matchTabBtn) matchTabBtn.classList.add('active');
    
    const scoreLineEl = document.getElementById('scoreLine');
    const playersLineEl = document.getElementById('playersLine');
    
    if (scoreLineEl) {
    // Calculate extras separately
    const wides = st.summary.extras?.wide || 0;
    const noballs = st.summary.extras?.no_ball || 0;
    const byes = st.summary.extras?.bye || 0;
    const legbyes = st.summary.extras?.leg_bye || 0;
    const totalExtras = wides + noballs + byes + legbyes;
    
    // Build extras display
    let extrasDisplay = '';
    if (totalExtras > 0) {
      const extrasParts = [];
      if (wides > 0) extrasParts.push('Wide: ' + wides);
      if (noballs > 0) extrasParts.push('No-ball: ' + noballs);
      if (byes > 0) extrasParts.push('Bye: ' + byes);
      if (legbyes > 0) extrasParts.push('Leg-bye: ' + legbyes);
      extrasDisplay = ' (Extras: ' + extrasParts.join(', ') + ')';
    }
    
    scoreLineEl.textContent = st.summary.batting_team + ': ' + st.summary.runs + '/' + st.summary.wickets + ' (' + st.summary.overs + ' overs)' + extrasDisplay;
  }
    if (playersLineEl) playersLineEl.textContent = 'Striker: ' + (st.striker || 'Not set') + ' | Non-striker: ' + (st.non_striker || 'Not set') + ' | Bowler: ' + (st.bowler || 'Not set');
    
    // Target display for second innings
    const targetLineEl = document.getElementById('targetLine');
    if (st.target && targetLineEl) {
      targetLineEl.textContent = 'Target: ' + st.target.runs + ' runs in ' + st.target.overs + ' overs';
    } else if (targetLineEl) {
      targetLineEl.textContent = '';
    }
    
    // Function to get batsman's recent ball-by-ball runs with unique identifier
    function getBatsmanRecentRuns(balls, batsmanId, lastBalls = 3, batsmanName) {
      const recentBalls = balls.slice(-lastBalls).reverse().filter(b => b.batsman === batsmanId);
      const runs = recentBalls.map(b => {
        if (b.extra_type) {
          switch(b.extra_type) {
            case 'wide': return '1(wd)';
            case 'no-ball': return '1(Nb)';
            case 'bye': return '1(bye)';
            case 'leg-bye': return '1(legbye)';
            default: return b.runs;
          }
        }
        return b.runs;
      }).join(',');
      const identifier = batsmanName ? batsmanName.charAt(0).toUpperCase() + '_Extras' : 'Extras';
      return runs ? identifier + ': ' + runs : '';
    }
    
    // Function to get batsman ID by name
    function getBatsmanIdByName(players, batsmanName) {
      if (!batsmanName || !players) return null;
      try {
        const player = players.find(p => p && p.name === batsmanName);
        return player ? player.id : null;
      } catch (e) {
        console.error('Error in getBatsmanIdByName:', e);
        return null;
      }
    }
    
    // Function to get batsman recent runs
    function getBatsmanRecentRuns(ballByBall, batsmanId, batsmanName) {
      if (!ballByBall || !batsmanId || !batsmanName) return '';
      try {
        const batsmanBalls = ballByBall.filter(b => b.batsman_id === batsmanId);
        if (batsmanBalls.length === 0) return '';
        
        const recent = batsmanBalls.slice(-3).map(b => b.runs).join(',');
        const identifier = batsmanName ? batsmanName.charAt(0).toUpperCase() + '_Recent' : 'Recent';
        return recent ? identifier + ': ' + recent : '';
      } catch (e) {
        console.error('Error in getBatsmanRecentRuns:', e);
        return '';
      }
    }
    
    // Update batsmen display with ball-by-ball info
    const batsmenDiv = document.getElementById('batsmenScores');
    if (batsmenDiv) {
      try {
        batsmenDiv.innerHTML = '';
        if (st && st.striker && st.non_striker && st.batting_players) {
          // Striker display
          const strikerDiv = document.createElement('div');
          strikerDiv.style.marginBottom = '10px';
          
          // Basic stats - with null checks
          const strikerStats = document.createElement('div');
          const strikerName = (st && st.striker) ? st.striker : 'Unknown';
          const strikerRuns = (st && st.striker_runs !== undefined) ? st.striker_runs : 0;
          const strikerBalls = (st && st.striker_balls !== undefined) ? st.striker_balls : 0;
          strikerStats.innerHTML = '<strong>' + strikerName + ':</strong> ' + strikerRuns + ' (' + strikerBalls + ' balls)';
          strikerDiv.appendChild(strikerStats);
          
          // Ball-by-ball and extras breakdown
          try {
            if (st.ball_by_ball && Array.isArray(st.ball_by_ball) && st.batting_players && Array.isArray(st.batting_players)) {
              const strikerId = getBatsmanIdByName(st.batting_players, st.striker);
              
              // Debug: Log striker ball data
              console.log('DEBUG: Striker ball data check:', {
                strikerId: strikerId,
                strikerName: st.striker,
                totalBalls: st.ball_by_ball.length,
                strikerBalls: st.ball_by_ball.filter(ball => ball.batsman_id === strikerId).length,
                allBalls: st.ball_by_ball.map(b => ({
                  batsman_id: b.batsman_id,
                  runs: b.runs,
                  extra_type: b.extra_type,
                  is_wide: b.is_wide,
                  is_no_ball: b.is_no_ball,
                  is_bye: b.is_bye,
                  description: b.description
                })),
                battingPlayers: st.batting_players.map(p => ({
                  id: p.id,
                  name: p.name
                }))
              });
              
              // Show last 5 balls (all balls, not just striker's balls since wides have undefined batsman_id)
              const recentBalls = st.ball_by_ball.slice(-5);
              if (recentBalls.length > 0) {
                const strikerBallDiv = document.createElement('div');
                strikerBallDiv.innerHTML = '<small style="color: #666; font-weight: bold;">Ball-by-Ball:</small>';
                
                const ballDetails = [];
                const extrasCount = { wides: 0, noballs: 0, byes: 0, legbyes: 0 };
                
                recentBalls.forEach((ball, index) => {
                  console.log('DEBUG: Processing ball:', ball);
                  let ballText = '';
                  
                  // Check description field for extras (since extra_type and boolean flags are undefined)
                  if (ball.description && ball.description.toLowerCase().includes('wide')) {
                    ballText = ball.runs + '(Wd)';
                    extrasCount.wides += ball.runs || 1; // Add actual runs from wide
                  } else if (ball.description && ball.description.toLowerCase().includes('no-ball')) {
                    ballText = ball.runs + '(Nb)';
                    extrasCount.noballs += ball.runs || 1; // Add actual runs from no-ball
                  } else if (ball.description && ball.description.toLowerCase().includes('bye')) {
                    ballText = ball.runs + '(Bye)';
                    extrasCount.byes += ball.runs || 1; // Add actual runs from bye
                  } else if (ball.description && ball.description.toLowerCase().includes('leg')) {
                    ballText = ball.runs + '(Leg Bye)';
                    extrasCount.legbyes += ball.runs || 1; // Add actual runs from leg bye
                  } else {
                    ballText = ball.runs + ' runs';
                  }
                  
                  ballDetails.push(ballText);
                });
                
                console.log('DEBUG: Extras count:', extrasCount);
                console.log('DEBUG: Ball details:', ballDetails);
                
                // Show ball-by-ball runs
                const ballRunsDiv = document.createElement('div');
                ballRunsDiv.innerHTML = '<small style="color: #555;">Runs: ' + ballDetails.join(', ') + '</small>';
                strikerBallDiv.appendChild(ballRunsDiv);
                
                // Show extras breakdown if any extras
                const extrasParts = [];
                if (extrasCount.wides > 0) extrasParts.push(extrasCount.wides + '(Wd)');
                if (extrasCount.noballs > 0) extrasParts.push(extrasCount.noballs + '(Nb)');
                if (extrasCount.byes > 0) extrasParts.push(extrasCount.byes + '(Bye)');
                if (extrasCount.legbyes > 0) extrasParts.push(extrasCount.legbyes + '(Leg Bye)');
                
                if (extrasParts.length > 0) {
                  const extrasDiv = document.createElement('div');
                  extrasDiv.innerHTML = '<small style="color: #d9534f; font-weight: bold;">Extras: ' + extrasParts.join(' ') + '</small>';
                  strikerBallDiv.appendChild(extrasDiv);
                }
                
                strikerDiv.appendChild(strikerBallDiv);
              }
            }
          } catch (error) {
            console.error('Error displaying striker ball-by-ball:', error);
          }
          
          batsmenDiv.appendChild(strikerDiv);
          
        }
        
        // Non-striker display
        const nonStrikerDiv = document.createElement('div');
        nonStrikerDiv.style.marginBottom = '10px';
        
        // Basic stats - with null checks
        const nonStrikerStats = document.createElement('div');
        const nonStrikerName = (st && st.non_striker) ? st.non_striker : 'Unknown';
        const nonStrikerRuns = (st && st.non_striker_runs !== undefined) ? st.non_striker_runs : 0;
        const nonStrikerBalls = (st && st.non_striker_balls !== undefined) ? st.non_striker_balls : 0;
        nonStrikerStats.innerHTML = '<strong>' + nonStrikerName + ':</strong> ' + nonStrikerRuns + ' (' + nonStrikerBalls + ' balls)';
        nonStrikerDiv.appendChild(nonStrikerStats);
        
        // Ball-by-ball and extras breakdown
        try {
          if (st.ball_by_ball && Array.isArray(st.ball_by_ball) && st.batting_players && Array.isArray(st.batting_players)) {
            const nonStrikerId = getBatsmanIdByName(st.batting_players, st.non_striker);
            
            // Get non-striker's ball-by-ball details
            const nonStrikerBalls = st.ball_by_ball.filter(ball => ball.batsman_id === nonStrikerId);
            if (nonStrikerBalls.length > 0) {
              const nonStrikerBallDiv = document.createElement('div');
              nonStrikerBallDiv.innerHTML = '<small style="color: #666; font-weight: bold;">Ball-by-Ball:</small>';
              
              // Show last 5 balls with detailed info
              const recentBalls = nonStrikerBalls.slice(-5);
              const ballDetails = [];
              const extrasCount = { wides: 0, noballs: 0, byes: 0, legbyes: 0 };
              
              recentBalls.forEach((ball, index) => {
                let ballText = '';
                if (ball.extra_type) {
                  switch(ball.extra_type) {
                    case 'wide':
                      ballText = ball.runs + '(Wd)';
                      extrasCount.wides++;
                      break;
                    case 'no-ball':
                      ballText = ball.runs + '(Nb)';
                      extrasCount.noballs++;
                      break;
                    case 'bye':
                      ballText = ball.runs + '(Bye)';
                      extrasCount.byes++;
                      break;
                    case 'leg-bye':
                      ballText = ball.runs + '(Leg Bye)';
                      extrasCount.legbyes++;
                      break;
                    default:
                      ballText = ball.runs + ' runs';
                  }
                } else {
                  ballText = ball.runs + ' runs';
                }
                ballDetails.push(ballText);
              });
              
              // Show ball-by-ball runs
              const ballRunsDiv = document.createElement('div');
              ballRunsDiv.innerHTML = '<small style="color: #555;">Runs: ' + ballDetails.join(', ') + '</small>';
              nonStrikerBallDiv.appendChild(ballRunsDiv);
              
              // Show extras breakdown if any extras
              const extrasParts = [];
              if (extrasCount.wides > 0) extrasParts.push(extrasCount.wides + '(Wd)');
              if (extrasCount.noballs > 0) extrasParts.push(extrasCount.noballs + '(Nb)');
              if (extrasCount.byes > 0) extrasParts.push(extrasCount.byes + '(Bye)');
              if (extrasCount.legbyes > 0) extrasParts.push(extrasCount.legbyes + '(Leg Bye)');
              
              if (extrasParts.length > 0) {
                const extrasDiv = document.createElement('div');
                extrasDiv.innerHTML = '<small style="color: #d9534f; font-weight: bold;">Extras: ' + extrasParts.join(' ') + '</small>';
                nonStrikerBallDiv.appendChild(extrasDiv);
              }
              
              nonStrikerDiv.appendChild(nonStrikerBallDiv);
            }
          }
        } catch (error) {
          console.error('Error displaying non-striker ball-by-ball:', error);
        }
        
        batsmenDiv.appendChild(nonStrikerDiv);
        
      } catch (e) {
        console.error('Error updating batsmen display:', e);
        // Show a simple message if display fails
        batsmenDiv.innerHTML = '<div style="color: #666; padding: 10px;">Loading batsmen data...</div>';
      }
    }
    
    // Ball by ball view
    const balls = st.ball_by_ball || [];
    const ballDiv = document.getElementById('ballByBall');
    if (ballDiv) {
      ballDiv.innerHTML = '';
      balls.slice(-10).reverse().forEach(b => {
        const div = document.createElement('div');
        div.textContent = b.over + '.' + b.ball + ' - ' + (b.comment || b.description) + ' (' + b.runs + ' runs)';
        ballDiv.appendChild(div);
      });
    }
    
    // Update summary tab
    const summaryDiv = document.getElementById('matchSummary');
    if (summaryDiv && st.match_result) {
      try {
        const result = st.match_result;
        console.log('DEBUG: Match result data:', result);
        
        // Check multiple possible Man of the Match field names
        let manOfMatch = result.man_of_match || result.player_of_match || result.man_of_the_match || 
                       result.motm || result.MOTM || result.playerOfMatch || null;
        
        console.log('DEBUG: Man of the Match found:', manOfMatch);
        console.log('DEBUG: Man of the Match type:', typeof manOfMatch);
        
        // If it's an object, extract the name
        if (manOfMatch && typeof manOfMatch === 'object') {
          console.log('DEBUG: Man of the Match is object, extracting name...');
          manOfMatch = manOfMatch.name || manOfMatch.player_name || manOfMatch.player || 
                      manOfMatch.fullName || manOfMatch.full_name || JSON.stringify(manOfMatch);
          console.log('DEBUG: Extracted Man of the Match name:', manOfMatch);
        }
        
        // If still not found, try to determine from player stats
        if (!manOfMatch && result.player_of_match && result.player_of_match.name) {
          manOfMatch = result.player_of_match.name;
          console.log('DEBUG: Man of the Match from player_of_match.name:', manOfMatch);
        }
        
        // If still not found, try to determine from top performers
        if (!manOfMatch) {
          // Check if we have top batsmen or bowlers
          if (result.top_batsmen_a && result.top_batsmen_a.length > 0) {
            manOfMatch = result.top_batsmen_a[0].name;
            console.log('DEBUG: Man of the Match from top_batsmen_a:', manOfMatch);
          } else if (result.top_batsmen_b && result.top_batsmen_b.length > 0) {
            manOfMatch = result.top_batsmen_b[0].name;
            console.log('DEBUG: Man of the Match from top_batsmen_b:', manOfMatch);
          } else if (result.top_bowlers_a && result.top_bowlers_a.length > 0) {
            manOfMatch = result.top_bowlers_a[0].name;
            console.log('DEBUG: Man of the Match from top_bowlers_a:', manOfMatch);
          } else if (result.top_bowlers_b && result.top_bowlers_b.length > 0) {
            manOfMatch = result.top_bowlers_b[0].name;
            console.log('DEBUG: Man of the Match from top_bowlers_b:', manOfMatch);
          }
        }
        
        let html = '<div style="margin-bottom:20px">' +
          '<h3>Match Result</h3>' +
          '<p><strong><span style="display:inline-block;width:60px;height:60px;background:linear-gradient(135deg,#e6f2ff,#b3d9ff);border-radius:50%;vertical-align:middle;margin-right:12px;box-shadow:0 4px 8px rgba(30,60,114,0.2);text-align:center;line-height:60px;font-size:30px;">üèÜ</span> Winner:</strong> ' + (result.winner || 'Unknown') + '</p>' +
          '<p><strong>Margin:</strong> ' + (result.margin || 'Unknown') + '</p>' +
          '<p><strong><span style="display:inline-block;width:60px;height:60px;background:linear-gradient(135deg,#e6f2ff,#b3d9ff);border-radius:50%;vertical-align:middle;margin-right:12px;box-shadow:0 4px 8px rgba(30,60,114,0.2);text-align:center;line-height:60px;font-size:30px;">ü•á</span> Man of the Match:</strong> ' + (manOfMatch || 'Not awarded') + '</p>' +
          '</div>';
        
        // Add team performances only if they exist
        if (result.team1 && result.team2) {
          html += '<div style="margin-bottom:20px">' +
            '<h3>Team Performances</h3>' +
            '<p><strong>' + (result.team1.name || 'Team 1') + ':</strong> ' + (result.team1.runs || '0') + '/' + (result.team1.wickets || '0') + ' (' + (result.team1.overs || '0.0') + ' overs)</p>' +
            '<p><strong>' + (result.team2.name || 'Team 2') + ':</strong> ' + (result.team2.runs || '0') + '/' + (result.team2.wickets || '0') + ' (' + (result.team2.overs || '0.0') + ' overs)</p>' +
            '</div>';
        }
        
        summaryDiv.innerHTML = html;
      } catch (e) {
        console.error('Error updating match summary:', e);
        summaryDiv.innerHTML = '<div style="color: #666; padding: 10px;">Loading match summary...</div>';
      }
    } else if (summaryDiv) {
      if (st.summary && st.summary.innings) {
        summaryDiv.innerHTML = '<strong>Innings ' + st.summary.innings + ':</strong> ' + st.summary.batting_team + ' - ' + st.summary.runs + '/' + st.summary.wickets + ' (' + st.summary.overs + ' overs)';
      } else {
        summaryDiv.innerHTML = '<p>Match in progress...</p>';
      }
    }
    
    // Summary ball by ball with innings-wise split using separate divs
    console.log('DEBUG: Summary tab update - Stored data:', {
      first_innings_ballbyball: first_innings_ballbyball.length,
      second_innings_ballbyball: second_innings_ballbyball.length,
      current_innings: st.summary?.innings,
      innings_data: st.innings_data
    });
    
    // Update 1st innings div
    const summaryBallDiv1st = document.getElementById('summaryBallByBall1st');
    console.log('DEBUG: Found 1st innings div:', summaryBallDiv1st);
    if (summaryBallDiv1st) {
      summaryBallDiv1st.innerHTML = '';
      
      if (first_innings_ballbyball.length > 0) {
        console.log('DEBUG: Populating 1st innings with', first_innings_ballbyball.length, 'balls');
        const inningsHeader = document.createElement('div');
        inningsHeader.innerHTML = '<h4 style="color:#2196f3;margin-bottom:10px;">1st Innings Ball by Ball ‚úì COMPLETED</h4>';
        summaryBallDiv1st.appendChild(inningsHeader);
        
        const inningsDiv = document.createElement('div');
        inningsDiv.style.padding = '10px';
        inningsDiv.style.background = '#f8f9fa';
        inningsDiv.style.borderRadius = '5px';
        
        first_innings_ballbyball.forEach(ball => {
          const div = document.createElement('div');
          div.style.padding = '5px 0';
          div.style.borderBottom = '1px solid #eee';
          
          // Get player names
          const batsmanName = ball.batsman ? getPlayerNameWithIcon(ball.batsman, st) : 'Unknown';
          const bowlerName = ball.bowler ? getPlayerNameWithIcon(ball.bowler, st) : 'Unknown';
          
          let ballText = ball.over + '.' + ball.ball + ' - ';
          
          // Check if it's an extra
          if (ball.description && ball.description.toLowerCase().includes('wide')) {
            ballText += 'Wide (' + ball.runs + ' runs) [WIDE] - bowler ' + bowlerName;
            div.style.color = '#d9534f';
            div.style.fontWeight = 'bold';
          } else if (ball.description && ball.description.toLowerCase().includes('no-ball')) {
            ballText += 'No Ball (' + ball.runs + ' runs) [NO-BALL] - bowler ' + bowlerName;
            div.style.color = '#d9534f';
            div.style.fontWeight = 'bold';
          } else if (ball.description && ball.description.toLowerCase().includes('bye')) {
            ballText += 'Bye (' + ball.runs + ' runs) [BYE] - bowler ' + bowlerName;
            div.style.color = '#f0ad4e';
            div.style.fontWeight = 'bold';
          } else if (ball.description && ball.description.toLowerCase().includes('leg')) {
            ballText += 'Leg Bye (' + ball.runs + ' runs) [LEG-BYE] - bowler ' + bowlerName;
            div.style.color = '#f0ad4e';
            div.style.fontWeight = 'bold';
          } else {
            // Normal scoring shot
            ballText += batsmanName + ' scores ' + ball.runs + ' run' + (ball.runs > 1 ? 's' : '') + ' (' + ball.runs + ' runs) - bowler ' + bowlerName;
          }
          
          div.textContent = ballText;
          inningsDiv.appendChild(div);
        });
        
        summaryBallDiv1st.appendChild(inningsDiv);
      } else {
        console.log('DEBUG: No 1st innings data available');
        summaryBallDiv1st.innerHTML = '<div style="color:#666;padding:20px;text-align:center">No 1st innings data available</div>';
      }
    }
    
    // Update 2nd innings div
    const summaryBallDiv2nd = document.getElementById('summaryBallByBall2nd');
    console.log('DEBUG: Found 2nd innings div:', summaryBallDiv2nd);
    if (summaryBallDiv2nd) {
      summaryBallDiv2nd.innerHTML = '';
      
      if (second_innings_ballbyball.length > 0) {
        console.log('DEBUG: Populating 2nd innings with', second_innings_ballbyball.length, 'balls');
        const inningsHeader = document.createElement('div');
        const isSecondInningsComplete = st.summary && st.summary.innings > 2;
        inningsHeader.innerHTML = '<h4 style="color:#2196f3;margin-bottom:10px;">2nd Innings Ball by Ball' + (isSecondInningsComplete ? ' ‚úì COMPLETED' : '') + '</h4>';
        summaryBallDiv2nd.appendChild(inningsHeader);
        
        const inningsDiv = document.createElement('div');
        inningsDiv.style.padding = '10px';
        inningsDiv.style.background = '#f8f9fa';
        inningsDiv.style.borderRadius = '5px';
        
        second_innings_ballbyball.forEach(ball => {
          const div = document.createElement('div');
          div.style.padding = '5px 0';
          div.style.borderBottom = '1px solid #eee';
          
          // Get player names
          const batsmanName = ball.batsman ? getPlayerNameWithIcon(ball.batsman, st) : 'Unknown';
          const bowlerName = ball.bowler ? getPlayerNameWithIcon(ball.bowler, st) : 'Unknown';
          
          let ballText = ball.over + '.' + ball.ball + ' - ';
          
          // Check if it's an extra
          if (ball.description && ball.description.toLowerCase().includes('wide')) {
            ballText += 'Wide (' + ball.runs + ' runs) [WIDE] - bowler ' + bowlerName;
            div.style.color = '#d9534f';
            div.style.fontWeight = 'bold';
          } else if (ball.description && ball.description.toLowerCase().includes('no-ball')) {
            ballText += 'No Ball (' + ball.runs + ' runs) [NO-BALL] - bowler ' + bowlerName;
            div.style.color = '#d9534f';
            div.style.fontWeight = 'bold';
          } else if (ball.description && ball.description.toLowerCase().includes('bye')) {
            ballText += 'Bye (' + ball.runs + ' runs) [BYE] - bowler ' + bowlerName;
            div.style.color = '#f0ad4e';
            div.style.fontWeight = 'bold';
          } else if (ball.description && ball.description.toLowerCase().includes('leg')) {
            ballText += 'Leg Bye (' + ball.runs + ' runs) [LEG-BYE] - bowler ' + bowlerName;
            div.style.color = '#f0ad4e';
            div.style.fontWeight = 'bold';
          } else {
            // Normal scoring shot
            ballText += batsmanName + ' scores ' + ball.runs + ' run' + (ball.runs > 1 ? 's' : '') + ' (' + ball.runs + ' runs) - bowler ' + bowlerName;
          }
          
          div.textContent = ballText;
          inningsDiv.appendChild(div);
        });
        
        summaryBallDiv2nd.appendChild(inningsDiv);
      } else {
        console.log('DEBUG: No 2nd innings data available');
        summaryBallDiv2nd.innerHTML = '<div style="color:#666;padding:20px;text-align:center">No 2nd innings data available</div>';
      }
    }
    
    // Update combined div
    const summaryBallDivCombined = document.getElementById('summaryBallByBallCombined');
    if (summaryBallDivCombined) {
      summaryBallDivCombined.innerHTML = '';
      
      // Show 1st innings in combined view
      if (first_innings_ballbyball.length > 0) {
        const inningsHeader = document.createElement('div');
        inningsHeader.innerHTML = '<h4 style="color:#2196f3;margin:15px 0 10px 0;">1st Innings Ball by Ball ‚úì COMPLETED</h4>';
        summaryBallDivCombined.appendChild(inningsHeader);
        
        const inningsDiv = document.createElement('div');
        inningsDiv.style.marginBottom = '20px';
        inningsDiv.style.padding = '10px';
        inningsDiv.style.background = '#f8f9fa';
        inningsDiv.style.borderRadius = '5px';
        
        first_innings_ballbyball.forEach(ball => {
          const div = document.createElement('div');
          div.style.padding = '5px 0';
          div.style.borderBottom = '1px solid #eee';
          
          // Get player names
          const batsmanName = ball.batsman ? getPlayerNameWithIcon(ball.batsman, st) : 'Unknown';
          const bowlerName = ball.bowler ? getPlayerNameWithIcon(ball.bowler, st) : 'Unknown';
          
          let ballText = ball.over + '.' + ball.ball + ' - ';
          
          // Check if it's an extra
          if (ball.description && ball.description.toLowerCase().includes('wide')) {
            ballText += 'Wide (' + ball.runs + ' runs) [WIDE] - bowler ' + bowlerName;
            div.style.color = '#d9534f';
            div.style.fontWeight = 'bold';
          } else if (ball.description && ball.description.toLowerCase().includes('no-ball')) {
            ballText += 'No Ball (' + ball.runs + ' runs) [NO-BALL] - bowler ' + bowlerName;
            div.style.color = '#d9534f';
            div.style.fontWeight = 'bold';
          } else if (ball.description && ball.description.toLowerCase().includes('bye')) {
            ballText += 'Bye (' + ball.runs + ' runs) [BYE] - bowler ' + bowlerName;
            div.style.color = '#f0ad4e';
            div.style.fontWeight = 'bold';
          } else if (ball.description && ball.description.toLowerCase().includes('leg')) {
            ballText += 'Leg Bye (' + ball.runs + ' runs) [LEG-BYE] - bowler ' + bowlerName;
            div.style.color = '#f0ad4e';
            div.style.fontWeight = 'bold';
          } else {
            // Normal scoring shot
            ballText += batsmanName + ' scores ' + ball.runs + ' run' + (ball.runs > 1 ? 's' : '') + ' (' + ball.runs + ' runs) - bowler ' + bowlerName;
          }
          
          div.textContent = ballText;
          inningsDiv.appendChild(div);
        });
        
        summaryBallDivCombined.appendChild(inningsDiv);
      }
      
      // Show 2nd innings in combined view
      if (second_innings_ballbyball.length > 0) {
        const inningsHeader = document.createElement('div');
        const isSecondInningsComplete = st.summary && st.summary.innings > 2;
        inningsHeader.innerHTML = '<h4 style="color:#2196f3;margin:15px 0 10px 0;">2nd Innings Ball by Ball' + (isSecondInningsComplete ? ' ‚úì COMPLETED' : '') + '</h4>';
        summaryBallDivCombined.appendChild(inningsHeader);
        
        const inningsDiv = document.createElement('div');
        inningsDiv.style.padding = '10px';
        inningsDiv.style.background = '#f8f9fa';
        inningsDiv.style.borderRadius = '5px';
        
        second_innings_ballbyball.forEach(ball => {
          const div = document.createElement('div');
          div.style.padding = '5px 0';
          div.style.borderBottom = '1px solid #eee';
          
          // Get player names
          const batsmanName = ball.batsman ? getPlayerNameWithIcon(ball.batsman, st) : 'Unknown';
          const bowlerName = ball.bowler ? getPlayerNameWithIcon(ball.bowler, st) : 'Unknown';
          
          let ballText = ball.over + '.' + ball.ball + ' - ';
          
          // Check if it's an extra
          if (ball.description && ball.description.toLowerCase().includes('wide')) {
            ballText += 'Wide (' + ball.runs + ' runs) [WIDE] - bowler ' + bowlerName;
            div.style.color = '#d9534f';
            div.style.fontWeight = 'bold';
          } else if (ball.description && ball.description.toLowerCase().includes('no-ball')) {
            ballText += 'No Ball (' + ball.runs + ' runs) [NO-BALL] - bowler ' + bowlerName;
            div.style.color = '#d9534f';
            div.style.fontWeight = 'bold';
          } else if (ball.description && ball.description.toLowerCase().includes('bye')) {
            ballText += 'Bye (' + ball.runs + ' runs) [BYE] - bowler ' + bowlerName;
            div.style.color = '#f0ad4e';
            div.style.fontWeight = 'bold';
          } else if (ball.description && ball.description.toLowerCase().includes('leg')) {
            ballText += 'Leg Bye (' + ball.runs + ' runs) [LEG-BYE] - bowler ' + bowlerName;
            div.style.color = '#f0ad4e';
            div.style.fontWeight = 'bold';
          } else {
            // Normal scoring shot
            ballText += batsmanName + ' scores ' + ball.runs + ' run' + (ball.runs > 1 ? 's' : '') + ' (' + ball.runs + ' runs) - bowler ' + bowlerName;
          }
          
          div.textContent = ballText;
          inningsDiv.appendChild(div);
        });
        
        summaryBallDivCombined.appendChild(inningsDiv);
      }
      
      if (first_innings_ballbyball.length === 0 && second_innings_ballbyball.length === 0) {
        summaryBallDivCombined.innerHTML = '<div style="color:#666;padding:20px;text-align:center">No innings data available</div>';
      }
    }
    
    // Store innings data when available (for persistence)
    // Store from current ball data if innings_data is not available
    if (!st.innings_data && balls && balls.length > 0) {
      // Determine current innings and store accordingly
      const currentInnings = st.summary?.innings || 1;
      
      if (currentInnings === 1 && (first_innings_ballbyball.length === 0 || balls.length > first_innings_ballbyball.length)) {
        first_innings_ballbyball = [...balls];
        console.log('DEBUG: Stored 1st innings from current balls:', first_innings_ballbyball.length, 'balls');
      } else if (currentInnings === 2 && (second_innings_ballbyball.length === 0 || balls.length > second_innings_ballbyball.length)) {
        second_innings_ballbyball = [...balls];
        console.log('DEBUG: Stored 2nd innings from current balls:', second_innings_ballbyball.length, 'balls');
      }
    }
    
    // Also try to store from innings_data if available
    if (st.innings_data && st.innings_data['1'] && st.innings_data['1'].ball_by_ball) {
      if (first_innings_ballbyball.length === 0 || st.innings_data['1'].ball_by_ball.length > first_innings_ballbyball.length) {
        first_innings_ballbyball = [...st.innings_data['1'].ball_by_ball];
        console.log('DEBUG: Stored 1st innings from innings_data:', first_innings_ballbyball.length, 'balls');
      }
    }
    
    if (st.innings_data && st.innings_data['2'] && st.innings_data['2'].ball_by_ball) {
      if (second_innings_ballbyball.length === 0 || st.innings_data['2'].ball_by_ball.length > second_innings_ballbyball.length) {
        second_innings_ballbyball = [...st.innings_data['2'].ball_by_ball];
        console.log('DEBUG: Stored 2nd innings from innings_data:', second_innings_ballbyball.length, 'balls');
      }
    }
    
    // Check if innings is complete
    if (st.innings_complete) {
      const playersPerTeam = parseInt(document.getElementById('playersPerTeam').value) || 11;
      const msg = st.summary.innings === 1 ? 'First innings complete! Setting up 2nd innings...' : 'Match completed!';
      const liveErrorEl = document.getElementById('liveError');
      if (liveErrorEl) liveErrorEl.textContent = msg;
      
      // Show switch innings button for first innings
      const switchInningsDiv = document.getElementById('switchInningsDiv');
      if (switchInningsDiv) {
        switchInningsDiv.style.display = st.summary.innings === 1 ? 'block' : 'none';
      }
      
      if (st.summary.innings === 1) {
        // Only show popup if innings is actually complete AND no active scoring
        if (st.innings_complete && !st.match_complete) {
          // Double-check that we're not in the middle of scoring
          const currentBall = st.current_ball || 0;
          const currentOver = st.current_over || 0;
          const maxOvers = st.max_overs || 0;
          const allWickets = st.wickets || 0;
          const maxWickets = (st.batting_players && st.batting_players.length) || 11;
          
          // More flexible completion check
          let isOversComplete = false;
          if (maxOvers > 0) {
            // Check if overs are complete when max overs is set
            isOversComplete = currentOver > maxOvers || (currentOver >= maxOvers && currentBall === 0);
          } else {
            // If no max overs set, consider overs incomplete (rely on wickets)
            isOversComplete = false;
          }
          
          const isAllWickets = allWickets >= (maxWickets - 1); // All but one wicket
          
          console.log('Innings completion check:', {
            currentOver, currentBall, maxOvers, allWickets, maxWickets,
            isOversComplete, isAllWickets, innings_complete: st.innings_complete
          });
          
          // Show popup if innings is marked complete by backend OR our checks pass
          if (st.innings_complete || isOversComplete || isAllWickets) {
            console.log('Innings truly complete, switching to switch innings tab');
            
            // Switch to the switch innings tab
            const switchTab = document.getElementById('switchTab');
            if (switchTab) {
              switchTab.click();
            }
            
            // Show tooltip after a short delay
            setTimeout(() => {
              showSwitchInningsTooltip();
            }, 500);
          } else {
            console.log('Innings not actually complete yet, not showing popup');
          }
        }
      }
    } else {
      // Hide switch innings button when innings not complete
      const switchInningsDiv = document.getElementById('switchInningsDiv');
      if (switchInningsDiv) {
        switchInningsDiv.style.display = 'none';
      }
    }
  } else {
    const tabsEl = document.getElementById('tabs');
    const matchSettingsTabEl = document.getElementById('matchSettingsTab');
    const matchTabEl = document.getElementById('matchTab');
    const scoreboardTabEl = document.getElementById('scoreboardTab');
    const summaryTabEl = document.getElementById('summaryTab');
    
    if (tabsEl) tabsEl.style.display = 'none';
    if (matchSettingsTabEl) matchSettingsTabEl.style.display = 'block';
    if (matchTabEl) matchTabEl.style.display = 'none';
    if (scoreboardTabEl) scoreboardTabEl.style.display = 'none';
    if (summaryTabEl) summaryTabEl.style.display = 'none';
  }
  
  // Update scoreboard tab if started
  if (st.started) {
    updateScoreboard(st);
  }
  
  // Check if innings is complete and handle accordingly
  if (st.innings_complete && !st.match_complete) {
    disableScoringForInningsComplete();
    // Show switch innings popup for first innings completion
    if (st.summary && st.summary.innings === 1) {
      showSwitchInningsPopup();
    }
  } else if (!st.innings_complete && !st.match_complete) {
    // Enable scoring controls if innings is not complete
    enableScoringControls();
  }
  
  // Check if match is complete and disable controls
  if (st.match_complete) {
    console.log('DEBUG: Match complete detected in refresh - match_complete:', st.match_complete);
    console.log('DEBUG: Match winner in refresh:', st.match_winner);
    disableScoringControls();
    
    // Update download button for completed match
    updateDownloadButton(st);
    
    // Show winner in Match tab
    const matchWinnerLine = document.getElementById('matchWinnerLine');
    if (matchWinnerLine && st.match_winner) {
      matchWinnerLine.innerHTML = `üèÜ Winner: ${st.match_winner}`;
      matchWinnerLine.style.display = 'block';
    }
    
    // Show winner in Scoreboard tab
    const scoreboardWinnerLine = document.getElementById('scoreboardWinnerLine');
    if (scoreboardWinnerLine && st.match_winner) {
      scoreboardWinnerLine.innerHTML = `üèÜ Winner: ${st.match_winner}`;
      scoreboardWinnerLine.style.display = 'block';
    }
    
    // Show victory popup if match is complete and winner exists
    if (st.match_winner) {
      console.log('DEBUG: Showing victory popup from refresh - Winner:', st.match_winner);
      showVictoryPopup(st.match_winner);
    }
  } else if (st.started && !st.match_complete) {
    // Update download button when match starts (but not completed)
    updateDownloadButton(st);
  }
}

// Store innings data permanently (global variables)
let first_innings_ballbyball = [];
let second_innings_ballbyball = [];
let victoryPopupShown = false; // Prevent infinite loop

function getPlayerRoleIcon(playerRole) {
  if (!playerRole) return '';
  
  const role = playerRole.toLowerCase();
  let icon = '';
  
  // Handle dual roles (captain + other role)
  if (role.includes('captain')) {
    if (role.includes('bowler')) {
      icon = ' üß¢‚öæ';
    } else if (role.includes('batsman')) {
      icon = ' üß¢üèè';
    } else if (role.includes('all-rounder') || role.includes('all rounder')) {
      icon = ' üß¢üèè‚öæ';
    } else if (role.includes('wicket-keeper') || role.includes('wicket keeper')) {
      icon = ' üß¢üß§';
    } else {
      icon = ' üß¢'; // Just captain
    }
  } else {
    // Single roles (non-captain)
    switch(role) {
      case 'bowler':
        icon = ' ‚öæ';
        break;
      case 'batsman':
        icon = ' üèè';
        break;
      case 'all-rounder':
      case 'all rounder':
        icon = ' üèè‚öæ';
        break;
      case 'wicket-keeper':
      case 'wicket keeper':
        icon = ' üß§';
        break;
      default:
        icon = '';
    }
  }
  
  return icon;
}

// Function to get player name with role icon
function getPlayerNameWithIcon(playerId, state) {
  const currentState = state || st;
  let playerName = 'Unknown';
  let playerRole = '';
  
  // Check batting players
  if (currentState.batting_players) {
    const battingPlayer = currentState.batting_players.find(p => p.id === playerId);
    if (battingPlayer) {
      playerName = battingPlayer.name;
      playerRole = battingPlayer.role || '';
    }
  }
  
  // Check bowling players
  if (currentState.bowling_players) {
    const bowlingPlayer = currentState.bowling_players.find(p => p.id === playerId);
    if (bowlingPlayer) {
      playerName = bowlingPlayer.name;
      playerRole = bowlingPlayer.role || '';
    }
  }
  
  const roleIcon = getPlayerRoleIcon(playerRole);
  return playerName + roleIcon;
}

// Function to get player name by ID
function getPlayerNameById(playerId, players) {
  if (!players || !playerId) return 'Unknown';
  const player = players.find(p => p.id === playerId);
  return player ? player.name : 'Unknown';
}

// Function to get player name from state
function getPlayerName(playerId, state) {
  const currentState = state || st;
  // Check batting players
  if (currentState.batting_players) {
    const battingPlayer = currentState.batting_players.find(p => p.id === playerId);
    if (battingPlayer) return battingPlayer.name;
  }
  
  // Check bowling players
  if (currentState.bowling_players) {
    const bowlingPlayer = currentState.bowling_players.find(p => p.id === playerId);
    if (bowlingPlayer) return bowlingPlayer.name;
  }
  
  return 'Unknown';
}

// Function to switch between summary innings tabs
function showSummaryInningsTab(tabNumber) {
  // Hide all content divs
  document.getElementById('summaryInnings1Content').style.display = 'none';
  document.getElementById('summaryInnings2Content').style.display = 'none';
  document.getElementById('summaryCombinedContent').style.display = 'none';
  
  // Reset all tab buttons
  document.getElementById('summaryInnings1Tab').style.background = '#f0f0f0';
  document.getElementById('summaryInnings1Tab').style.color = 'black';
  document.getElementById('summaryInnings2Tab').style.background = '#f0f0f0';
  document.getElementById('summaryInnings2Tab').style.color = 'black';
  document.getElementById('summaryCombinedTab').style.background = '#f0f0f0';
  document.getElementById('summaryCombinedTab').style.color = 'black';
  
  // Show selected tab and highlight button
  if (tabNumber === 1) {
    document.getElementById('summaryInnings1Content').style.display = 'block';
    document.getElementById('summaryInnings1Tab').style.background = '#2196f3';
    document.getElementById('summaryInnings1Tab').style.color = 'white';
  } else if (tabNumber === 2) {
    document.getElementById('summaryInnings2Content').style.display = 'block';
    document.getElementById('summaryInnings2Tab').style.background = '#2196f3';
    document.getElementById('summaryInnings2Tab').style.color = 'white';
  } else {
    document.getElementById('summaryCombinedContent').style.display = 'block';
    document.getElementById('summaryCombinedTab').style.background = '#2196f3';
    document.getElementById('summaryCombinedTab').style.color = 'white';
  }
}

function updateScoreboard(st) {
  console.log('DEBUG: updateScoreboard called with state:', st);
  
  // Store innings data when available
  if (st.innings_data && st.innings_data['1'] && st.innings_data['1'].ball_by_ball) {
    if (first_innings_ballbyball.length === 0 || st.innings_data['1'].ball_by_ball.length > first_innings_ballbyball.length) {
      first_innings_ballbyball = [...st.innings_data['1'].ball_by_ball];
      console.log('DEBUG: Stored 1st innings ball data:', first_innings_ballbyball.length, 'balls');
    }
  }
  
  if (st.innings_data && st.innings_data['2'] && st.innings_data['2'].ball_by_ball) {
    if (second_innings_ballbyball.length === 0 || st.innings_data['2'].ball_by_ball.length > second_innings_ballbyball.length) {
      second_innings_ballbyball = [...st.innings_data['2'].ball_by_ball];
      console.log('DEBUG: Stored 2nd innings ball data:', second_innings_ballbyball.length, 'balls');
    }
  }
  
  const scoreboardDiv = document.getElementById('teamScoreboard');
  if (!scoreboardDiv) return;
  
  let html = '';
  
  // Get team names
  const firstInningsTeam = st.team_a_name;
  const secondInningsTeam = firstInningsTeam === st.team_a_name ? st.team_b_name : st.team_a_name;
  const isFirstInningsComplete = st.summary && st.summary.innings === 1;
  const isSecondInnings = st.summary && st.summary.innings === 2;
  
  // Create innings tabs
  html += '<div style="margin-bottom:20px">';
  html += '<div style="display:flex;border-bottom:2px solid #ddd;margin-bottom:20px">';
  html += '<button id="innings1Tab" onclick="showInningsTab(1)" style="padding:10px 20px;border:none;background:' + (isFirstInningsComplete || !isSecondInnings ? '#2196f3' : '#f0f0f0') + ';color:' + (isFirstInningsComplete || !isSecondInnings ? 'white' : 'black') + ';cursor:pointer;border-radius:5px 5px 0 0;font-weight:bold">1st Innings</button>';
  if (isSecondInnings || isFirstInningsComplete) {
    html += '<button id="innings2Tab" onclick="showInningsTab(2)" style="padding:10px 20px;border:none;background:' + (isSecondInnings ? '#2196f3' : '#f0f0f0') + ';color:' + (isSecondInnings ? 'white' : 'black') + ';cursor:pointer;border-radius:5px 5px 0 0;font-weight:bold;margin-left:5px">2nd Innings</button>';
  }
  html += '</div>';
  
  // 1st Innings Content
  html += '<div id="innings1Content" style="display:' + (isFirstInningsComplete || !isSecondInnings ? 'block' : 'none') + '">';
  html += createInningsCard(st, firstInningsTeam, 1);
  html += '</div>';
  
  // 2nd Innings Content
  if (isSecondInnings || isFirstInningsComplete) {
    html += '<div id="innings2Content" style="display:' + (isSecondInnings ? 'block' : 'none') + '">';
    html += createInningsCard(st, secondInningsTeam, 2);
    html += '</div>';
  }
  
  html += '</div>';
  
  scoreboardDiv.innerHTML = html;
}

function createInningsCard(st, battingTeam, inningsNumber) {
  let html = '<div style="background:white;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:20px;margin-bottom:20px">';
  html += '<h2 style="color:#2196f3;margin-bottom:15px">' + inningsNumber + (inningsNumber === 1 ? 'st' : 'nd') + ' Innings - ' + battingTeam + '</h2>';
  
  // Get batting and bowling teams
  const battingPlayers = battingTeam === st.team_a_name ? st.team_a_players : st.team_b_players;
  const bowlingPlayers = battingTeam === st.team_a_name ? st.team_b_players : st.team_a_players;
  const bowlingTeam = battingTeam === st.team_a_name ? st.team_b_name : st.team_a_name;
  
  // Batting Scorecard
  html += '<h3 style="color:#333;margin-bottom:10px">Batting Scorecard</h3>';
  
  // Calculate batting runs (only from batsmen, not extras)
  const teamRuns = battingPlayers.reduce((sum, p) => sum + (p.batting_runs || 0), 0);
  
  // Debug: Log batting runs calculation
  console.log('DEBUG: Batting runs calculation:', {
    battingPlayers: battingPlayers?.map(p => ({
      name: p.name,
      batting_runs: p.batting_runs,
      dismissal: p.dismissal
    })),
    calculatedTeamRuns: teamRuns
  });
  
  // Calculate team total and extras from available data
  let teamExtras = 0;
  let teamTotal = teamRuns;
  
  // Debug: Log available data to understand structure
  console.log('DEBUG: Scoreboard data check for innings', inningsNumber, ':', {
    summary: st.summary,
    summary_extras: st.summary?.extras,
    global_extras: st.extras,
    bowling_players: bowlingPlayers?.map(p => ({
      name: p.name,
      bowling_wides: p.bowling_wides,
      bowling_no_balls: p.bowling_no_balls
    }))
  });
  
  // Calculate extras from innings-specific ball-by-ball data (most reliable)
  let ballDataToUse = [];
  
  // Try to get ball data from stored innings data first
  if (inningsNumber === 1 && first_innings_ballbyball.length > 0) {
    ballDataToUse = first_innings_ballbyball;
    console.log('DEBUG: Using stored 1st innings ball data:', ballDataToUse.length, 'balls');
  } else if (inningsNumber === 2 && second_innings_ballbyball.length > 0) {
    ballDataToUse = second_innings_ballbyball;
    console.log('DEBUG: Using stored 2nd innings ball data:', ballDataToUse.length, 'balls');
  } else if (st.innings_data && st.innings_data[inningsNumber] && st.innings_data[inningsNumber].ball_by_ball) {
    ballDataToUse = st.innings_data[inningsNumber].ball_by_ball;
    console.log('DEBUG: Using innings-specific ball data for innings', inningsNumber, ':', ballDataToUse.length, 'balls');
    console.log('DEBUG: Innings ball data sample:', ballDataToUse.slice(0, 5).map(b => ({
      runs: b.runs,
      description: b.description,
      batsman_id: b.batsman_id
    })));
  } else if (st.ball_by_ball && Array.isArray(st.ball_by_ball)) {
    ballDataToUse = st.ball_by_ball;
    console.log('DEBUG: Using global ball data:', ballDataToUse.length, 'balls');
  } else {
    console.log('DEBUG: No ball data found for innings', inningsNumber);
  }
  
  if (ballDataToUse.length > 0) {
    let calculatedExtras = 0;
    ballDataToUse.forEach(ball => {
      if (ball.description && ball.description.toLowerCase().includes('wide')) {
        calculatedExtras += ball.runs || 1;
      } else if (ball.description && ball.description.toLowerCase().includes('no-ball')) {
        calculatedExtras += ball.runs || 1;
      } else if (ball.description && ball.description.toLowerCase().includes('bye')) {
        calculatedExtras += ball.runs || 1;
      } else if (ball.description && ball.description.toLowerCase().includes('leg')) {
        calculatedExtras += ball.runs || 1;
      }
    });
    teamExtras = calculatedExtras;
    teamTotal = teamRuns + teamExtras;
    console.log('DEBUG: Calculated extras from ball-by-ball:', { teamExtras, teamTotal });
  } else if (st.summary && st.summary.extras) {
    // Calculate extras from summary data
    const extras = st.summary.extras;
    teamExtras = (extras.wide || 0) + (extras.no_ball || 0) + (extras.bye || 0) + (extras.leg_bye || 0);
    teamTotal = st.summary.runs || (teamRuns + teamExtras);
    console.log('DEBUG: Using summary extras:', { teamExtras, teamTotal, summary_runs: st.summary.runs });
  } else if (st.extras) {
    // Use global extras if available
    const extras = st.extras;
    teamExtras = (extras.wide || 0) + (extras.no_ball || 0) + (extras.bye || 0) + (extras.leg_bye || 0);
    teamTotal = teamRuns + teamExtras;
    console.log('DEBUG: Using global extras:', { teamExtras, teamTotal });
  } else {
    // Calculate extras from bowling players (wides, no-balls)
    let calculatedExtras = 0;
    if (bowlingPlayers) {
      bowlingPlayers.forEach(bowler => {
        calculatedExtras += (bowler.bowling_wides || 0) + (bowler.bowling_no_balls || 0);
      });
    }
    teamExtras = calculatedExtras;
    teamTotal = teamRuns + teamExtras;
    console.log('DEBUG: Calculated extras from bowlers:', { teamExtras, teamTotal });
  }
  
  // Get innings-specific data for display
  let inningsSummary = null;
  if (st.innings_data && st.innings_data[inningsNumber]) {
    inningsSummary = st.innings_data[inningsNumber];
  } else if (st.summary) {
    // Use summary data as fallback
    inningsSummary = st.summary;
  }
  
  // Team total card
  html += '<div style="margin-bottom:15px;padding:15px;background:#e8f4fd;border-radius:6px;border-left:4px solid #2196f3">';
  html += '<strong style="font-size:18px">Total: ' + teamTotal + '/' + (inningsSummary?.wickets || battingPlayers.filter(p => p.dismissal).length) + '</strong><br>';
  html += '<small>Batting: ' + teamRuns + ' + Extras: ' + teamExtras + ' = ' + teamTotal;
  if (inningsSummary?.overs) {
    html += ' (' + inningsSummary.overs + ' overs)';
  }
  html += '</small></div>';
  
  // Extras breakdown
  if (teamExtras > 0 && inningsSummary?.extras) {
    const extras = inningsSummary.extras;
    html += '<div style="margin-bottom:15px;padding:10px;background:#f5f5f5;border-radius:4px">';
    html += '<small>Extras: ' + extras.total + ' (Wides: ' + (extras.wides || 0) + ', No-balls: ' + (extras.no_balls || 0) + ', Byes: ' + (extras.byes || 0) + ', Leg-byes: ' + (extras.leg_byes || 0) + ')</small>';
    html += '</div>';
  }
  
  // Batting table
  html += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px">';
  html += '<tr style="background:#f0f0f0"><th style="padding:10px;border:1px solid #ddd;text-align:left">Player</th><th style="padding:10px;border:1px solid #ddd;text-align:left">Runs</th><th style="padding:10px;border:1px solid #ddd;text-align:left">Balls</th><th style="padding:10px;border:1px solid #ddd;text-align:left">SR</th><th style="padding:10px;border:1px solid #ddd;text-align:left">How Out</th></tr>';
  
  battingPlayers.forEach((player, index) => {
    const bg = index % 2 === 0 ? '#fff' : '#f9f9f9';
    const runs = player.batting_runs || 0;
    const balls = player.batting_balls || 0;
    const sr = balls > 0 ? ((runs / balls) * 100).toFixed(1) : '0.0';
    
    // Format dismissal
    let howOut = 'batting';
    if (player.dismissal) {
      const d = player.dismissal;
      if (d.type === 'Caught' && d.catcher && d.bowler) {
        howOut = 'Caught ' + d.catcher + ', Bowler ' + d.bowler;
      } else if (d.type === 'Bowled' && d.bowler) {
        howOut = 'Bowler ' + d.bowler;
      } else if (d.type === 'Run Out' && d.runout_by && d.runout_by.length > 0) {
        howOut = 'Run Out (' + d.runout_by.join(', ') + ')';
      } else if (d.type === 'Lbw' && d.bowler) {
        howOut = 'LBW, Bowler ' + d.bowler;
      } else if (d.type === 'Stumped' && d.catcher && d.bowler) {
        howOut = 'Stumped ' + d.catcher + ', Bowler ' + d.bowler;
      } else if (d.type === 'Hit Wicket' && d.bowler) {
        howOut = 'Hit Wicket, Bowler ' + d.bowler;
      } else {
        howOut = d.type;
      }
    }
    
    // Check if player is captain
    const isCaptain = (battingTeam === st.team_a_name && st.team_a_captain === player.name) || 
                     (battingTeam === st.team_b_name && st.team_b_captain === player.name);
    
    html += '<tr style="background:' + bg + '">' +
      '<td style="padding:10px;border:1px solid #ddd;font-weight:bold">' + (player.name || 'Unknown') + getPlayerRoleIcon(player.role) + (isCaptain ? ' üß¢' : '') + '</td>' +
      '<td style="padding:10px;border:1px solid #ddd">' + runs + '</td>' +
      '<td style="padding:10px;border:1px solid #ddd">' + balls + '</td>' +
      '<td style="padding:10px;border:1px solid #ddd">' + sr + '</td>' +
      '<td style="padding:10px;border:1px solid #ddd">' + howOut + '</td>' +
    '</tr>';
  });
  html += '</table>';
  
  // Bowling Figures
  html += '<h3 style="color:#333;margin-bottom:10px">Bowling Figures</h3>';
  html += '<table style="width:100%;border-collapse:collapse">';
  html += '<tr style="background:#f0f0f0"><th style="padding:10px;border:1px solid #ddd;text-align:left">Bowler</th><th style="padding:10px;border:1px solid #ddd;text-align:left">Overs</th><th style="padding:10px;border:1px solid #ddd;text-align:left">Runs</th><th style="padding:10px;border:1px solid #ddd;text-align:left">Extras</th><th style="padding:10px;border:1px solid #ddd;text-align:left">Total</th><th style="padding:10px;border:1px solid #ddd;text-align:left">Wickets</th><th style="padding:10px;border:1px solid #ddd;text-align:left">Economy</th></tr>';
  
  bowlingPlayers.forEach((bowler, index) => {
    const bg = index % 2 === 0 ? '#fff' : '#f9f9f9';
    const overs = bowler.bowling_overs || '0.0';
    const runs = bowler.bowling_runs || 0;
    const wickets = bowler.bowling_wickets || 0;
    const economy = bowler.bowling_economy || '0.0';
    
    // Debug: Log bowler stats
    console.log('DEBUG: Bowler stats for', bowler.name, ':', {
      bowling_overs: overs,
      bowling_runs: runs,
      bowling_wickets: wickets,
      bowling_economy: economy,
      bowling_wides: bowler.bowling_wides,
      bowling_no_balls: bowler.bowling_no_balls
    });
    
    // Calculate actual runs from ball data (more accurate)
    let actualBowlerRuns = 0;
    let bowlerWides = 0;
    let bowlerNoBalls = 0;
    let bowlerWidesRuns = 0;
    let bowlerNoBallsRuns = 0;
    let legalDeliveries = 0;
    
    if (ballDataToUse && ballDataToUse.length > 0) {
      ballDataToUse.forEach(ball => {
        if (ball.bowler === bowler.id) {
          // Count wides and no-balls for display
          if (ball.description && ball.description.toLowerCase().includes('wide')) {
            bowlerWides++;
            bowlerWidesRuns += ball.runs || 0;
          } else if (ball.description && ball.description.toLowerCase().includes('no-ball')) {
            bowlerNoBalls++;
            bowlerNoBallsRuns += ball.runs || 0;
          } else {
            // Only count runs from legal deliveries (batsman runs)
            actualBowlerRuns += ball.runs || 0;
            legalDeliveries++;
          }
        }
      });
    }
    
    console.log('DEBUG: Actual bowling calculations for', bowler.name, ':', {
      actualBowlerRuns,
      bowlerWides,
      bowlerNoBalls,
      bowlerWidesRuns,
      bowlerNoBallsRuns,
      legalDeliveries
    });
    
    // Use actual calculated runs (batsman runs only)
    const batsmanRunsOnly = actualBowlerRuns;
    
    // Calculate total runs conceded by bowler (batsman runs + wides + no-balls)
    const totalRuns = actualBowlerRuns + bowlerWidesRuns + bowlerNoBallsRuns;
    
    // Format extras display
    const extrasDisplay = (bowlerWides > 0 ? bowlerWides + 'W' : '') + 
                       (bowlerNoBalls > 0 ? (bowlerWides > 0 ? '+' : '') + bowlerNoBalls + 'NB' : '') ||
                       '0';
    
    // Calculate overs from legal deliveries only (6 legal balls = 1 over)
    let actualOvers = overs;
    if (ballDataToUse && ballDataToUse.length > 0) {
      const wholeOvers = Math.floor(legalDeliveries / 6);
      const remainingBalls = legalDeliveries % 6;
      actualOvers = wholeOvers + '.' + remainingBalls;
    }
    
    // Calculate economy based on actual runs and overs
    let calculatedEconomy = 0;
    if (typeof actualOvers === 'number' && actualOvers > 0) {
      calculatedEconomy = totalRuns / actualOvers;
    } else if (typeof actualOvers === 'string') {
      const [wholeOvers, balls] = actualOvers.split('.').map(Number);
      const totalOversDecimal = wholeOvers + (balls || 0) / 6;
      if (totalOversDecimal > 0) {
        calculatedEconomy = totalRuns / totalOversDecimal;
      }
    }
    
    // Format economy to 2 decimal places
    const formattedEconomy = typeof calculatedEconomy === 'number' ? calculatedEconomy.toFixed(2) : calculatedEconomy;
    
    // Check if bowler is captain
    const isBowlerCaptain = (bowlingTeam === st.team_a_name && st.team_a_captain === bowler.name) || 
                           (bowlingTeam === st.team_b_name && st.team_b_captain === bowler.name);
    
    html += '<tr style="background:' + bg + '">' +
      '<td style="padding:10px;border:1px solid #ddd;font-weight:bold">' + (bowler.name || 'Unknown') + getPlayerRoleIcon(bowler.role) + (isBowlerCaptain ? ' üèÜ' : '') + '</td>' +
      '<td style="padding:10px;border:1px solid #ddd">' + actualOvers + '</td>' +
      '<td style="padding:10px;border:1px solid #ddd">' + batsmanRunsOnly + '</td>' +
      '<td style="padding:10px;border:1px solid #ddd;color:#d9534f;font-weight:bold">' + extrasDisplay + '</td>' +
      '<td style="padding:10px;border:1px solid #ddd;color:#2196f3;font-weight:bold">' + totalRuns + '</td>' +
      '<td style="padding:10px;border:1px solid #ddd">' + wickets + '</td>' +
      '<td style="padding:10px;border:1px solid #ddd">' + formattedEconomy + '</td>' +
      '</tr>';
  });
  html += '</table>';
  
  html += '</div>';
  return html;
}

function createTopPerformersSection(st) {
  let html = '<div style="background:white;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:20px">';
  html += '<h2 style="color:#2196f3;margin-bottom:15px">Top Performers</h2>';
  
  // Debug: Log available data
  console.log('DEBUG: Top Performers data check:', {
    top_batsmen_a: st.top_batsmen_a,
    top_batsmen_b: st.top_batsmen_b,
    top_bowlers_a: st.top_bowlers_a,
    top_bowlers_b: st.top_bowlers_b,
    team_a_players: st.team_a_players,
    team_b_players: st.team_b_players
  });
  
  // Top Batsmen - Try multiple possible field names
  let topBatsmenA = st.top_batsmen_a || st.topBatsmenA || [];
  let topBatsmenB = st.top_batsmen_b || st.topBatsmenB || [];
  
  // If no top batsmen data, create from team players
  if (topBatsmenA.length === 0 && st.team_a_players) {
    topBatsmenA = st.team_a_players
      .filter(p => p.batting_runs > 0)
      .sort((a, b) => (b.batting_runs || 0) - (a.batting_runs || 0))
      .slice(0, 3);
  }
  
  if (topBatsmenB.length === 0 && st.team_b_players) {
    topBatsmenB = st.team_b_players
      .filter(p => p.batting_runs > 0)
      .sort((a, b) => (b.batting_runs || 0) - (a.batting_runs || 0))
      .slice(0, 3);
  }
  
  // Display Team A batsmen
  if (topBatsmenA && topBatsmenA.length > 0) {
    html += '<h3 style="color:#333;margin-bottom:10px">Top Batsmen - ' + st.team_a_name + '</h3>';
    topBatsmenA.forEach((batsman, index) => {
      html += '<div style="padding:10px;background:#f8f9fa;border-radius:4px;margin-bottom:5px">';
      html += '<strong>' + batsman.name + '</strong>: ' + (batsman.batting_runs || batsman.runs || 0) + ' runs (' + (batsman.batting_balls || batsman.balls || 0) + ' balls, SR: ' + (batsman.strike_rate || '0.0') + ')';
      html += '</div>';
    });
  }
  
  // Display Team B batsmen
  if (topBatsmenB && topBatsmenB.length > 0) {
    html += '<h3 style="color:#333;margin-bottom:10px">Top Batsmen - ' + st.team_b_name + '</h3>';
    topBatsmenB.forEach((batsman, index) => {
      html += '<div style="padding:10px;background:#f8f9fa;border-radius:4px;margin-bottom:5px">';
      html += '<strong>' + batsman.name + '</strong>: ' + (batsman.batting_runs || batsman.runs || 0) + ' runs (' + (batsman.batting_balls || batsman.balls || 0) + ' balls, SR: ' + (batsman.strike_rate || '0.0') + ')';
      html += '</div>';
    });
  }
  
  // Top Bowlers - Try multiple possible field names
  let topBowlersA = st.top_bowlers_a || st.topBowlersA || [];
  let topBowlersB = st.top_bowlers_b || st.topBowlersB || [];
  
  // If no top bowlers data, create from team players
  if (topBowlersA.length === 0 && st.team_a_players) {
    topBowlersA = st.team_a_players
      .filter(p => p.bowling_wickets > 0)
      .sort((a, b) => (b.bowling_wickets || 0) - (a.bowling_wickets || 0))
      .slice(0, 3);
  }
  
  if (topBowlersB.length === 0 && st.team_b_players) {
    topBowlersB = st.team_b_players
      .filter(p => p.bowling_wickets > 0)
      .sort((a, b) => (b.bowling_wickets || 0) - (a.bowling_wickets || 0))
      .slice(0, 3);
  }
  
  // Display Team A bowlers
  if (topBowlersA && topBowlersA.length > 0) {
    html += '<h3 style="color:#333;margin-bottom:10px">Top Bowlers - ' + st.team_a_name + '</h3>';
    topBowlersA.forEach((bowler, index) => {
      const overs = bowler.bowling_overs || bowler.overs || '0.0';
      const economy = bowler.bowling_economy || bowler.economy || '0.0';
      
      // Convert overs to cricket notation (overs.balls format)
      let formattedOvers = overs;
      if (typeof overs === 'number') {
        const totalBalls = Math.round(overs * 6); // Convert decimal overs back to total balls
        const wholeOvers = Math.floor(totalBalls / 6);
        const remainingBalls = totalBalls % 6;
        formattedOvers = wholeOvers + '.' + remainingBalls;
      }
      
      // Format economy to 2 decimal places
      const formattedEconomy = typeof economy === 'number' ? economy.toFixed(2) : economy;
      
      html += '<div style="padding:10px;background:#f8f9fa;border-radius:4px;margin-bottom:5px">';
      html += '<strong>' + bowler.name + '</strong>: ' + (bowler.bowling_wickets || bowler.wickets || 0) + '/' + (bowler.bowling_runs || bowler.runs || 0) + ' (' + formattedOvers + ' overs, Economy: ' + formattedEconomy + ')';
      html += '</div>';
    });
  }
  
  // Display Team B bowlers
  if (topBowlersB && topBowlersB.length > 0) {
    html += '<h3 style="color:#333;margin-bottom:10px">Top Bowlers - ' + st.team_b_name + '</h3>';
    topBowlersB.forEach((bowler, index) => {
      const overs = bowler.bowling_overs || bowler.overs || '0.0';
      const economy = bowler.bowling_economy || bowler.economy || '0.0';
      
      // Convert overs to cricket notation (overs.balls format)
      let formattedOvers = overs;
      if (typeof overs === 'number') {
        const totalBalls = Math.round(overs * 6); // Convert decimal overs back to total balls
        const wholeOvers = Math.floor(totalBalls / 6);
        const remainingBalls = totalBalls % 6;
        formattedOvers = wholeOvers + '.' + remainingBalls;
      }
      
      // Format economy to 2 decimal places
      const formattedEconomy = typeof economy === 'number' ? economy.toFixed(2) : economy;
      
      html += '<div style="padding:10px;background:#f8f9fa;border-radius:4px;margin-bottom:5px">';
      html += '<strong>' + bowler.name + '</strong>: ' + (bowler.bowling_wickets || bowler.wickets || 0) + '/' + (bowler.bowling_runs || bowler.runs || 0) + ' (' + formattedOvers + ' overs, Economy: ' + formattedEconomy + ')';
      html += '</div>';
    });
  }
  
  html += '</div>';
  return html;
}

function showInningsTab(inningsNumber) {
  const innings1Content = document.getElementById('innings1Content');
  const innings2Content = document.getElementById('innings2Content');
  const innings1Tab = document.getElementById('innings1Tab');
  const innings2Tab = document.getElementById('innings2Tab');
  
  if (inningsNumber === 1) {
    if (innings1Content) innings1Content.style.display = 'block';
    if (innings2Content) innings2Content.style.display = 'none';
    if (innings1Tab) {
      innings1Tab.style.background = '#2196f3';
      innings1Tab.style.color = 'white';
    }
    if (innings2Tab) {
      innings2Tab.style.background = '#f0f0f0';
      innings2Tab.style.color = 'black';
    }
  } else {
    if (innings1Content) innings1Content.style.display = 'none';
    if (innings2Content) innings2Content.style.display = 'block';
    if (innings1Tab) {
      innings1Tab.style.background = '#f0f0f0';
      innings1Tab.style.color = 'black';
    }
    if (innings2Tab) {
      innings2Tab.style.background = '#2196f3';
      innings2Tab.style.color = 'white';
    }
  }
}

function showPopupAlert(title, message) {
  // Create overlay
  const overlay = document.createElement('div');
  overlay.className = 'popup-overlay';
  
  // Create popup
  const popup = document.createElement('div');
  popup.className = 'popup-alert';
  
  // Create content elements
  const titleEl = document.createElement('h3');
  titleEl.textContent = title;
  
  const messageEl = document.createElement('p');
  messageEl.textContent = message;
  
  const buttonEl = document.createElement('button');
  buttonEl.textContent = 'OK';
  buttonEl.onclick = closePopupAlert;
  
  popup.appendChild(titleEl);
  popup.appendChild(messageEl);
  popup.appendChild(buttonEl);
  
  overlay.appendChild(popup);
  document.body.appendChild(overlay);
  
  // Close on overlay click
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) {
      closePopupAlert();
    }
  });
}

function closePopupAlert() {
  const overlay = document.querySelector('.popup-overlay');
  if (overlay) {
    overlay.remove();
  }
}

function showCaptainConfirmDialog(playerName, teamName) {
  return new Promise((resolve) => {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'popup-overlay';
    overlay.style.cssText = 
      'position: fixed;' +
      'top: 0;' +
      'left: 0;' +
      'width: 100%;' +
      'height: 100%;' +
      'background: rgba(0, 0, 0, 0.5);' +
      'backdrop-filter: blur(5px);' +
      'z-index: 9999;' +
      'display: flex;' +
      'justify-content: center;' +
      'align-items: center;';
    
    // Create popup
    const popup = document.createElement('div');
    popup.style.cssText = 
      'background: white;' +
      'padding: 30px;' +
      'border-radius: 15px;' +
      'box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);' +
      'max-width: 400px;' +
      'text-align: center;' +
      'animation: popupSlide 0.3s ease-out;';
    
popup.innerHTML ='<div style="font-size: 48px; margin-bottom: 15px;">üß¢</div>' +
'<h3 style="margin: 0 0 15px 0; color: #01147C;">Captain Selection</h3>' +
'<p style="margin: 0 0 25px 0; color: #333; font-size: 16px;">' +
  'Make <strong>' + playerName + '</strong> the captain of ' + teamName + '?' +
'</p>' +
'<div style="display: flex; gap: 10px; justify-content: center;">' +
  '<button id="captainYes" style="background:#01147C; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Yes, Make Captain</button>' +
  '<button id="captainNo" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer;">No</button>' +
'</div>';


    
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    
    // Add animation
    const style = document.createElement('style');
    style.textContent = 
      '@keyframes popupSlide {' +
      '  from { transform: translateY(-50px); opacity: 0; }' +
      '  to { transform: translateY(0); opacity: 1; }' +
      '}';
    document.head.appendChild(style);
    
    // Handle button clicks
    document.getElementById('captainYes').addEventListener('click', () => {
      overlay.remove();
      resolve(true);
    });
    
    document.getElementById('captainNo').addEventListener('click', () => {
      overlay.remove();
      resolve(false);
    });
    
    // Close on overlay click
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        overlay.remove();
        resolve(false);
      }
    });
  });
}

function showPlayerNameDialog(message) {
  return new Promise((resolve) => {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'popup-overlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    `;
    
    // Create popup
    const popup = document.createElement('div');
    popup.style.cssText = `
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      text-align: center;
      animation: popupSlide 0.3s ease-out;
    `;
    
    popup.innerHTML = `<div style="font-size: 36px; margin-bottom: 15px;">üë§</div>
      <h3 style="margin: 0 0 15px 0; color: #01147C;">Add Player</h3>
      <p style="margin: 0 0 20px 0; color: #333; font-size: 16px;">` + message + `</p>
      <input type="text" id="playerNameInput" placeholder="Enter player name" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 20px; font-size: 16px; color: black;">
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button id="playerNameOk" style="background: #01147C; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">OK</button>
        <button id="playerNameCancel" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
      </div>
    `;
    
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    
    // Focus on input
    setTimeout(() => {
      document.getElementById('playerNameInput').focus();
    }, 100);
    
    // Handle button clicks
    document.getElementById('playerNameOk').addEventListener('click', () => {
      const name = document.getElementById('playerNameInput').value.trim();
      overlay.remove();
      resolve(name || null);
    });
    
    document.getElementById('playerNameCancel').addEventListener('click', () => {
      overlay.remove();
      resolve(null);
    });
    
    // Handle Enter key
    document.getElementById('playerNameInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const name = document.getElementById('playerNameInput').value.trim();
        overlay.remove();
        resolve(name || null);
      }
    });
    
    // Close on overlay click
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        overlay.remove();
        resolve(null);
      }
    });
  });
}

function showPlayerRoleDialog(message, defaultValue = 'Batsman') {
  return new Promise((resolve) => {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'popup-overlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    `;
    
    // Create popup
    const popup = document.createElement('div');
    popup.style.cssText = `
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      text-align: center;
      animation: popupSlide 0.3s ease-out;
    `;
    
    popup.innerHTML = `<div style="font-size: 36px; margin-bottom: 15px;">‚öæ</div>
      <h3 style="margin: 0 0 15px 0; color: #01147C;">Player Role</h3>
      <p style="margin: 0 0 20px 0; color: #333; font-size: 16px;">${message}</p>
      <select id="playerRoleSelect" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 20px; font-size: 16px; color: black;">
        <option value="batsman">Batsman</option>
        <option value="bowler">Bowler</option>
        <option value="all-rounder">All-rounder</option>
        <option value="wicket-keeper">Wicket-keeper</option>
        <option value="unknown">Unknown</option>
      </select>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button id="playerRoleOk" style="background: #01147C; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">OK</button>
        <button id="playerRoleCancel" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
      </div>
    `;
    
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    
    // Set default value
    setTimeout(() => {
      const select = document.getElementById('playerRoleSelect');
      select.value = defaultValue.toLowerCase();
      select.focus();
    }, 100);
    
    // Handle button clicks
    document.getElementById('playerRoleOk').addEventListener('click', () => {
      const role = document.getElementById('playerRoleSelect').value;
      overlay.remove();
      resolve(role);
    });
    
    document.getElementById('playerRoleCancel').addEventListener('click', () => {
      overlay.remove();
      resolve(null);
    });
    
    // Close on overlay click
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        overlay.remove();
        resolve(null);
      }
    });
  });
}

function showNextBatsmanDialog(availableBatsmen) {
  return new Promise((resolve) => {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'popup-overlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    `;
    
    // Create popup
    const popup = document.createElement('div');
    popup.style.cssText = `
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      max-width: 450px;
      text-align: center;
      animation: popupSlide 0.3s ease-out;
    `;
    
    const batsmenList = availableBatsmen.length > 0 ? 
      availableBatsmen.map(name => '<option value="' + name + '">' + name + '</option>').join('') : 
      '<option value="">No available batsmen</option>';
    
    popup.innerHTML = `<div style="font-size: 36px; margin-bottom: 15px;">üèè</div>
      <h3 style="margin: 0 0 15px 0; color: #01147C;">Next Batsman</h3>
      <p style="margin: 0 0 20px 0; color: #333; font-size: 16px;">Select next batsman or type a new name:</p>
      <select id="batsmanSelect" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-size: 16px; color: black;">
        <option value="">-- Select from available batsmen --</option>
        ` + batsmenList + `
      </select>
      <div style="text-align: left; margin-bottom: 15px;">
        <label style="color: black; font-weight: bold;">Or type new name:</label>
        <input type="text" id="newBatsmanInput" placeholder="Enter new batsman name" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px; font-size: 16px; color: black;">
      </div>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button id="batsmanOk" style="background: #01147C; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">OK</button>
        <button id="batsmanCancel" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
      </div>
    `;
    
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    
    // Focus on select first
    setTimeout(() => {
      document.getElementById('batsmanSelect').focus();
    }, 100);
    
    // Handle button clicks
    document.getElementById('batsmanOk').addEventListener('click', () => {
      const selectedBatsman = document.getElementById('batsmanSelect').value;
      const newBatsman = document.getElementById('newBatsmanInput').value.trim();
      
      const finalName = newBatsman || selectedBatsman;
      overlay.remove();
      resolve(finalName || null);
    });
    
    document.getElementById('batsmanCancel').addEventListener('click', () => {
      overlay.remove();
      resolve(null);
    });
    
    // Handle Enter key on input
    document.getElementById('newBatsmanInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const selectedBatsman = document.getElementById('batsmanSelect').value;
        const newBatsman = document.getElementById('newBatsmanInput').value.trim();
        
        const finalName = newBatsman || selectedBatsman;
        overlay.remove();
        resolve(finalName || null);
      }
    });
    
    // Handle selection change to clear input
    document.getElementById('batsmanSelect').addEventListener('change', () => {
      if (document.getElementById('batsmanSelect').value) {
        document.getElementById('newBatsmanInput').value = '';
      }
    });
    
    // Handle input to clear selection
    document.getElementById('newBatsmanInput').addEventListener('input', () => {
      if (document.getElementById('newBatsmanInput').value.trim()) {
        document.getElementById('batsmanSelect').value = '';
      }
    });
    
    // Close on overlay click
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        overlay.remove();
        resolve(null);
      }
    });
  });
}

function showNextBowlerDialog(availableBowlers) {
  return new Promise((resolve) => {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'popup-overlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    `;
    
    // Create popup
    const popup = document.createElement('div');
    popup.style.cssText = `
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      max-width: 450px;
      text-align: center;
      animation: popupSlide 0.3s ease-out;
    `;
    
    const bowlersList = availableBowlers.length > 0 ? 
      availableBowlers.map(name => '<option value="' + name + '">' + name + '</option>').join('') : 
      '<option value="">No available bowlers</option>';
    
    popup.innerHTML = `<div style="font-size: 36px; margin-bottom: 15px;">üéØ</div>
      <h3 style="margin: 0 0 15px 0; color: #01147C;">Next Bowler</h3>
      <p style="margin: 0 0 20px 0; color: #333; font-size: 16px;">Select next bowler or type a new name:</p>
      <select id="bowlerSelect" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-size: 16px; color: black;">
        <option value="">-- Select from available bowlers --</option>
        ` + bowlersList + `
      </select>
      <div style="text-align: left; margin-bottom: 15px;">
        <label style="color: black; font-weight: bold;">Or type new name:</label>
        <input type="text" id="newBowlerInput" placeholder="Enter new bowler name" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px; font-size: 16px; color: black;">
      </div>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button id="bowlerOk" style="background: #01147C; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">OK</button>
        <button id="bowlerCancel" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
      </div>
    `;
    
    overlay.appendChild(popup);
    
    // Safely append overlay to body
    if (document.body) {
      document.body.appendChild(overlay);
    } else {
      console.error('document.body is not available for bowler dialog');
      resolve(null);
      return;
    }
    
    // Focus on select first
    setTimeout(() => {
      document.getElementById('bowlerSelect').focus();
    }, 100);
    
    // Handle button clicks
    document.getElementById('bowlerOk').addEventListener('click', () => {
      const selectedBowler = document.getElementById('bowlerSelect').value;
      const newBowler = document.getElementById('newBowlerInput').value.trim();
      
      const finalName = newBowler || selectedBowler;
      overlay.remove();
      resolve(finalName || null);
    });
    
    document.getElementById('bowlerCancel').addEventListener('click', () => {
      overlay.remove();
      resolve(null);
    });
    
    // Handle Enter key on input
    document.getElementById('newBowlerInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const selectedBowler = document.getElementById('bowlerSelect').value;
        const newBowler = document.getElementById('newBowlerInput').value.trim();
        
        const finalName = newBowler || selectedBowler;
        overlay.remove();
        resolve(finalName || null);
      }
    });
    
    // Handle selection change to clear input
    document.getElementById('bowlerSelect').addEventListener('change', () => {
      if (document.getElementById('bowlerSelect').value) {
        document.getElementById('newBowlerInput').value = '';
      }
    });
    
    // Handle input to clear selection
    document.getElementById('newBowlerInput').addEventListener('input', () => {
      if (document.getElementById('newBowlerInput').value.trim()) {
        document.getElementById('bowlerSelect').value = '';
      }
    });
    
    // Close on overlay click
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        overlay.remove();
        resolve(null);
      }
    });
  });
}

window.showPlayerSetup = function() {
  // Validate configuration first
  const overs = parseInt(document.getElementById('overs').value);
  const playersPerTeam = parseInt(document.getElementById('playersPerTeam').value);
  
  if (!overs || overs < 1) {
    showPopupAlert('Invalid Overs', 'Please enter valid number of overs (minimum 1)');
    return;
  }
  
  if (!playersPerTeam || playersPerTeam < 2 || playersPerTeam > 11) {
    showPopupAlert('Invalid Players', 'Please enter valid number of players per team (2-11)');
    return;
  }
  
  // Hide config section, show player setup
  document.getElementById('playerSetupSection').style.display = 'block';
  
  // Scroll to player setup
  document.getElementById('playerSetupSection').scrollIntoView({ behavior: 'smooth' });
}

window.backToConfig = function() {
  // Hide player setup, show config
  document.getElementById('playerSetupSection').style.display = 'none';
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

window.addPlayer = async function(team) {
  document.getElementById('setupError').textContent = '';
  const name = document.getElementById(team === 'A' ? 'teamAPlayerName' : 'teamBPlayerName').value.trim();
  const role = document.getElementById(team === 'A' ? 'teamAPlayerRole' : 'teamBPlayerRole').value;
  const teamName = document.getElementById(team === 'A' ? 'teamAName' : 'teamBName').value.trim();
  const playersPerTeam = parseInt(document.getElementById('playersPerTeam').value) || 11;
  
  if (!name) return;
  
  const st = await api('/api/state');
  const currentTeam = team === 'A' ? st.team_a_players : st.team_b_players;
  
  // Check for duplicate player name
  const duplicatePlayer = currentTeam.find(p => p.name.toLowerCase() === name.toLowerCase());
  if (duplicatePlayer) {
    showPopupAlert('Duplicate Player', 'Player "${name}" already exists in ${teamName}');
    return;
  }
  
  // Check if team already has maximum players
  if (currentTeam.length >= playersPerTeam) {
    showPopupAlert('Player Limit Reached', '${teamName} already has ${currentTeam.length} players (maximum: ${playersPerTeam})');
    return;
  }
  
  // Check if this is the first player and ask for captain
  let makeCaptain = false;
  if (currentTeam.length === 0) {
    makeCaptain = await showCaptainConfirmDialog(name, teamName);
  }
  
  await api('/api/add_player', {team, name, role, team_name: teamName, make_captain: makeCaptain});
  document.getElementById(team === 'A' ? 'teamAPlayerName' : 'teamBPlayerName').value = '';
  await refresh();
  
  // Update batting first dropdown after adding player
  updateBattingFirstDropdown();
}

function updateBattingFirstDropdown() {
  const teamAName = document.getElementById('teamAName').value.trim() || 'Team A';
  const teamBName = document.getElementById('teamBName').value.trim() || 'Team B';
  
  // Update teamsList with current team names
  teamsList[0] = teamAName;
  teamsList[1] = teamBName;
  
  const batFirst = document.getElementById('batFirst');
  const helpText = document.getElementById('battingFirstHelp');
  
  if (batFirst) {
    batFirst.innerHTML = '';
    
    // Always show team names in dropdown (even without players)
    const opt1 = document.createElement('option');
    opt1.textContent = teamsList[0];
    opt1.value = teamsList[0];
    batFirst.appendChild(opt1);
    
    const opt2 = document.createElement('option');
    opt2.textContent = teamsList[1];
    opt2.value = teamsList[1];
    batFirst.appendChild(opt2);
    
    // Check if teams have enough players to enable (only if API is available)
    if (typeof api !== 'undefined') {
      api('/api/state').then(st => {
        if (st && st.team_a_players.length >= 2 && st.team_b_players.length >= 2) {
          batFirst.disabled = false;
          if (helpText) {
            helpText.textContent = 'Select which team bats first';
            helpText.style.color = '#28a745';
          }
        } else {
          batFirst.disabled = true;
          if (helpText) {
            const teamAPlayers = st ? st.team_a_players.length : 0;
            const teamBPlayers = st ? st.team_b_players.length : 0;
            helpText.textContent = `Add at least 2 players to each team (Team A: ${teamAPlayers}/2, Team B: ${teamBPlayers}/2)`;
            helpText.style.color = '#666';
          }
        }
        
        // Set selected value if already chosen
        if (st && st.batting_first) {
          batFirst.value = st.batting_first;
        }
      }).catch(err => {
        console.log('API not available yet, keeping dropdown disabled');
        batFirst.disabled = true;
        if (helpText) {
          helpText.textContent = 'Add at least 2 players to each team to enable';
          helpText.style.color = '#666';
        }
      });
    } else {
      // API not available, keep dropdown disabled
      batFirst.disabled = true;
      if (helpText) {
        helpText.textContent = 'Add at least 2 players to each team to enable';
        helpText.style.color = '#666';
      }
    }
  }
}

window.startMatch = async function() {
  document.getElementById('setupError').textContent = '';
  const teamAName = document.getElementById('teamAName').value.trim();
  const teamBName = document.getElementById('teamBName').value.trim();
  const matchName = document.getElementById('matchName').value.trim();
  const overs = parseInt(document.getElementById('overs').value, 10);
  const playersPerTeam = parseInt(document.getElementById('playersPerTeam').value, 10);
  const batFirst = document.getElementById('batFirst').value;
  
  // Generate match name if not provided
  let finalMatchName = matchName;
  if (!finalMatchName) {
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    finalMatchName = `${teamAName} vs ${teamBName} - ${dateStr} ${timeStr}`;
  }
  
  console.log('DEBUG: startMatch called with:', {teamAName, teamBName, matchName: finalMatchName, overs, playersPerTeam, batFirst});
  try {
    await api('/api/start', {team_a_name: teamAName, team_b_name: teamBName, match_name: finalMatchName, overs, players_per_team: playersPerTeam, batting_first: batFirst});
    console.log('DEBUG: Match started, calling refresh');
    await refresh();
    console.log('DEBUG: Refresh completed, calling selectOpeners');
    await selectOpeners();
    console.log('DEBUG: selectOpeners completed, calling changeBowler');
    await changeBowler();
    console.log('DEBUG: changeBowler completed');
    
    // Update download button now that match has started
    const st = await api('/api/state');
    updateDownloadButton(st);
  } catch (e) {
    console.error('DEBUG: Error in startMatch:', e);
    document.getElementById('setupError').textContent = e.message;
  }
}

// Frontend-only player management functions
window.editPlayer = async function(team, playerId) {
  console.log('DEBUG: editPlayer called with team:', team, 'playerId:', playerId);
  const st = await api('/api/state'); // Use backend state
  const players = team === 'team_a' ? (st.team_a_players || []) : (st.team_b_players || []);
  const player = players.find(p => p.id === playerId);
  
  console.log('DEBUG: Found player:', player);
  
  if (!player) {
    console.log('DEBUG: Player not found!');
    return;
  }
  
  // Create edit dialog
  const dialog = document.createElement('div');
  dialog.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 1000;
    min-width: 300px;
  `;
  
  dialog.innerHTML = `
    <h3 style="margin: 0 0 15px 0; color: #01147C;">Edit Player</h3>
    <div style="margin-bottom: 10px;">
      <label style="display: block; margin-bottom: 5px; color: #333;">Name:</label>
      <input type="text" id="editPlayerName" value="${player.name}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; color: #333;">Role:</label>
      <select id="editPlayerRole" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="batsman" ${player.role === 'batsman' ? 'selected' : ''}>Batsman</option>
        <option value="bowler" ${player.role === 'bowler' ? 'selected' : ''}>Bowler</option>
        <option value="all-rounder" ${player.role === 'all-rounder' ? 'selected' : ''}>All-rounder</option>
        <option value="wicket-keeper" ${player.role === 'wicket-keeper' ? 'selected' : ''}>Wicket-keeper</option>
      </select>
    </div>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button id="cancelEditBtn" style="padding: 8px 16px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 4px; cursor: pointer;">Cancel</button>
      <button id="saveEditBtn" style="padding: 8px 16px; background: #01147C; color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
    </div>
  `;
  
  document.body.appendChild(dialog);
  
  // Handle save
  document.getElementById('saveEditBtn').onclick = async () => {
    const newName = document.getElementById('editPlayerName').value.trim();
    const newRole = document.getElementById('editPlayerRole').value;
    
    if (!newName) {
      alert('Player name cannot be empty!');
      return;
    }
    
    try {
      // Update via backend API
      await api('/api/edit-player', {team, player_id: playerId, name: newName, role: newRole});
      
      // Refresh display
      await refresh();
      document.body.removeChild(dialog);
    } catch (e) {
      alert('Error updating player: ' + e.message);
    }
  };
  
  // Handle cancel
  document.getElementById('cancelEditBtn').onclick = () => {
    document.body.removeChild(dialog);
  };
};

window.removePlayer = async function(team, playerId) {
  console.log('DEBUG: removePlayer called with team:', team, 'playerId:', playerId);
  const st = await api('/api/state'); // Use backend state
  const players = team === 'team_a' ? (st.team_a_players || []) : (st.team_b_players || []);
  const player = players.find(p => p.id === playerId);
  
  console.log('DEBUG: Found player:', player);
  
  if (!player) {
    console.log('DEBUG: Player not found!');
    return;
  }
  
  // Confirm removal
  const confirmed = confirm(`Are you sure you want to remove ${player.name} from ${team === 'team_a' ? (st.team_a_name || 'Team A') : (st.team_b_name || 'Team B')}?`);
  if (!confirmed) return;
  
  try {
    // Remove via backend API
    await api('/api/remove-player', {team, player_id: playerId});
    
    // Refresh display
    await refresh();
    
    // Update batting first dropdown after removing player
    updateBattingFirstDropdown();
  } catch (e) {
    alert('Error removing player: ' + e.message);
  }
};

window.resetAll = async function() {
  await api('/api/reset', {});
  await refresh();
}

window.selectOpeners = async function() {
  console.log('DEBUG: selectOpeners called');
  const liveErrorEl = document.getElementById('liveError');
  if (liveErrorEl) liveErrorEl.textContent = '';
  const st = await api('/api/state');
  console.log('DEBUG: selectOpeners state:', {batting_players: st.batting_players?.length, started: st.started});
  const names = st.batting_players.map(p => p.name);
  console.log('DEBUG: selectOpeners names:', names);
  
  // Create opener selection dialog
  const dialog = document.createElement('div');
  dialog.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border:2px solid #ccc;border-radius:8px;z-index:1000;box-shadow:0 4px 8px rgba(0,0,0,0.2);color:black;max-width:90%;width:90%;min-width:280px;`;
  dialog.innerHTML = `<h3>Select Openers</h3>
    <div style="margin:15px 0;color:black">
      <div style="margin-bottom:10px;">
        <label style="color:black;display:block;margin-bottom:5px;">Striker:</label>
        <select id="strikerSelect" style="width:100%;padding:10px;color:black;border:1px solid #ddd;border-radius:4px;" onchange="updateNonStrikerOptions()">
          ` + names.map(name => '<option value="' + name + '">' + name + '</option>').join('') + `
        </select>
      </div>
      <div>
        <label style="color:black;display:block;margin-bottom:5px;">Non-striker:</label>
        <select id="nonStrikerSelect" style="width:100%;padding:10px;color:black;border:1px solid #ddd;border-radius:4px;">
          ` + names.map(name => '<option value="' + name + '">' + name + '</option>').join('') + `
        </select>
      </div>
    </div>
    <div style="margin-top:20px;color:black;display:flex;gap:10px;">
      <button id="confirmOpenersBtn" style="flex:1;padding:12px 20px;color:black;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;">Confirm</button>
      <button id="cancelOpenersBtn" style="flex:1;padding:12px 20px;color:black;background:#6c757d;color:white;border:none;border-radius:4px;cursor:pointer;">Cancel</button>
    </div>
  `;
  
  // Safely append dialog to body
  if (document.body) {
    document.body.appendChild(dialog);
  } else {
    console.error('document.body is not available for opener selection dialog');
    return;
  }
  
  // Add function to update non-striker options when striker changes
  window.updateNonStrikerOptions = function() {
    const strikerSelect = document.getElementById('strikerSelect');
    const nonStrikerSelect = document.getElementById('nonStrikerSelect');
    const selectedStriker = strikerSelect.value;
    
    console.log('DEBUG: Striker selected:', selectedStriker);
    
    // Clear non-striker options
    nonStrikerSelect.innerHTML = '';
    
    // Add all players except the selected striker
    names.forEach(name => {
      if (name !== selectedStriker) {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        nonStrikerSelect.appendChild(option);
      }
    });
    
    console.log('DEBUG: Non-striker options updated');
  };
  
  // Initial call to set non-striker options
  updateNonStrikerOptions();
  
  // Add event listeners directly to avoid scope issues
  document.getElementById('confirmOpenersBtn').addEventListener('click', async () => {
    console.log('DEBUG: Confirm openers button clicked!');
    const striker = document.getElementById('strikerSelect').value;
    const nonStriker = document.getElementById('nonStrikerSelect').value;
    console.log('DEBUG: Selected strikers:', striker, nonStriker);
    
    if (striker === nonStriker) {
      showPopupAlert('Invalid Selection', 'Striker and non-striker must be different players!');
      return;
    }
    
    try {
      console.log('DEBUG: About to call set_openers API');
      await api('/api/set_openers', {striker, non_striker: nonStriker});
      console.log('DEBUG: set_openers API call successful');
      await refresh();
      console.log('DEBUG: Refresh completed');
      if (document.body.contains(dialog)) {
        document.body.removeChild(dialog);
        console.log('DEBUG: Opener dialog removed');
      } else {
        console.log('DEBUG: Opener dialog not found in body');
      }
    } catch (e) {
      console.error('DEBUG: Error in confirmOpeners:', e);
      document.getElementById('liveError').textContent = e.message;
    }
  });
  
  document.getElementById('cancelOpenersBtn').addEventListener('click', () => {
    if (document.body.contains(dialog)) {
      document.body.removeChild(dialog);
    }
  });
}

window.changeBowler = async function() {
  console.log('DEBUG: changeBowler called');
  const liveErrorEl = document.getElementById('liveError');
  if (liveErrorEl) liveErrorEl.textContent = '';
  const st = await api('/api/state');
  console.log('DEBUG: changeBowler state:', {bowling_players: st.bowling_players?.length, match_complete: st.match_complete, innings_complete: st.innings_complete});
  
  // Check if match or innings is completed before asking for bowler
  if (st.match_complete) {
    console.log('DEBUG: Match complete, not showing bowler dialog');
    if (liveErrorEl) liveErrorEl.textContent = 'Match completed! No more bowling changes allowed.';
    return;
  }
  if (st.innings_complete) {
    console.log('DEBUG: Innings complete, not showing bowler dialog');
    if (liveErrorEl) liveErrorEl.textContent = 'Innings completed! Switch innings to continue.';
    return;
  }
  
  const names = st.bowling_players.map(p => p.name);
  console.log('DEBUG: changeBowler names:', names);
  
  const bowlerName = await showNextBowlerDialog(names);
  console.log('DEBUG: showNextBowlerDialog returned:', bowlerName);
  if (!bowlerName) return;
  
  try {
    await api('/api/set_bowler', {bowler: bowlerName});
    await refresh();
  } catch (e) {
    document.getElementById('liveError').textContent = e.message;
  }
}

window.switchInnings = async function() {
  console.log('DEBUG: switchInnings function started');
  const liveErrorEl = document.getElementById('liveError');
  if (liveErrorEl) liveErrorEl.textContent = '';
  try {
    // Show loading message
    if (liveErrorEl) liveErrorEl.textContent = 'Switching innings...';
    console.log('DEBUG: About to call switch_innings API');
    
    const result = await api('/api/switch_innings', {});
    console.log('DEBUG: switch_innings API successful:', result);
    
    // Check if API call was successful
    if (result && result.ok) {
      // Show message and setup 2nd innings
      if (liveErrorEl) liveErrorEl.textContent = 'Setting up 2nd innings...';
      
      // Start 2nd innings setup immediately (no setTimeout)
      try {
        console.log('DEBUG: About to call selectOpeners');
        await selectOpeners();
        console.log('DEBUG: selectOpeners completed');
        await changeBowler();
        console.log('DEBUG: changeBowler completed');
        
        // Enable scoring controls for 2nd innings
        enableScoringControls();
        console.log('DEBUG: Scoring controls enabled in switchInnings');
        
        // Remove innings complete message if it exists
        const msgDiv = document.querySelector('.innings-complete-msg');
        if (msgDiv) {
          msgDiv.remove();
          console.log('DEBUG: Innings complete message removed in switchInnings');
        }
        
        if (liveErrorEl) liveErrorEl.textContent = '2nd innings ready! Start playing.';
      } catch (e) {
        console.error('DEBUG: Error setting up 2nd innings:', e);
        if (liveErrorEl) liveErrorEl.textContent = 'Error setting up 2nd innings. Please try manually.';
      }
    } else {
      // API call failed - show error message
      console.error('DEBUG: switch_innings API failed:', result);
      if (liveErrorEl) {
        liveErrorEl.textContent = result.error || 'Failed to switch innings. Please try again.';
      }
    }
  } catch (e) {
        console.error('DEBUG: Error setting up 2nd innings:', e);
        if (liveErrorEl) liveErrorEl.textContent = 'Error setting up 2nd innings. Please try manually.';
    }
}

window.scoreRuns = async function(r) {
  const liveError = document.getElementById('liveError');
   if (liveError) liveError.textContent = '';
  try {
    const res = await api('/api/score', {runs: r});
    await refresh();
    
    // Get fresh state after scoring
    const st = await api('/api/state');
    
    // Check if innings is complete after scoring
    if (st.innings_complete) {
      if (st.summary.innings === 1) {
        liveError.textContent = 'First innings complete! You must switch innings before adding runs.';
        // Show switch innings popup
        showSwitchInningsPopup();
      } else {
        liveError.textContent = 'Match completed! No more runs can be added.';
      }
      return;
    }
    
    // Show boundary popups for 4 and 6 runs
    if (r === 4 || r === 6) {
      console.log('DEBUG: About to show boundary popup for runs:', r);
      showBoundaryPopup(r);
      console.log('DEBUG: Boundary popup function called');
    }
    
    // Check if match is complete
    console.log('DEBUG: Checking match completion - match_complete:', st.match_complete);
    console.log('DEBUG: Match winner:', st.match_winner);
    if (st.match_complete && st.match_winner) {
      console.log('DEBUG: Match is complete! Winner:', st.match_winner);
      showVictoryPopup(st.match_winner);
      disableScoringControls();
      return;
    }
    
    // Check if innings is complete before prompting for bowler
    if (res.over_complete && !st.innings_complete) {
      await changeBowler();
    } else if (st.innings_complete) {
        // Handle innings completion
        if (st.summary.innings === 1) {
          liveError.textContent = 'First innings complete! Click "Start 2nd Innings" to continue.';
          // Popup will be shown by refresh() function
        } else {
          liveError.textContent = 'Match completed! ' + st.match_winner + ' won!';
        }
      }
  } catch (e) {
    document.getElementById('liveError').textContent = e.message;
  }
}

window.wicket = async function() {
  const liveerrorW = document.getElementById('liveError');
  if(liveerrorW) liveerrorW.textContent = '';
  try {
    // Check if innings is complete before allowing wicket
    const st = await api('/api/state');
    if (st.innings_complete) {
      if (st.summary.innings === 1) {
        liveerrorW.textContent = 'First innings complete! You must switch innings before adding wickets.';
        // Show switch innings popup
        showSwitchInningsPopup();
      } else {
        liveerrorW.textContent = 'Match completed! No more wickets can be added.';
      }
      return;
    }
    
    // Create wicket dialog
    const dialog = document.createElement('div');
    dialog.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border:2px solid #ccc;border-radius:8px;z-index:1000;box-shadow:0 4px 8px rgba(0,0,0,0.2);`;
    dialog.innerHTML = `<h3 style="color:black">Wicket Details</h3>
      <div style="margin:10px 0;color:black">
        <label style="color:black">Wicket Type:</label>
        <select id="wicketType" style="margin-left:10px;padding:5px;color:black">
          <option value="bowled">Bowled</option>
          <option value="caught">Caught</option>
          <option value="lbw">LBW</option>
          <option value="run-out">Run Out</option>
          <option value="stumped">Stumped</option>
          <option value="hit-wicket">Hit Wicket</option>
          <option value="retired">Retired</option>
          <option value="time-out">Time Out</option>
          <option value="return-hurt">Return Hurt</option>
        </select>
      </div>
      <div id="catcherDiv" style="margin:10px 0;display:none;color:black">
        <label style="color:black">Catcher Name:</label>
        <input type="text" id="catcherName" placeholder="Enter catcher name" style="margin-left:10px;padding:5px;color:black">
      </div>
      <div id="runoutDiv" style="margin:10px 0;display:none;color:black">
        <label style="color:black">Run-out by (comma separated):</label>
        <input type="text" id="runoutBy" placeholder="Player1, Player2" style="margin-left:10px;padding:5px;width:200px;color:black">
      </div>
      <div style="margin-top:15px;color:black">
        <button onclick="confirmWicket()" style="padding:8px 16px;margin-right:10px;color:black">Confirm</button>
        <button onclick="cancelWicket()" style="padding:8px 16px;color:black">Cancel</button>
      </div>
    `;
    
    document.body.appendChild(dialog);
    
    // Show/hide fields based on wicket type
    const wicketType = document.getElementById('wicketType');
    const catcherDiv = document.getElementById('catcherDiv');
    const runoutDiv = document.getElementById('runoutDiv');
    
    wicketType.addEventListener('change', function() {
      catcherDiv.style.display = this.value === 'caught' ? 'block' : 'none';
      runoutDiv.style.display = this.value === 'run-out' ? 'block' : 'none';
    });
    
    window.confirmWicket = async function() {
      const type = wicketType.value;
      const catcher = document.getElementById('catcherName').value.trim();
      const runoutBy = document.getElementById('runoutBy').value.trim();
      
      const res = await api('/api/wicket', {
        type: type,
        catcher: catcher || null,
        runout_by: runoutBy ? runoutBy.split(',').map(s => s.trim()) : null
      });
      
      await refresh();
      document.body.removeChild(dialog);
      
      // Get current state to access bowler name
      const st = await api('/api/state');
      
      // Show wicket popup with details
      showWicketPopup(type, st.bowler, catcher);
      
      // Wait for wicket popup to finish before asking for next batsman
      await new Promise(resolve => setTimeout(resolve, 4000));
      
      // Check if match is complete
      if (st.match_complete) {
        showVictoryPopup(st.match_winner);
        disableScoringControls();
        return;
      }
      
      // Check if innings or match is complete before asking for next batsman
      if (!st.innings_complete && !st.match_complete) {
        // Only ask for next batsman if innings and match are not complete
        const names = st.next_batsmen.map(p => p.name);
        let n = await showNextBatsmanDialog(names);
        if (!n) return;
        await api('/api/next_batsman', {name: n});
        await refresh();
      }
      
      // Check if innings is complete before prompting for bowler
      if (res.over_complete && !st.innings_complete) {
        await changeBowler();
      } else if (st.innings_complete) {
        // Handle innings completion
        if (st.summary.innings === 1) {
          document.getElementById('liveError').textContent = 'First innings complete! Click "Start 2nd Innings" to continue.';
          // Popup will be shown by refresh() function
        } else {
          document.getElementById('liveError').textContent = 'Match completed! ' + st.match_winner + ' won!';
        }
      }
    };
    
    window.cancelWicket = function() {
      document.body.removeChild(dialog);
    };
    
  } catch (e) {
    document.getElementById('liveError').textContent = e.message;
  }
}

// Custom popup for bye/leg-bye runs selection
function showByeRunsPopup(type) {
  return new Promise((resolve) => {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    `;
    
    // Create popup
    const popup = document.createElement('div');
    popup.style.cssText = `
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      max-width: 400px;
      width: 90%;
      text-align: center;
    `;
    
    // Title
    const title = document.createElement('h3');
    title.textContent = type.toUpperCase() + ' RUNS';
    title.style.cssText = `
      margin: 0 0 20px 0;
      color: #333;
      font-size: 20px;
      font-weight: bold;
    `;
    
    // Subtitle
    const subtitle = document.createElement('p');
    subtitle.textContent = 'Select runs for ' + type.toLowerCase();
    subtitle.style.cssText = `
      margin: 0 0 20px 0;
      color: #666;
      font-size: 14px;
    `;
    
    // Score buttons container
    const buttonsContainer = document.createElement('div');
    buttonsContainer.style.cssText = `
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    `;
    
    // Create score buttons (0-12)
    for (let i = 0; i <= 12; i++) {
      const button = document.createElement('button');
      button.textContent = i;
      button.style.cssText = `
        padding: 12px;
        border: 2px solid #2196f3;
        background: white;
        color: #2196f3;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
      `;
      
      button.onmouseover = () => {
        button.style.background = '#2196f3';
        button.style.color = 'white';
      };
      
      button.onmouseout = () => {
        button.style.background = 'white';
        button.style.color = '#2196f3';
      };
      
      button.onclick = () => {
        document.body.removeChild(overlay);
        resolve(i);
      };
      
      buttonsContainer.appendChild(button);
    }
    
    // Cancel button
    const cancelButton = document.createElement('button');
    cancelButton.textContent = 'Cancel';
    cancelButton.style.cssText = `
      padding: 12px 24px;
      border: 2px solid #f44336;
      background: white;
      color: #f44336;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    `;
    
    cancelButton.onmouseover = () => {
      cancelButton.style.background = '#f44336';
      cancelButton.style.color = 'white';
    };
    
    cancelButton.onmouseout = () => {
      cancelButton.style.background = 'white';
      cancelButton.style.color = '#f44336';
    };
    
    cancelButton.onclick = () => {
      document.body.removeChild(overlay);
      resolve(null);
    };
    
    // Assemble popup
    popup.appendChild(title);
    popup.appendChild(subtitle);
    popup.appendChild(buttonsContainer);
    popup.appendChild(cancelButton);
    
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    
    // Close on overlay click
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        document.body.removeChild(overlay);
        resolve(null);
      }
    });
    
    // Close on Escape key
    const escapeHandler = (e) => {
      if (e.key === 'Escape') {
        document.body.removeChild(overlay);
        document.removeEventListener('keydown', escapeHandler);
        resolve(null);
      }
    };
    document.addEventListener('keydown', escapeHandler);
  });
}

window.extra = async function(t) {
  const liveErrorExtra = document.getElementById('liveError');
  if(liveErrorExtra) liveErrorExtra.textContent = '';
  try {
    let runs = 0;
    if (t === 'bye' || t === 'leg-bye') {
      // Use custom popup instead of prompt
      runs = await showByeRunsPopup(t);
      if (runs === null) {
        // User cancelled
        return;
      }
      if (isNaN(runs) || runs < 0 || runs > 12) {
        document.getElementById('liveError').textContent = 'Invalid runs selection.';
        return;
      }
    }
    await api('/api/extra', {type: t, runs: runs});
    
    // Show "Free Hit" popup for no-balls (regular users)
    if (t === 'no-ball') {
      showFreeHitPopup();
    }
    
    await refresh();
  } catch (e) {
    document.getElementById('liveError').textContent = e.message;
  }
}

window.changeStrike = async function() {
  await api('/api/change_strike', {});
  await refresh();
}

window.addPlayerLive = async function(which) {
  const name = await showPlayerNameDialog('New player name:');
  if (!name) return;
  const role = await showPlayerRoleDialog('Role: Batsman / Bowler / All-rounder / Wicket-keeper', 'Batsman') || 'Batsman';
  
  // Check current team size and limit
  const st = await api('/api/state');
  const playersPerTeam = parseInt(document.getElementById('playersPerTeam').value) || 11;
  
  // Determine which team to check
  let currentTeam;
  let teamName;
  if (which === 'batting') {
    currentTeam = st.batting_players;
    teamName = st.summary.batting_team;
  } else {
    currentTeam = st.bowling_players;
    teamName = st.summary.bowling_team;
  }
  
  // Check for duplicate player name
  const duplicatePlayer = currentTeam.find(p => p.name.toLowerCase() === name.toLowerCase());
  if (duplicatePlayer) {
    showPopupAlert('Duplicate Player', 'Player "${name}" already exists in ${teamName}');
    return;
  }
  
  // Check if team already has maximum players
  if (currentTeam.length >= playersPerTeam) {
    showPopupAlert('Player Limit Reached', 'Cannot add more players. Maximum ${playersPerTeam} players allowed per team.');
    return;
  }
  
  await api('/api/add_player_live', {which, name, role});
  await refresh();
}

function disableScoringControls() {
  // Disable all scoring buttons
  const buttons = document.querySelectorAll('button');
  buttons.forEach(btn => {
    if (btn.textContent.includes('Run') || btn.textContent.includes('Wicket') || 
        btn.textContent.includes('Extra') || btn.textContent.includes('Change') ||
        btn.textContent.includes('Add Player')) {
      btn.disabled = true;
      btn.style.opacity = '0.5';
      btn.style.cursor = 'not-allowed';
    }
  });
  
  // Add restart button
  const controlsDiv = document.querySelector('.controls');
  const restartBtn = document.createElement('button');
  restartBtn.textContent = 'üîÑ Restart Match';
  restartBtn.style.cssText = `background:#28a745;color:white;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;margin-top:10px;font-size:16px;`;
  restartBtn.onclick = restartMatch;
  
  // Clear controls and add restart button
  controlsDiv.innerHTML = '';
  controlsDiv.appendChild(restartBtn);
  
  // Show match completed message
  const matchCompleteDiv = document.createElement('div');
  matchCompleteDiv.style.cssText = `background:#d4edda;color:#155724;padding:15px;border-radius:5px;margin-bottom:10px;text-align:center;font-weight:bold;`;
  matchCompleteDiv.textContent = 'üèÜ Match Completed! Use Restart button to start a new match.';
  controlsDiv.insertBefore(matchCompleteDiv, restartBtn);
}

function disableScoringForInningsComplete() {
  // Disable only scoring buttons when innings is complete
  const buttons = document.querySelectorAll('button');
  buttons.forEach(btn => {
    if (btn.textContent.match(/^[0-6]$/) || btn.textContent === 'Wicket') {
      btn.disabled = true;
      btn.style.opacity = '0.5';
      btn.style.cursor = 'not-allowed';
      btn.title = 'Innings complete - Switch innings to continue';
    }
  });
  
  // Show innings complete message
  const scoringDiv = document.querySelector('.card');
  if (scoringDiv && scoringDiv.querySelector('h2')?.textContent === 'Scoring') {
    const existingMsg = scoringDiv.querySelector('.innings-complete-msg');
    if (!existingMsg) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'innings-complete-msg';
      msgDiv.style.cssText = `background:#fff3cd;color:#856404;padding:10px;border-radius:5px;margin-bottom:10px;text-align:center;font-weight:bold;border:1px solid #ffeaa7;`;
      msgDiv.textContent = 'üèè Innings Complete! Click "Switch Innings" to continue with 2nd innings.';
      scoringDiv.insertBefore(msgDiv, scoringDiv.querySelector('.controls'));
    }
  }
}

function enableScoringControls() {
  // Re-enable scoring buttons
  const buttons = document.querySelectorAll('button');
  buttons.forEach(btn => {
    if (btn.textContent.match(/^[0-6]$/) || btn.textContent === 'Wicket') {
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.style.cursor = 'pointer';
      btn.title = '';
    }
  });
  
  // Remove innings complete message
  const msgDiv = document.querySelector('.innings-complete-msg');
  if (msgDiv) {
    msgDiv.remove();
  }
}

function restartMatch() {
  const popup = document.createElement('div');
  popup.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#ff6b6b 0%,#feca57 100%);color:white;padding:30px;border-radius:15px;z-index:2000;box-shadow:0 10px 30px rgba(0,0,0,0.3);text-align:center;min-width:400px;animation:restartPop 0.5s ease-out`;
  
  popup.innerHTML = 
    '<div style="font-size:36px;margin-bottom:15px;">üîÑ</div>' +
    '<h2 style="margin:0 0 20px 0;">Restart Match</h2>' +
    '<p style="margin:0 0 25px 0;font-size:16px;">Choose how you want to restart:</p>' +
    '<div style="display:flex;flex-direction:column;gap:15px;">' +
      '<button onclick="restartFresh()" style="background:white;color:#ff6b6b;padding:12px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:bold;">Start Fresh (New Teams)</button>' +
      '<button onclick="refreshPage()" style="background:white;color:#ff6b6b;padding:12px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:bold;">Refresh Page</button>' +
      '<button onclick="this.parentElement.parentElement.remove()" style="background:transparent;color:white;border:1px solid white;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:12px;">Cancel</button>' +
    '</div>';
  
  document.body.appendChild(popup);
  
  // Add animation
  const style = document.createElement('style');
  style.textContent = 
    '@keyframes restartPop {' +
    '  0% { transform: translate(-50%,-50%) scale(0.5); opacity: 0; }' +
    '  100% { transform: translate(-50%,-50%) scale(1); opacity: 1; }' +
    '}';
  document.head.appendChild(style);
}

function restartWithTeams() {
  // Remove popup safely
  const popup = document.querySelector('[style*="restartPop"]');
  if (popup && popup.parentElement) {
    popup.parentElement.remove();
  }
  
  // Get current team names and players before reset
  api('/api/state').then(st => {
    const teamAName = st.team_a_name || 'Team A';
    const teamBName = st.team_b_name || 'Team B';
    const teamAPlayers = st.team_a_players || [];
    const teamBPlayers = st.team_b_players || [];
    
    // Complete reset
    return api('/api/reset', {}).then(() => {
      // Restore team names and players
      return api('/api/restore_teams', {
        team_a_name: teamAName,
        team_b_name: teamBName,
        team_a_players: teamAPlayers,
        team_b_players: teamBPlayers
      });
    });
  }).then(() => {
    // Hard refresh to reset all UI state
    console.log('DEBUG: About to call window.location.reload() from restartMatch');
    window.location.reload();
  }).catch(e => {
    console.error('Error restarting match:', e);
    // Show error message to user
    showPopupAlert('Restart Error', 'Failed to restart match. Please try refreshing the page.');
    // Fallback to hard refresh
    console.log('DEBUG: About to call window.location.reload() from restartMatch fallback');
    window.location.reload();
  });
}

function restartFresh() {
  // Remove popup safely
  const popup = document.querySelector('[style*="restartPop"]');
  if (popup && popup.parentElement) {
    popup.parentElement.remove();
  }
  
  // Complete reset including teams
  api('/api/reset', {}).then(() => {
    // Hard refresh to reset all UI state and clear all fields
    console.log('DEBUG: About to call window.location.reload() from restartFresh');
    window.location.reload();
  }).catch(e => {
    console.error('Error restarting match:', e);
    // Fallback to hard refresh even if API fails
    console.log('DEBUG: About to call window.location.reload() from restartFresh fallback');
    window.location.reload();
  });
}

function refreshPage() {
  // Remove popup safely
  const popup = document.querySelector('[style*="restartPop"]');
  if (popup && popup.parentElement) {
    popup.parentElement.remove();
  }
  
  // Refresh the entire page
  console.log('DEBUG: About to call window.location.reload() from refreshPage');
  window.location.reload();
}

function showSwitchInningsTooltip() {
  // Find the switch innings button
  const switchButton = document.querySelector('#switchInningsDiv button');
  if (!switchButton) return;
  
  // Create tooltip
  const tooltip = document.createElement('div');
  tooltip.style.cssText = 
    'position: absolute;' +
    'background: linear-gradient(135deg,#ff6b6b 0%,#ee5a24 100%);' +
    'color: white;' +
    'padding: 12px 20px;' +
    'border-radius: 8px;' +
    'font-size: 14px;' +
    'font-weight: bold;' +
    'box-shadow: 0 4px 12px rgba(0,0,0,0.3);' +
    'z-index: 4000;' +
    'white-space: nowrap;' +
    'animation: tooltipFade 0.3s ease-out;' +
    'pointer-events: none;';
  tooltip.innerHTML = 'üéØ Click here to start 2nd innings!';
  
  // Position tooltip above the button
  const buttonRect = switchButton.getBoundingClientRect();
  tooltip.style.left = buttonRect.left + (buttonRect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
  tooltip.style.top = buttonRect.top - 50 + 'px';
  
  // Add tooltip to page
  document.body.appendChild(tooltip);
  
  // Add animation
  const style = document.createElement('style');
  style.textContent = 
    '@keyframes tooltipFade {' +
    '  0% { opacity: 0; transform: translateY(-10px); }' +
    '  100% { opacity: 1; transform: translateY(0); }' +
    '}';
  document.head.appendChild(style);
  
  // Auto-remove tooltip after 5 seconds
  setTimeout(() => {
    if (tooltip.parentElement) {
      tooltip.style.animation = 'tooltipFade 0.3s ease-out reverse';
      setTimeout(() => {
        if (tooltip.parentElement) {
          tooltip.parentElement.removeChild(tooltip);
        }
      }, 300);
    }
  }, 5000);
  
  // Also remove tooltip when user clicks the button
  switchButton.addEventListener('click', function removeTooltip() {
    if (tooltip.parentElement) {
      tooltip.parentElement.removeChild(tooltip);
    }
    switchButton.removeEventListener('click', removeTooltip);
  });
}

function showSwitchInningsPopup() {
  // Don't show switch innings popup for view-only users
  if (isViewOnly) {
    console.log('View-only user - not showing switch innings popup');
    return;
  }
  
  // Remove any existing switch innings popups first
  const existingPopups = document.querySelectorAll('[style*="switchInningsPop"]');
  existingPopups.forEach(popup => popup.remove());
  
  const popup = document.createElement('div');
  popup.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#ff6b6b 0%,#ee5a24 100%);color:white;padding:40px;border-radius:20px;z-index:15000;box-shadow:0 20px 40px rgba(0,0,0,0.3);text-align:center;min-width:450px;animation:switchInningsPop 0.5s ease-out`;
  
  popup.innerHTML = 
    '<div style="font-size:48px;margin-bottom:20px;">üîÑ</div>' +
    '<h2 style="margin:0 0 20px 0;">Switch to 2nd Innings?</h2>' +
    '<div style="font-size:18px;margin-bottom:25px;">Are you ready to start the second innings? The bowling team will now bat and the batting team will bowl.</div>' +
    '<div style="font-size:16px;margin-bottom:30px;">This action will switch the innings and set up the 2nd innings players.</div>' +
    '<div style="display:flex;gap:15px;justify-content:center;">' +
    '<button id="switchInningsConfirm" style="background:white;color:#ff6b6b;padding:12px 30px;border:none;border-radius:25px;cursor:pointer;font-size:16px;font-weight:bold;">Yes, Switch Innings</button>' +
    '<button onclick="this.parentElement.parentElement.remove()" style="background:rgba(255,255,255,0.2);color:white;padding:12px 30px;border:none;border-radius:25px;cursor:pointer;font-size:16px;font-weight:bold;">Cancel</button>' +
    '</div>';
  
  document.body.appendChild(popup);
  
  // Add animation
  const style = document.createElement('style');
  style.textContent = 
    '@keyframes switchInningsPop {' +
    '  0% { transform: translate(-50%,-50%) scale(0.5) opacity: 0; }' +
    '  100% { transform: translate(-50%,-50%) scale(1) opacity: 1; }' +
    '}';
  document.head.appendChild(style);
  
  // Handle confirm button click
  document.getElementById('switchInningsConfirm').addEventListener('click', () => {
    console.log('DEBUG: Switch innings confirm button clicked!');
    popup.remove();
    
    // Hide the Switch Innings button immediately
    const switchInningsDiv = document.getElementById('switchInningsDiv');
    if (switchInningsDiv) {
      switchInningsDiv.style.display = 'none';
      console.log('DEBUG: Switch innings button hidden');
    }
    
    // Enable scoring controls immediately
    enableScoringControls();
    console.log('DEBUG: Scoring controls enabled');
    
    // Remove innings complete message if it exists
    const msgDiv = document.querySelector('.innings-complete-msg');
    if (msgDiv) {
      msgDiv.remove();
      console.log('DEBUG: Innings complete message removed');
    }
    
    // Call the original switchInnings function
    console.log('DEBUG: About to call switchInnings()');
    switchInnings();
    console.log('DEBUG: switchInnings() called');
  });
}

function showFirstInningsPopup(summary) {
  const popup = document.createElement('div');
  popup.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#28a745 0%,#20c997 100%);color:white;padding:40px;border-radius:20px;z-index:3000;box-shadow:0 20px 40px rgba(0,0,0,0.3);text-align:center;min-width:450px;animation:firstInningsPop 0.5s ease-out`;
  
  popup.innerHTML = 
    '<div style="font-size:48px;margin-bottom:20px;">üèè</div>' +
    '<h2 style="margin:0 0 20px 0;">First Innings Complete!</h2>' +
    '<div style="font-size:20px;margin-bottom:15px;"><strong>' + summary.batting_team + '</strong></div>' +
    '<div style="font-size:32px;margin-bottom:20px;font-weight:bold;">' + summary.runs + '/' + summary.wickets + '</div>' +
    '<div style="font-size:18px;margin-bottom:25px;">(' + summary.overs + ' overs)</div>' +
    '<div style="font-size:16px;margin-bottom:30px;">Great innings! Starting 2nd innings...</div>' +
    '<button onclick="this.parentElement.remove()" style="background:white;color:#28a745;padding:12px 30px;border:none;border-radius:25px;cursor:pointer;font-size:16px;font-weight:bold;">Close</button>';
  
  document.body.appendChild(popup);
  
  // Start second innings immediately (no countdown)
  setTimeout(() => {
    if (popup.parentElement) {
      popup.parentElement.remove();
    }
    startSecondInnings();
  }, 2000); // Show popup for 2 seconds then start
  
  // Add animation
  const style = document.createElement('style');
  style.textContent = 
    '@keyframes firstInningsPop {' +
    '  0% { transform: translate(-50%,-50%) scale(0.5) opacity: 0; }' +
    '  100% { transform: translate(-50%,-50%) scale(1) opacity: 1; }' +
    '}';
  document.head.appendChild(style);
}

function startSecondInnings() {
  try {
    console.log('Starting second innings...');
    
    // Remove popup safely
    const popup = document.querySelector('[style*="firstInningsPop"]');
    if (popup && popup.parentElement) {
      popup.parentElement.remove();
      console.log('Popup removed');
    }
    
    // Start second innings flow immediately
    console.log('Calling switchInnings...');
    switchInnings();
    
  } catch (e) {
    console.error('Error in startSecondInnings:', e);
    // Fallback - try direct call
    switchInnings();
  }
}

function showVictoryPopup(winner) {
  console.log('DEBUG: showVictoryPopup called with winner:', winner);
  console.log('DEBUG: View-only mode:', isViewOnly);
  console.log('DEBUG: Victory popup already shown:', victoryPopupShown);
  
  // Prevent infinite loop
  if (victoryPopupShown) {
    console.log('DEBUG: Victory popup already shown, skipping to prevent loop');
    return;
  }
  
  // Show victory popup for everyone (not just view-only users)
  if (!winner) {
    console.log('DEBUG: No winner provided, not showing popup');
    return;
  }
  
  // Mark as shown
  victoryPopupShown = true;
  
  // Create confetti/stars effect first
  createVictoryConfetti();
  
  const popup = document.createElement('div');
  popup.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:40px;border-radius:20px;z-index:2000;box-shadow:0 20px 40px rgba(0,0,0,0.3);text-align:center;min-width:400px;animation:victoryPop 0.5s ease-out`;
  
  popup.innerHTML = 
    '<div style="font-size:48px;margin-bottom:20px;animation:trophyBounce 1s ease-in-out infinite alternate;">üèÜ</div>' +
    '<h2 style="margin:0 0 20px 0;animation:titleGlow 2s ease-in-out infinite alternate;">Match Completed!</h2>' +
    '<div style="font-size:24px;margin-bottom:30px;animation:winnerPulse 1.5s ease-in-out infinite;">' + winner + ' Won!</div>' +
    '<div style="font-size:18px;margin-bottom:30px;">Congratulations on a fantastic match! üéâ</div>' +
    '<div style="background:rgba(255,255,255,0.1);padding:20px;border-radius:15px;margin-bottom:25px;">' +
    '<div style="font-size:16px;margin-bottom:15px;font-weight:bold;">üéØ Enjoyed CricSmart?</div>' +
    '<div style="font-size:14px;margin-bottom:20px;">Support our development to keep improving your cricket scoring experience!</div>' +
    '<div style="display:flex;gap:10px;justify-content:center;margin-bottom:15px;">' +
    '<button onclick="copyUPIFromVictory()" style="background:#01147C;color:white;padding:8px 15px;border:none;border-radius:20px;cursor:pointer;font-size:14px;font-weight:bold;">üì± Copy UPI</button>' +
    '<button onclick="openUPIFromVictory()" style="background:#28a745;color:white;padding:8px 15px;border:none;border-radius:20px;cursor:pointer;font-size:14px;font-weight:bold;">üí∏ Donate ‚Çπ10</button>' +
    '</div>' +
    '<div style="font-size:12px;color:rgba(255,255,255,0.8);">UPI: vasudevant25@okicici</div>' +
    '</div>' +
    '<div style="display:flex;gap:15px;justify-content:center;margin-bottom:20px;">' +
    '<button onclick="downloadScoreboardPDF(); this.parentElement.parentElement.remove();" style="background:#01147C;color:white;padding:12px 25px;border:none;border-radius:25px;cursor:pointer;font-size:16px;font-weight:bold;animation:buttonGlow 2s ease-in-out infinite;">üìÑ Download PDF</button>' +
    '<button onclick="this.parentElement.parentElement.remove()" style="background:white;color:#667eea;padding:12px 30px;border:none;border-radius:25px;cursor:pointer;font-size:16px;font-weight:bold;animation:buttonGlow 2s ease-in-out infinite;">Close</button>' +
    '</div>';
  
  console.log('DEBUG: Victory popup created, adding to body');
  document.body.appendChild(popup);
  console.log('DEBUG: Victory popup added to body');
  
  // Ensure popup is visible by bringing it to front
  setTimeout(() => {
    if (popup && popup.parentElement) {
      popup.style.zIndex = '3000';
      console.log('DEBUG: Victory popup brought to front');
    }
  }, 100);
  
  // Update Summary tab when match completes to ensure final ball data is stored
  if (winner) {
    console.log('DEBUG: Match completed, updating Summary tab with final data');
    // Trigger Summary tab update by calling refresh
    refresh();
  }
  
  // Add animations
  const victoryStyle = document.createElement('style');
  victoryStyle.textContent = 
    '@keyframes victoryPop {' +
    '  0% { transform: translate(-50%,-50%) scale(0.5) rotate(-10deg); opacity: 0; }' +
    '  50% { transform: translate(-50%,-50%) scale(1.1) rotate(5deg); opacity: 0.8; }' +
    '  100% { transform: translate(-50%,-50%) scale(1) rotate(0deg); opacity: 1; }' +
    '}' +
    '@keyframes trophyBounce {' +
    '  0% { transform: translateY(0px) scale(1); }' +
    '  50% { transform: translateY(-10px) scale(1.1); }' +
    '  100% { transform: translateY(0px) scale(1); }' +
    '}' +
    '@keyframes titleGlow {' +
    '  0% { text-shadow: 0 0 10px rgba(255,255,255,0.5); }' +
    '  100% { text-shadow: 0 0 20px rgba(255,255,255,0.8), 0 0 30px rgba(255,255,255,0.5); }' +
    '}' +
    '@keyframes winnerPulse {' +
    '  0% { transform: scale(1); color: #ffffff; }' +
    '  50% { transform: scale(1.05); color: #ffd700; }' +
    '  100% { transform: scale(1); color: #ffffff; }' +
    '}' +
    '@keyframes buttonGlow {' +
    '  0% { box-shadow: 0 0 5px rgba(255,255,255,0.5); }' +
    '  50% { box-shadow: 0 0 15px rgba(255,255,255,0.8), 0 0 25px rgba(255,255,255,0.5); }' +
    '  100% { box-shadow: 0 0 5px rgba(255,255,255,0.5); }' +
    '}';
  document.head.appendChild(victoryStyle);
}

function createVictoryConfetti() {
  console.log('DEBUG: Creating victory confetti effect');
  
  const colors = ['#FFD700', '#FF69B4', '#00CED1', '#FF6347', '#98FB98', '#DDA0DD', '#F0E68C'];
  const emojis = ['‚≠ê', '‚ú®', 'üåü', 'üí´', 'üéâ', 'üéä', 'üèÜ', 'üéØ'];
  
  for (let i = 0; i < 50; i++) {
    setTimeout(() => {
      const confetti = document.createElement('div');
      const isEmoji = Math.random() > 0.5;
      
      if (isEmoji) {
        confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        confetti.style.cssText = `
          position: fixed;
          top: -50px;
          left: ${Math.random() * 100}%;
          font-size: ${Math.random() * 20 + 15}px;
          z-index: 1999;
          animation: confettiFall ${Math.random() * 3 + 2}s linear forwards;
          pointer-events: none;
        `;
      } else {
        confetti.style.cssText = `
          position: fixed;
          top: -50px;
          left: ${Math.random() * 100}%;
          width: ${Math.random() * 10 + 5}px;
          height: ${Math.random() * 10 + 5}px;
          background: ${colors[Math.floor(Math.random() * colors.length)]};
          border-radius: 50%;
          z-index: 1999;
          animation: confettiFall ${Math.random() * 3 + 2}s linear forwards;
          pointer-events: none;
        `;
      }
      
      document.body.appendChild(confetti);
      
      // Remove confetti after animation
      setTimeout(() => {
        if (confetti.parentElement) {
          confetti.parentElement.removeChild(confetti);
        }
      }, 5000);
      
    }, i * 100); // Stagger the confetti creation
  }
  
  // Add confetti animation styles
  const confettiStyle = document.createElement('style');
  confettiStyle.textContent = 
    '@keyframes confettiFall {' +
    '  0% {' +
    '    transform: translateY(0) rotate(0deg);' +
    '    opacity: 1;' +
    '  }' +
    '  100% {' +
    '    transform: translateY(100vh) rotate(720deg);' +
    '    opacity: 0;' +
    '  }' +
    '}';
  document.head.appendChild(confettiStyle);
  
  console.log('DEBUG: Victory confetti effect created');
}

function showBoundaryPopup(runs) {
  console.log('DEBUG: showBoundaryPopup called with runs:', runs);
  
  const isFour = runs === 4;
  const emoji = isFour ? 'üèÉ‚Äç‚ôÇÔ∏è' : 'üöÄ';
  const bgColor = isFour ? 'linear-gradient(135deg,#28a745 0%,#20c997 100%)' : 'linear-gradient(135deg,#ffc107 0%,#ff6b6b 100%)';
  const message = isFour ? 'FOUR!' : 'SIX! AMAZING!';
  
  // Create 3D stars container
  const starsContainer = document.createElement('div');
  starsContainer.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1999;
  `;
  
  // Create multiple 3D stars
  for (let i = 0; i < 20; i++) {
    create3DStar(starsContainer, isFour);
  }
  
  const popup = document.createElement('div');
  popup.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:' + bgColor + ';color:white;padding:40px;border-radius:20px;z-index:2000;box-shadow:0 20px 40px rgba(0,0,0,0.3);text-align:center;min-width:400px;animation:boundaryPop 0.5s ease-out';
  
  popup.innerHTML = 
    '<div style="font-size:72px;margin-bottom:20px;animation:pulse 1s infinite">' + emoji + '</div>' +
    '<h2 style="margin:0 0 15px 0;font-size:48px;font-weight:bold;text-shadow:2px 2px 4px rgba(0,0,0,0.3)">' + message + '</h2>' +
    '<div style="font-size:36px;margin-bottom:10px;font-weight:bold;text-shadow:2px 2px 4px rgba(0,0,0,0.3)">' + runs + ' RUNS!</div>' +
    '<div style="font-size:18px;opacity:0.9;">Great shot! ' + (isFour ? 'Well placed!' : 'Huge hit!') + '</div>' +
    '<div style="font-size:14px;opacity:0.7;margin-top:10px;">üåü Spectator Celebration üåü</div>';
  
  console.log('DEBUG: Popup element created and styled');
  
  // Safely append popup and stars to body
  if (document.body) {
    document.body.appendChild(starsContainer);
    document.body.appendChild(popup);
    console.log('DEBUG: Popup and stars appended to body');
    
    // Add animations
    const boundaryStyle = document.createElement('style');
    boundaryStyle.textContent = 
      '@keyframes boundaryPop {' +
      '  0% { transform: translate(-50%,-50%) scale(0.3) rotate(-10deg); opacity: 0; }' +
      '  50% { transform: translate(-50%,-50%) scale(1.1) rotate(5deg); opacity: 1; }' +
      '  100% { transform: translate(-50%,-50%) scale(1) rotate(0deg); opacity: 1; }' +
      '}' +
      '@keyframes pulse {' +
      '  0%, 100% { transform: scale(1); }' +
      '  50% { transform: scale(1.1); }' +
      '}' +
      '@keyframes star3D {' +
      '  0% { transform: translate(-50%, -50%) rotateX(0deg) rotateY(0deg) scale(0); opacity: 0; }' +
      '  20% { transform: translate(-50%, -50%) rotateX(180deg) rotateY(360deg) scale(1.5); opacity: 1; }' +
      '  40% { transform: translate(-50%, -50%) rotateX(360deg) rotateY(720deg) scale(1); opacity: 1; }' +
      '  60% { transform: translate(-50%, -50%) rotateX(540deg) rotateY(1080deg) scale(0.8); opacity: 0.8; }' +
      '  80% { transform: translate(-50%, -50%) rotateX(720deg) rotateY(1440deg) scale(0.5); opacity: 0.5; }' +
      '  100% { transform: translate(-50%, -50%) rotateX(900deg) rotateY(1800deg) scale(0); opacity: 0; }' +
      '}';
    document.head.appendChild(boundaryStyle);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
      popup.style.animation = 'boundaryPop 0.3s ease-out reverse';
      setTimeout(() => {
        if (document.body.contains(popup)) {
          document.body.removeChild(popup);
          console.log('DEBUG: Boundary popup auto-removed');
        }
        if (document.body.contains(starsContainer)) {
          document.body.removeChild(starsContainer);
          console.log('DEBUG: Stars container auto-removed');
        }
      }, 300);
    }, 3000);
  } else {
    console.error('document.body is not available for boundary popup');
    return;
  }
}

function showWicketPopup(wicketType = 'bowled', bowlerName = '', catcherName = '') {
  // Determine emoji and message based on wicket type
  let emoji, message, subtext;
  
  switch(wicketType.toLowerCase()) {
    case 'bowled':
      emoji = 'üé≥';
      message = 'BOWLED HIM!';
      subtext = 'Clean bowled! Great delivery!';
      break;
    case 'caught':
      emoji = 'ü§ö';
      message = 'CAUGHT!';
      subtext = catcherName ? 'Great catch by ' + catcherName + '!' : 'Excellent catch in the field!';
      break;
    case 'lbw':
      emoji = '‚öñÔ∏è';
      message = 'LBW!';
      subtext = 'Umpire finger goes up!';
      break;
    case 'run-out':
      emoji = '‚ö°';
      message = 'RUN OUT!';
      subtext = 'Brilliant fielding! Quick thinking!';
      break;
    case 'stumped':
      emoji = 'ü•é';
      message = 'STUMPED!';
      subtext = 'Quick work behind the stumps!';
      break;
    case 'hit-wicket':
      emoji = 'üèè';
      message = 'HIT WICKET!';
      subtext = 'Unfortunate dismissal!';
      break;
    case 'retired':
      emoji = 'üëã';
      message = 'RETIRED!';
      subtext = 'Player chooses to retire!';
      break;
    case 'time-out':
      emoji = '‚è∞';
      message = 'TIME OUT!';
      subtext = 'Too much time taken!';
      break;
    case 'return-hurt':
      emoji = 'üè•';
      message = 'RETIRE HURT!';
      subtext = 'Player injured and leaves the field!';
      break;
    default:
      emoji = 'üíî';
      message = 'WICKET FALLEN!';
      subtext = "That is out!";
  }
  
  // Add bowler name if available
  if (bowlerName) {
    subtext += ' Bowler: ' + bowlerName;
  }
  
  const popup = document.createElement('div');
  popup.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#dc3545 0%,#6f42c1 100%);color:white;padding:40px;border-radius:20px;z-index:2000;box-shadow:0 20px 40px rgba(0,0,0,0.3);text-align:center;min-width:450px;animation:wicketPop 0.5s ease-out';
  
  popup.innerHTML = 
    '<div style="font-size:72px;margin-bottom:20px;">' + emoji + '</div>' +
    '<h2 style="margin:0 0 15px 0;font-size:42px;font-weight:bold;">' + message + '</h2>' +
    '<div style="font-size:20px;margin-bottom:10px;">That is out!</div>' +
    '<div style="font-size:18px;opacity:0.9;">' + subtext + '</div>';
  
  document.body.appendChild(popup);
  
  // Add animation
  const wicketStyle = document.createElement('style');
  wicketStyle.textContent = 
    '@keyframes wicketPop {' +
    '  0% { transform: translate(-50%,-50%) scale(0.3); opacity: 0; }' +
    '  50% { transform: translate(-50%,-50%) scale(1.05); opacity: 1; }' +
    '  100% { transform: translate(-50%,-50%) scale(1) rotate(-2deg); opacity: 1; }' +
    '}';
  document.head.appendChild(wicketStyle);
  
  // Auto-remove after 3.5 seconds
  setTimeout(() => {
    popup.style.animation = 'wicketPop 0.3s ease-out reverse';
    setTimeout(() => {
      if (document.body.contains(popup)) {
        document.body.removeChild(popup);
      }
    }, 300);
  }, 3500);
}

window.showTab = function(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tabContent').forEach(c => c.style.display = 'none');
  
  // Find the correct tab button by checking onclick attribute
  const tabButton = Array.from(document.querySelectorAll('.tab')).find(t => {
    const onclick = t.getAttribute('onclick');
    return onclick && onclick.includes(`'${tab}'`);
  });
  if (tabButton) tabButton.classList.add('active');
  
  const tabContent = document.getElementById(tab + 'Tab');
  if (tabContent) tabContent.style.display = 'block';
  
  // Special case for matchSettings
  if (tab === 'matchSettings') {
    const matchSettingsTab = document.getElementById('matchSettingsTab');
    if (matchSettingsTab) matchSettingsTab.style.setProperty('display', 'block', 'important');
  }
};

function createNewMatchFromInitial() {
  console.log('Creating new match from initial page...');

  // Create a new match via API
  api('/api/create_match', {match_name: 'Match ' + new Date().toISOString().slice(0, 19).replace(/:/g, '-')}).then(data => {
    console.log('New match created:', data);

    // Hide initial section and show main app
    document.getElementById('initialSection').style.display = 'none';
    document.getElementById('mainAppSection').style.display = 'block';

    // Update URL without page reload
    const newUrl = window.location.origin + '?match_id=' + data.match_id;
    window.history.pushState({}, '', newUrl);

    // Load the match
    loadMatch(data.match_id);

  }).catch(e => {
    console.error('Failed to create match:', e);
    showPopupAlert('Error', 'Failed to create match. Please try again.');
  });
}

function updateDownloadButton(st) {
  const downloadBtn = document.getElementById('downloadPDFBtn');
  if (!downloadBtn) return;
  
  if (!st.started) {
    // Match not started
    downloadBtn.disabled = true;
    downloadBtn.style.background = '#ccc';
    downloadBtn.style.color = '#666';
    downloadBtn.style.cursor = 'not-allowed';
    downloadBtn.textContent = 'üìÑ Download PDF (Match Not Started)';
  } else if (st.match_complete) {
    // Match completed - full data available
    downloadBtn.disabled = false;
    downloadBtn.style.background = '#01147C';
    downloadBtn.style.color = 'white';
    downloadBtn.style.cursor = 'pointer';
    downloadBtn.textContent = 'üìÑ Download PDF (Match Completed)';
  } else {
    // Match in progress - partial data available
    downloadBtn.disabled = false;
    downloadBtn.style.background = '#f39c12';
    downloadBtn.style.color = 'white';
    downloadBtn.style.cursor = 'pointer';
    downloadBtn.textContent = 'üìÑ Download PDF (Live Match)';
  }
}

function goToHome() {
  console.log('Going to home page...');

  // Hide main app and show initial section
  document.getElementById('mainAppSection').style.display = 'none';
  document.getElementById('initialSection').style.display = 'flex';

  // Update URL without page reload
  window.history.pushState({}, '', window.location.origin);
}

window.downloadScoreboardPDF = async function() {
  console.log('DEBUG: downloadScoreboardPDF called');
  
  try {
    // Show loading message
    const loadingDiv = document.createElement('div');
    loadingDiv.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #01147C;
      color: white;
      padding: 20px;
      border-radius: 8px;
      z-index: 1000;
      font-size: 16px;
    `;
    loadingDiv.textContent = 'Generating PDF... Please wait';
    document.body.appendChild(loadingDiv);
    
    // Call PDF generation API
    const response = await fetch('/api/generate-pdf', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({})
    });
    
    // Remove loading message
    document.body.removeChild(loadingDiv);
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'PDF generation failed');
    }
    
    // Get PDF blob and create download link
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    
    // Get filename from response headers or create default
    const contentDisposition = response.headers.get('content-disposition');
    let filename = 'cricket_scoreboard.pdf';
    if (contentDisposition) {
      const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
      if (filenameMatch) {
        filename = filenameMatch[1];
      }
    }
    
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    console.log('DEBUG: PDF downloaded successfully');
    
  } catch (error) {
    console.error('DEBUG: Error downloading PDF:', error);
    alert('Failed to generate PDF: ' + error.message);
  }
}

console.log('SCRIPT COMPLETED - TIMESTAMP:', new Date().toISOString());
</script>
</div>  <!-- Close mainAppSection -->
</body>
</html>
"""

# HTML content is now properly closed


def _json_response(handler: BaseHTTPRequestHandler, status: int, payload: dict):
    body = json.dumps(payload).encode("utf-8")
    handler.send_response(status)
    handler.send_header("Content-Type", "application/json; charset=utf-8")
    handler.send_header("Cache-Control", "no-store")
    handler.send_header("Pragma", "no-cache")
    handler.send_header("Content-Length", str(len(body)))
    handler.end_headers()
    handler.wfile.write(body)


def _html_response(handler: BaseHTTPRequestHandler, status: int, html: str):
    body = html.encode("utf-8")
    handler.send_response(status)
    handler.send_header("Content-Type", "text/html; charset=utf-8")
    handler.send_header("Cache-Control", "no-store")
    handler.send_header("Pragma", "no-cache")
    handler.send_header("Content-Security-Policy", "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';")
    handler.send_header("Content-Length", str(len(body)))
    handler.end_headers()
    handler.wfile.write(body)


def _role_from_str(role: str) -> PlayerRole:
    m = {
        "batsman": PlayerRole.BATSMAN,
        "bowler": PlayerRole.BOWLER,
        "all-rounder": PlayerRole.ALL_ROUNDER,
        "wicket-keeper": PlayerRole.WICKET_KEEPER,
    }
    return m.get((role or "batsman").strip().lower(), PlayerRole.BATSMAN)


def _ensure_team(match: MatchState, letter: str, team_name: str) -> Team:
    if letter == "A":
        if match.team_a is None:
            match.team_a = Team(team_name or "Team A")
        else:
            if team_name:
                match.team_a.team_name = team_name
        return match.team_a
    if letter == "B":
        if match.team_b is None:
            match.team_b = Team(team_name or "Team B")
        else:
            if team_name:
                match.team_b.team_name = team_name
        return match.team_b
    raise ValueError("Invalid team")


def _find_player_by_name(team: Team, name: str) -> Player | None:
    n = (name or "").strip().lower()
    for p in team.players:
        if p.name.strip().lower() == n:
            return p
    return None


class Handler(BaseHTTPRequestHandler):
    def do_GET(self):
        p = urlparse(self.path)
        if p.path == "/" or p.path == "/index.html":
            # Serve the main application HTML
            return _html_response(self, 200, INDEX_HTML)

        if p.path == "/api/state":
            match_id = get_match_id_from_request(self)
            current_match_data, actual_match_id = get_current_match(match_id)
            match = current_match_data["match"]
            
            team_a = match.team_a or Team("Team A")
            team_b = match.team_b or Team("Team B")
            payload = {
                "match_id": actual_match_id,
                "match_name": getattr(match, 'match_name', current_match_data.get("match_name", "Cricket Match")),
                "started": current_match_data["started"],
                "team_a_name": team_a.team_name,
                "team_b_name": team_b.team_name,
                "team_a_size": len(team_a.players),
                "team_b_size": len(team_b.players),
                "team_a_captain": team_a.get_captain().name if team_a.get_captain() else None,
                "team_b_captain": team_b.get_captain().name if team_b.get_captain() else None,
                "team_a_players": [{"id": x.id, "name": x.name, "role": x.role.value, "batting_runs": x.batting_stats.runs, "batting_balls": x.batting_stats.balls, "bowling_overs": x.bowling_stats.overs, "bowling_runs": x.bowling_stats.runs, "bowling_wickets": x.bowling_stats.wickets, "bowling_wides": x.bowling_stats.wides, "bowling_no_balls": x.bowling_stats.no_balls, "bowling_economy": x.bowling_stats.economy, "bowling_average": x.bowling_stats.get_average(), "dismissal": match.get_player_dismissal(x.id)} for x in team_a.players],
                "team_b_players": [{"id": x.id, "name": x.name, "role": x.role.value, "batting_runs": x.batting_stats.runs, "batting_balls": x.batting_stats.balls, "bowling_overs": x.bowling_stats.overs, "bowling_runs": x.bowling_stats.runs, "bowling_wickets": x.bowling_stats.wickets, "bowling_wides": x.bowling_stats.wides, "bowling_no_balls": x.bowling_stats.no_balls, "bowling_economy": x.bowling_stats.economy, "bowling_average": x.bowling_stats.get_average(), "dismissal": match.get_player_dismissal(x.id)} for x in team_b.players],
                "batting_first": match.batting_first_team_name,
                "summary": match.get_match_summary() if current_match_data["started"] else None,
                "batting_players": [{"id": x.id, "name": x.name, "role": x.role.value} for x in (match.batting_team.players if match.batting_team else [])],
                "bowling_players": [{"id": x.id, "name": x.name, "role": x.role.value, "bowling_overs": x.bowling_stats.overs, "bowling_runs": x.bowling_stats.runs, "bowling_wickets": x.bowling_stats.wickets, "bowling_wides": x.bowling_stats.wides, "bowling_no_balls": x.bowling_stats.no_balls, "bowling_economy": x.bowling_stats.economy, "bowling_average": x.bowling_stats.get_average()} for x in (match.bowling_team.players if match.bowling_team else [])],
                "next_batsmen": [{"id": x.id, "name": x.name, "role": x.role.value} for x in (match.batting_team.get_players_not_batted() if match.batting_team else [])],
                "striker_runs": match.striker.batting_stats.runs if match.striker else 0,
                "striker_balls": match.striker.batting_stats.balls if match.striker else 0,
                "non_striker_runs": match.non_striker.batting_stats.runs if match.non_striker else 0,
                "non_striker_balls": match.non_striker.batting_stats.balls if match.non_striker else 0,
                "ball_by_ball": match.get_ball_by_ball(),
                "innings_complete": match.is_innings_complete() if current_match_data["started"] else False,
                "match_complete": match.is_match_complete() if current_match_data["started"] else False,
                "striker": match.striker.name if match.striker else None,
                "non_striker": match.non_striker.name if match.non_striker else None,
                "bowler": match.current_bowler.name if match.current_bowler else None,
                "match_winner": match.get_match_winner() if current_match_data["started"] else None,
                "player_of_match": current_match_data.get("player_of_match"),
                "target": None,
                "match_result": match.get_match_result() if current_match_data["started"] else None,
                "top_batsmen_a": [{"name": p.name, "batting_runs": p.batting_stats.runs} for p in (match.team_a.get_top_batsmen(5) if match.team_a else [])],
                "top_bowlers_a": [{"name": p.name, "bowling_wickets": p.bowling_stats.wickets} for p in (match.team_a.get_top_bowlers(5) if match.team_a else [])],
                "top_batsmen_b": [{"name": p.name, "batting_runs": p.batting_stats.runs} for p in (match.team_b.get_top_batsmen(5) if match.team_b else [])],
                "top_bowlers_b": [{"name": p.name, "bowling_wickets": p.bowling_stats.wickets} for p in (match.team_b.get_top_bowlers(5) if match.team_b else [])]
            }
            if current_match_data["started"] and match.current_innings == 2 and match.first_innings_summary:
                payload["target"] = {
                    "runs": match.first_innings_summary["runs"] + 1,
                    "overs": match.first_innings_summary["max_overs"] or 0
                }
            return _json_response(self, 200, payload)

        if p.path == "/api/matches":
            # Get all matches list
            return _json_response(self, 200, {"matches": get_all_matches()})

        if p.path == "/api/create_match":
            # Create a new match
            query_params = parse_qs(p.query)
            match_name = query_params.get('match_name', [None])[0]
            match_id = create_new_match(match_name)
            return _json_response(self, 200, {"match_id": match_id, "match_name": STATE["matches"][match_id]["match_name"]})

        self.send_response(404)
        self.end_headers()

    def do_POST(self):
        p = urlparse(self.path)
        try:
            length = int(self.headers.get("Content-Length") or "0")
            raw = self.rfile.read(length) if length > 0 else b"{}"
            data = json.loads(raw.decode("utf-8")) if raw else {}

            if p.path == "/api/reset":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                
                current_match_data["match"] = MatchState()
                current_match_data["started"] = False
                update_match_timestamp(actual_match_id)
                return _json_response(self, 200, {"ok": True, "match_id": actual_match_id})

            if p.path == "/api/reset_match_only":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                
                # Reset only match state, keep teams and players
                match = current_match_data["match"]
                if match.team_a and match.team_b:
                    # Preserve teams and players
                    team_a = match.team_a
                    team_b = match.team_b
                    
                    # Create new match state
                    new_match = MatchState()
                    new_match.team_a = team_a
                    new_match.team_b = team_b
                    new_match.max_overs = match.max_overs
                    new_match.batting_first_team_name = match.batting_first_team_name
                    
                    # Reset player stats but keep players
                    for player in team_a.players:
                        player.batting_stats = BattingStats()
                        player.bowling_stats = BowlingStats()
                    for player in team_b.players:
                        player.batting_stats = BattingStats()
                        player.bowling_stats = BowlingStats()
                    
                    current_match_data["match"] = new_match
                    current_match_data["started"] = False
                    update_match_timestamp(actual_match_id)
                return _json_response(self, 200, {"ok": True, "match_id": actual_match_id})

            if p.path == "/api/restore_teams":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                
                # Restore team names and players after complete reset
                match = current_match_data["match"]
                team_a_name = data.get("team_a_name", "Team A")
                team_b_name = data.get("team_b_name", "Team B")
                team_a_players = data.get("team_a_players", [])
                team_b_players = data.get("team_b_players", [])
                
                # Create teams
                team_a = Team(team_a_name)
                team_b = Team(team_b_name)
                
                # Add players to teams
                for player_data in team_a_players:
                    player = Player(
                        id=player_data["id"],
                        name=player_data["name"],
                        role=_role_from_str(player_data["role"])
                    )
                    team_a.add_player(player)
                
                for player_data in team_b_players:
                    player = Player(
                        id=player_data["id"],
                        name=player_data["name"],
                        role=_role_from_str(player_data["role"])
                    )
                    team_b.add_player(player)
                
                # Set teams in match
                match.team_a = team_a
                match.team_b = team_b
                
                update_match_timestamp(actual_match_id)
                return _json_response(self, 200, {"ok": True})

            if p.path == "/api/add_player":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                match = current_match_data["match"]
                
                team = data.get("team")
                name = data.get("name", "").strip()
                role = data.get("role", "batsman")
                team_name = data.get("team_name", "")
                make_captain = data.get("make_captain", False)
                
                if not name:
                    return _json_response(self, 400, {"error": "Player name required"})
                
                team_obj = _ensure_team(match, team, team_name)
                
                # Check for duplicate player name
                existing_player = _find_player_by_name(team_obj, name)
                if existing_player:
                    return _json_response(self, 400, {"error": f"Player '{name}' already exists in {team_name}"})
                
                player_id = str(uuid.uuid4())
                player = Player(id=player_id, name=name, role=_role_from_str(role))
                team_obj.add_player(player)
                
                # Set as captain if requested
                if make_captain:
                    team_obj.set_captain(player_id)
                
                update_match_timestamp(actual_match_id)
                return _json_response(self, 200, {"ok": True})

            if p.path == "/api/start":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                
                match = current_match_data["match"]
                team_a_name = (data.get("team_a_name") or "").strip() or "Team A"
                team_b_name = (data.get("team_b_name") or "").strip() or "Team B"
                match_name = (data.get("match_name") or "").strip()
                overs = int(data.get("overs") or 0)
                players_per_team = int(data.get("players_per_team") or 11)
                batting_first = (data.get("batting_first") or "").strip()

                if match.team_a is None or match.team_b is None:
                    return _json_response(self, 400, {"error": "Please add both teams and players first"})
                match.team_a.team_name = team_a_name
                match.team_b.team_name = team_b_name
                
                # Set match name
                if match_name:
                    match.match_name = match_name
                else:
                    # Auto-generate match name if not provided
                    now = datetime.now()
                    date_str = now.strftime("%b %d")
                    time_str = now.strftime("%H:%M")
                    match.match_name = f"{team_a_name} vs {team_b_name} - {date_str} {time_str}"

                if len(match.team_a.players) < 2 or len(match.team_b.players) < 2:
                    return _json_response(self, 400, {"error": "Each team must have at least 2 players"})
                if len(match.team_a.players) > players_per_team or len(match.team_b.players) > players_per_team:
                    return _json_response(self, 400, {"error": f"Each team cannot have more than {players_per_team} players"})
                if overs <= 0:
                    return _json_response(self, 400, {"error": "Overs must be a positive integer"})
                if batting_first not in [team_a_name, team_b_name]:
                    return _json_response(self, 400, {"error": "Select batting first team"})

                match.max_overs = overs
                match.batting_first_team_name = batting_first

                if batting_first == team_a_name:
                    match.batting_team = match.team_a
                    match.bowling_team = match.team_b
                else:
                    match.batting_team = match.team_b
                    match.bowling_team = match.team_a

                current_match_data["started"] = True
                update_match_timestamp(actual_match_id)
                return _json_response(self, 200, {"ok": True})

            if p.path == "/api/set_openers":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                match = current_match_data["match"]
                
                if not current_match_data["started"] or not match.batting_team:
                    return _json_response(self, 400, {"error": "Match not started"})
                s = data.get("striker")
                ns = data.get("non_striker")
                sp = _find_player_by_name(match.batting_team, s)
                nsp = _find_player_by_name(match.batting_team, ns)
                if not sp or not nsp or sp.id == nsp.id:
                    return _json_response(self, 400, {"error": "Invalid openers"})
                match.striker = sp
                match.non_striker = nsp
                for pid in [sp.id, nsp.id]:
                    if pid not in match.batting_team.batting_order:
                        match.batting_team.batting_order.append(pid)
                update_match_timestamp(actual_match_id)
                return _json_response(self, 200, {"ok": True})

            if p.path == "/api/set_bowler":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                match = current_match_data["match"]
                
                if not current_match_data["started"] or not match.bowling_team:
                    return _json_response(self, 400, {"error": "Match not started"})
                b = data.get("bowler")
                bp = _find_player_by_name(match.bowling_team, b)
                if not bp:
                    return _json_response(self, 400, {"error": "Invalid bowler"})
                match.current_bowler = bp
                if bp.id not in match.bowling_team.bowling_order:
                    match.bowling_team.bowling_order.append(bp.id)
                update_match_timestamp(actual_match_id)
                return _json_response(self, 200, {"ok": True})

            if p.path == "/api/change_strike":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                match = current_match_data["match"]
                
                match.striker, match.non_striker = match.non_striker, match.striker
                update_match_timestamp(actual_match_id)
                return _json_response(self, 200, {"ok": True})

            if p.path == "/api/score":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                match = current_match_data["match"]
                
                if not match.striker or not match.current_bowler:
                    return _json_response(self, 400, {"error": "Set openers and bowler first"})
                runs = int(data.get("runs") or 0)

                match.striker.batting_stats.runs += runs
                match.striker.batting_stats.balls += 1
                match.striker.batting_stats.update_strike_rate()

                match.current_bowler.bowling_stats.runs += runs
                match.current_bowler.bowling_stats.overs += 1 / 6
                match.current_bowler.bowling_stats.update_economy()

                match.total_runs += runs

                # Store the batsman who actually faced the ball before strike change
                batsman_who_faced = match.striker
                
                if runs % 2 == 1:
                    match.striker, match.non_striker = match.non_striker, match.striker

                # Create ball event with comment
                comment = f"{runs} run{'s' if runs != 1 else ''}"
                if runs == 4:
                    comment = "FOUR!"
                elif runs == 6:
                    comment = "SIX!"
                
                event = BallEvent(
                    ball_number=match.current_ball + 1,
                    over_number=match.current_over,
                    runs=runs,
                    batsman_id=batsman_who_faced.id,
                    bowler_id=match.current_bowler.id,
                    description=f"{runs} runs",
                    comment=comment
                )
                match.add_event(event)

                match.current_ball += 1
                over_complete = False
                if match.current_ball >= 6:
                    match.current_ball = 0
                    match.current_over += 1
                    match.striker, match.non_striker = match.non_striker, match.striker
                    over_complete = True

                update_match_timestamp(actual_match_id)
                return _json_response(self, 200, {"ok": True, "over_complete": over_complete})

            if p.path == "/api/extra":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                match = current_match_data["match"]
                
                t = data.get("type")
                runs = data.get("runs", 0)
                comment = t.upper().replace('-', ' ').title()
                
                if t in ["wide", "no-ball"]:
                    match.total_runs += 1
                    if match.current_bowler:
                        match.current_bowler.bowling_stats.runs += 1
                    # Create ball event
                    event = BallEvent(
                        ball_number=match.current_ball,
                        over_number=match.current_over,
                        runs=1,
                        batsman_id=match.striker.id if match.striker else None,
                        bowler_id=match.current_bowler.id if match.current_bowler else None,
                        extra_type=t,
                        description=t,
                        comment=comment
                    )
                    match.add_event(event)
                elif t in ["bye", "leg-bye"]:
                    match.total_runs += runs
                    # Create ball event
                    event = BallEvent(
                        ball_number=match.current_ball + 1,
                        over_number=match.current_over,
                        runs=runs,
                        batsman_id=match.striker.id if match.striker else None,
                        bowler_id=match.current_bowler.id if match.current_bowler else None,
                        extra_type=t,
                        description=t,
                        comment=f"{comment} {runs} run{'s' if runs != 1 else ''}"
                    )
                    match.add_event(event)
                    match.current_ball += 1
                    if match.current_ball >= 6:
                        match.current_ball = 0
                        match.current_over += 1
                        match.striker, match.non_striker = match.non_striker, match.striker
                else:
                    # dead-ball, free-hit, one-bounce (no runs, just record)
                    event = BallEvent(
                        ball_number=match.current_ball,
                        over_number=match.current_over,
                        runs=0,
                        batsman_id=match.striker.id if match.striker else None,
                        bowler_id=match.current_bowler.id if match.current_bowler else None,
                        extra_type=t,
                        description=t,
                        comment=comment
                    )
                    match.add_event(event)
                
                update_match_timestamp(actual_match_id)
                return _json_response(self, 200, {"ok": True})

            if p.path == "/api/wicket":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                match = current_match_data["match"]
                
                if not match.striker or not match.current_bowler:
                    return _json_response(self, 400, {"error": "Set openers and bowler first"})
                
                wicket_type = data.get("type", "bowled")
                catcher_name = data.get("catcher")
                runout_by = data.get("runout_by", [])
                
                match.wickets += 1
                match.current_bowler.bowling_stats.wickets += 1
                match.striker.batting_stats.balls += 1
                match.striker.batting_stats.update_strike_rate()
                
                # Find catcher and runout players
                catcher_id = None
                if catcher_name:
                    catcher = _find_player_by_name(match.bowling_team, catcher_name)
                    if catcher:
                        catcher_id = catcher.id
                
                runout_ids = []
                if runout_by:
                    for player_name in runout_by:
                        player = _find_player_by_name(match.bowling_team, player_name)
                        if player:
                            runout_ids.append(player.id)
                
                # Create ball event for wicket
                try:
                    wicket_enum = WicketType[wicket_type.upper().replace('-', '_')]
                except KeyError:
                    wicket_enum = WicketType.BOWLED  # Default fallback
                
                event = BallEvent(
                    ball_number=match.current_ball + 1,
                    over_number=match.current_over,
                    runs=0,
                    is_wicket=True,
                    wicket_type=wicket_enum,
                    batsman_id=match.striker.id,
                    bowler_id=match.current_bowler.id,
                    catcher_id=catcher_id,
                    runout_by=runout_ids,
                    description="Wicket",
                    comment=f"WICKET! {wicket_type.replace('-', ' ').title()}"
                )
                match.add_event(event)
                
                match.current_ball += 1
                over_complete = False
                if match.current_ball >= 6:
                    match.current_ball = 0
                    match.current_over += 1
                    # Switch strike at end of over
                    match.striker, match.non_striker = match.non_striker, match.striker
                    over_complete = True
                
                return _json_response(self, 200, {"ok": True, "over_complete": over_complete})

            if p.path == "/api/next_batsman":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                match = current_match_data["match"]
                
                if not match.batting_team:
                    return _json_response(self, 400, {"error": "Match not started"})
                name = (data.get("name") or "").strip()
                if not name:
                    return _json_response(self, 400, {"error": "Name required"})
                p2 = _find_player_by_name(match.batting_team, name)
                if not p2:
                    p2 = Player(id=str(uuid.uuid4()), name=name, role=PlayerRole.UNKNOWN)
                    match.batting_team.add_player(p2)
                match.striker = p2
                if p2.id not in match.batting_team.batting_order:
                    match.batting_team.batting_order.append(p2.id)
                update_match_timestamp(actual_match_id)
                return _json_response(self, 200, {"ok": True})

            if p.path == "/api/add_player_live":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                match = current_match_data["match"]
                
                which = data.get("which")
                name = (data.get("name") or "").strip()
                role = data.get("role")
                
                if not name:
                    return _json_response(self, 400, {"error": "Name required"})
                
                if which == "batting":
                    team = match.batting_team
                else:
                    team = match.bowling_team
                
                if not team:
                    return _json_response(self, 400, {"error": "Match not started"})
                
                # Check for duplicate player name
                existing_player = _find_player_by_name(team, name)
                if existing_player:
                    return _json_response(self, 400, {"error": f"Player '{name}' already exists in {team.team_name}"})
                
                # Get players per team limit (default 11)
                players_per_team = 11
                
                # Check if team already has maximum players
                if len(team.players) >= players_per_team:
                    return _json_response(self, 400, {"error": f"Team already has maximum {players_per_team} players"})
                
                p2 = Player(id=str(uuid.uuid4()), name=name, role=_role_from_str(role))
                team.add_player(p2)
                update_match_timestamp(actual_match_id)
                return _json_response(self, 200, {"ok": True})

            if p.path == "/api/switch_innings":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                match = current_match_data["match"]
                
                if not match.is_innings_complete():
                    # Add debug info to help understand why innings is not complete
                    debug_info = {
                        "current_over": match.current_over,
                        "current_ball": match.current_ball,
                        "max_overs": match.max_overs,
                        "wickets": match.wickets,
                        "batting_team_players": len(match.batting_team.players) if match.batting_team else 0,
                        "batting_order_length": len(match.batting_team.batting_order) if match.batting_team else 0,
                        "total_runs": match.total_runs,
                        "first_innings_summary": match.first_innings_summary is not None
                    }
                    return _json_response(self, 400, {"error": "Innings not complete yet", "debug": debug_info})
                match.switch_innings()
                update_match_timestamp(actual_match_id)
                return _json_response(self, 200, {"ok": True})

            if p.path == "/api/remove-player":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                match = current_match_data["match"]
                
                team = data.get("team")
                player_id = data.get("player_id")
                
                if not team or not player_id:
                    return _json_response(self, 400, {"error": "Team and player_id required"})
                
                team_obj = match.team_a if team == "team_a" else match.team_b
                if not team_obj:
                    return _json_response(self, 400, {"error": "Invalid team"})
                
                # Find and remove player
                player_to_remove = None
                for i, player in enumerate(team_obj.players):
                    if player.id == player_id:
                        player_to_remove = player
                        team_obj.players.pop(i)
                        break
                
                if not player_to_remove:
                    return _json_response(self, 404, {"error": "Player not found"})
                
                # Clear captain if removed player was captain
                if team_obj.captain_id == player_id:
                    team_obj.captain_id = None
                
                update_match_timestamp(actual_match_id)
                return _json_response(self, 200, {"ok": True})

            if p.path == "/api/edit-player":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                match = current_match_data["match"]
                
                team = data.get("team")
                player_id = data.get("player_id")
                name = data.get("name", "").strip()
                role = data.get("role", "batsman")
                
                if not team or not player_id or not name:
                    return _json_response(self, 400, {"error": "Team, player_id, and name required"})
                
                team_obj = match.team_a if team == "team_a" else match.team_b
                if not team_obj:
                    return _json_response(self, 400, {"error": "Invalid team"})
                
                # Find and update player
                player_to_edit = None
                for player in team_obj.players:
                    if player.id == player_id:
                        player_to_edit = player
                        player.name = name
                        player.role = _role_from_str(role)
                        break
                
                if not player_to_edit:
                    return _json_response(self, 404, {"error": "Player not found"})
                
                update_match_timestamp(actual_match_id)
                return _json_response(self, 200, {"ok": True})

            if p.path == "/api/set-player-of-match":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                
                player_id = data.get("player_id")
                player_name = data.get("player_name")
                team = data.get("team")
                
                if not player_id or not player_name:
                    return _json_response(self, 400, {"error": "Player ID and name required"})
                
                # Store player of the match in match data
                current_match_data["player_of_match"] = {
                    "id": player_id,
                    "name": player_name,
                    "team": team
                }
                
                # Also store in match object if it has the attribute
                match = current_match_data["match"]
                if hasattr(match, 'player_of_match'):
                    match.player_of_match = {
                        "id": player_id,
                        "name": player_name,
                        "team": team
                    }
                
                update_match_timestamp(actual_match_id)
                return _json_response(self, 200, {"ok": True, "player_of_match": current_match_data["player_of_match"]})

            if p.path == "/api/generate-pdf":
                match_id = get_match_id_from_request(self)
                current_match_data, actual_match_id = get_current_match(match_id)
                
                try:
                    # Generate PDF with complete match data
                    match = current_match_data["match"]
                    match_data = {
                        'match': match,
                        'match_winner': match.get_match_winner() if current_match_data["started"] else None,
                        'player_of_match': current_match_data.get("player_of_match"),
                        'match_name': getattr(match, 'match_name', current_match_data.get("match_name", "Cricket Match")),
                        'bowling_players': [
                            {"id": x.id, "name": x.name, "role": x.role.value, "bowling_overs": x.bowling_stats.overs, "bowling_runs": x.bowling_stats.runs, "bowling_wickets": x.bowling_stats.wickets, "bowling_wides": x.bowling_stats.wides, "bowling_no_balls": x.bowling_stats.no_balls, "bowling_economy": x.bowling_stats.economy, "bowling_average": x.bowling_stats.get_average()} 
                            for x in (match.bowling_team.players if match.bowling_team else [])
                        ],
                        'top_batsmen_a': [{"name": p.name, "batting_runs": p.batting_stats.runs} for p in (match.team_a.get_top_batsmen(5) if match.team_a else [])],
                        'top_batsmen_b': [{"name": p.name, "batting_runs": p.batting_stats.runs} for p in (match.team_b.get_top_batsmen(5) if match.team_b else [])],
                        'top_bowlers_a': [{"name": p.name, "bowling_wickets": p.bowling_stats.wickets} for p in (match.team_a.get_top_bowlers(5) if match.team_a else [])],
                        'top_bowlers_b': [{"name": p.name, "bowling_wickets": p.bowling_stats.wickets} for p in (match.team_b.get_top_bowlers(5) if match.team_b else [])]
                    }
                    pdf_path = generate_scoreboard_pdf(match_data)
                    
                    # Read PDF file
                    with open(pdf_path, 'rb') as f:
                        pdf_content = f.read()
                    
                    # Clean up temporary file
                    os.unlink(pdf_path)
                    
                    # Send PDF response
                    filename = f"cricket_scoreboard_{datetime.now().strftime('%Y%m%d_%H%M%S')}.pdf"
                    self.send_response(200)
                    self.send_header('Content-Type', 'application/pdf')
                    self.send_header('Content-Disposition', f'attachment; filename="{filename}"')
                    self.send_header('Content-Length', str(len(pdf_content)))
                    self.end_headers()
                    self.wfile.write(pdf_content)
                    
                except Exception as e:
                    return _json_response(self, 500, {"error": f"PDF generation failed: {str(e)}"})

            if p.path == "/api/create_match":
                # Create a new match via POST
                match_name = data.get("match_name", None)
                match_id = create_new_match(match_name)
                return _json_response(self, 200, {"match_id": match_id, "match_name": STATE["matches"][match_id]["match_name"]})

            # Serve static files (SVG, CSS, JS, PNG)
            if p.path == "/test-qr":
                self.send_response(200)
                self.send_header('Content-Type', 'text/plain')
                self.end_headers()
                self.wfile.write(b"QR route works!")
                return
            if p.path == "/favicon.ico":
                self.send_response(204)  # No content
                self.end_headers()
                return
            if p.path == "/CricSmart_logo.png":
                try:
                    with open("CricSmart_logo.png", 'rb') as f:
                        content = f.read()
                    self.send_response(200)
                    self.send_header('Content-Type', 'image/png')
                    self.send_header('Content-Length', str(len(content)))
                    self.end_headers()
                    self.wfile.write(content)
                    return
                except Exception as e:
                    return _json_response(self, 500, {"error": f"Failed to serve PNG: {str(e)}"})
            if p.path.endswith('.svg'):
                return _serve_static_file(self, p.path, 'image/svg+xml')
            if p.path.startswith('/static/') and p.path.endswith('.png'):
                return _serve_static_file(self, p.path, 'image/png')
            if p.path.endswith('.png'):
                return _serve_static_file(self, p.path, 'image/png')
            if p.path.endswith('.css'):
                return _serve_static_file(self, p.path, 'text/css')
            if p.path.endswith('.js'):
                return _serve_static_file(self, p.path, 'application/javascript')

            return _json_response(self, 404, {"error": "Unknown endpoint"})

        except Exception as e:
            return _json_response(self, 500, {"error": str(e)})


def _serve_static_file(handler, path, content_type):
    """Serve static files like SVG, CSS, JS, PNG"""
    try:
        # Remove leading slash if present
        file_path = path.lstrip('/')
        
        # Security check - only allow specific file types and paths
        allowed_extensions = ['.svg', '.css', '.js', '.png']
        if not any(file_path.endswith(ext) for ext in allowed_extensions):
            return _json_response(handler, 403, {"error": "File type not allowed"})
        
        # Security check - prevent directory traversal
        if '..' in file_path or file_path.startswith('/'):
            return _json_response(handler, 403, {"error": "Invalid file path"})
        
        # Try to read the file
        with open(file_path, 'rb') as f:
            content = f.read()
        
        handler.send_response(200)
        handler.send_header('Content-Type', content_type)
        handler.send_header('Content-Length', str(len(content)))
        handler.send_header('Cache-Control', 'public, max-age=3600')  # Cache for 1 hour
        handler.end_headers()
        handler.wfile.write(content)
        
    except FileNotFoundError:
        return _json_response(handler, 404, {"error": "File not found"})
    except Exception as e:
        return _json_response(handler, 500, {"error": f"Server error: {str(e)}"})


def main():
    server = HTTPServer(('localhost', 8080), Handler)
    print("CricSmart server running on http://localhost:8080")
    server.serve_forever()


if __name__ == "__main__":
    main()
